<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.jpeg"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.ico"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.ico"><link rel="mask-icon" href="/images/avatar.jpeg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous"><link rel="stylesheet" href="https://unpkg.com/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"yuerer.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"hide","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/config.min.js"></script><meta name="description" content="本文以 UE5.4 为基准，剖析蓝图编译的全流程。在阅读本文之前，需要比较熟悉蓝图，比较熟悉反射，同时最好先阅读 蓝图编译器概述。 简介UE5 的蓝图编译总共分为16个阶段，可简单分类为收集、过滤、验证、兼容、构建骨架、构建语句、生成字节码，重新链接这几个阶段。 12345678910111213141516STAGE I: GATHERSTAGE II: FILTERSTAGE III: SOR"><meta property="og:type" content="article"><meta property="og:title" content="UE5 蓝图编译流程剖析"><meta property="og:url" content="https://yuerer.com/UE5%20%E8%93%9D%E5%9B%BE%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B%E5%89%96%E6%9E%90/index.html"><meta property="og:site_name" content="Yuerer&#39;s Blog"><meta property="og:description" content="本文以 UE5.4 为基准，剖析蓝图编译的全流程。在阅读本文之前，需要比较熟悉蓝图，比较熟悉反射，同时最好先阅读 蓝图编译器概述。 简介UE5 的蓝图编译总共分为16个阶段，可简单分类为收集、过滤、验证、兼容、构建骨架、构建语句、生成字节码，重新链接这几个阶段。 12345678910111213141516STAGE I: GATHERSTAGE II: FILTERSTAGE III: SOR"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://yuerer.com/images/UE5_blueprint_compile.png"><meta property="article:published_time" content="2025-02-02T14:46:20.000Z"><meta property="article:modified_time" content="2025-10-21T13:50:52.265Z"><meta property="article:author" content="Yuerer"><meta property="article:tag" content="UE5"><meta property="article:tag" content="蓝图编译"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://yuerer.com/images/UE5_blueprint_compile.png"><link rel="canonical" href="https://yuerer.com/UE5%20%E8%93%9D%E5%9B%BE%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B%E5%89%96%E6%9E%90/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://yuerer.com/UE5%20%E8%93%9D%E5%9B%BE%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B%E5%89%96%E6%9E%90/","path":"UE5 蓝图编译流程剖析/","title":"UE5 蓝图编译流程剖析"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>UE5 蓝图编译流程剖析 | Yuerer's Blog</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-129491388-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-129491388-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/third-party/analytics/google-analytics.min.js"></script><link rel="dns-prefetch" href="https://yuerer-comment-xufei-0bea01e6f05-1307930306.ap-shanghai.app.tcloudbase.com"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Yuerer's Blog</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">钰儿的Blog</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STAGE-I-GATHER"><span class="nav-text">STAGE I: GATHER</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STAGE-II-FILTER"><span class="nav-text">STAGE II: FILTER</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STAGE-III-SORT"><span class="nav-text">STAGE III: SORT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STAGE-IV-SET-TEMPORARY-BLUEPRINT-FLAGS"><span class="nav-text">STAGE IV: SET TEMPORARY BLUEPRINT FLAGS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STAGE-V-VALIDATE"><span class="nav-text">STAGE V: VALIDATE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STAGE-VI-PURGE-LOAD-ONLY"><span class="nav-text">STAGE VI: PURGE (LOAD ONLY)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STAGE-VII-DISCARD-SKELETON-CDO"><span class="nav-text">STAGE VII: DISCARD SKELETON CDO</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STAGE-VIII-recompile-skeleton"><span class="nav-text">STAGE VIII: recompile skeleton</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STAGE-IX-RECONSTRUCT-NODES-REPLACE-DEPRECATED-NODES-LOAD-ONLY"><span class="nav-text">STAGE IX: RECONSTRUCT NODES, REPLACE DEPRECATED NODES (LOAD ONLY)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STAGE-X-CREATE-REINSTANCER-DISCARD-%E2%80%98OLD%E2%80%99-CLASS"><span class="nav-text">STAGE X: CREATE REINSTANCER (DISCARD ‘OLD’ CLASS)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STAGE-XI-CREATE-UPDATED-CLASS-HIERARCHY"><span class="nav-text">STAGE XI: CREATE UPDATED CLASS HIERARCHY</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STAGE-XII-COMPILE-CLASS-LAYOUT"><span class="nav-text">STAGE XII: COMPILE CLASS LAYOUT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STAGE-XIII-COMPILE-CLASS-FUNCTIONS"><span class="nav-text">STAGE XIII: COMPILE CLASS FUNCTIONS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STAGE-XIV-REINSTANCE"><span class="nav-text">STAGE XIV: REINSTANCE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STAGE-XV-POST-CDO-COMPILED"><span class="nav-text">STAGE XV: POST CDO COMPILED</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STAGE-XVI-CLEAR-TEMPORARY-FLAGS"><span class="nav-text">STAGE XVI: CLEAR TEMPORARY FLAGS</span></a></li></ol><li class="nav-item nav-level-1"><a class="nav-link" href="#FlushReinstancingQueueImpl"><span class="nav-text">FlushReinstancingQueueImpl</span></a></li></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Yuerer" src="/images/avatar.jpeg"><p class="site-author-name" itemprop="name">Yuerer</p><div class="site-description" itemprop="description">钰儿的Blog</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">65</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">90</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Yu2erer" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Yu2erer" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:yu2erer#gmail.com" title="E-Mail → mailto:yu2erer#gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://yuerer.com/UE5%20%E8%93%9D%E5%9B%BE%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B%E5%89%96%E6%9E%90/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpeg"><meta itemprop="name" content="Yuerer"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Yuerer's Blog"><meta itemprop="description" content="钰儿的Blog"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="UE5 蓝图编译流程剖析 | Yuerer's Blog"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">UE5 蓝图编译流程剖析</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2025-02-02 22:46:20" itemprop="dateCreated datePublished" datetime="2025-02-02T22:46:20+08:00">2025-02-02</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/UE/" itemprop="url" rel="index"><span itemprop="name">UE</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Waline：</span> <a title="waline" href="/UE5%20%E8%93%9D%E5%9B%BE%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B%E5%89%96%E6%9E%90/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/UE5%20%E8%93%9D%E5%9B%BE%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B%E5%89%96%E6%9E%90/" itemprop="commentCount"></span> </a></span><span class="post-meta-item" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="waline-pageview-count" data-path="/UE5%20%E8%93%9D%E5%9B%BE%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B%E5%89%96%E6%9E%90/"></span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>本文以 UE5.4 为基准，剖析蓝图编译的全流程。在阅读本文之前，需要比较熟悉蓝图，比较熟悉反射，同时最好先阅读 <a target="_blank" rel="noopener" href="https://dev.epicgames.com/documentation/zh-cn/unreal-engine/compiler-overview-for-blueprints-visual-scripting-in-unreal-engine">蓝图编译器概述</a>。</p><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>UE5 的蓝图编译总共分为16个阶段，可简单分类为收集、过滤、验证、兼容、构建骨架、构建语句、生成字节码，重新链接这几个阶段。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">STAGE I: GATHER</span><br><span class="line">STAGE II: FILTER</span><br><span class="line">STAGE III: SORT</span><br><span class="line">STAGE IV: SET TEMPORARY BLUEPRINT FLAGS</span><br><span class="line">STAGE V: VALIDATE</span><br><span class="line">STAGE VI: <span class="built_in">PURGE</span> (LOAD ONLY)</span><br><span class="line">STAGE VII: DISCARD SKELETON CDO</span><br><span class="line">STAGE VIII: RECOMPILE SKELETON</span><br><span class="line">STAGE IX: RECONSTRUCT NODES, <span class="function">REPLACE DEPRECATED <span class="title">NODES</span> <span class="params">(LOAD ONLY)</span></span></span><br><span class="line"><span class="function">STAGE X: CREATE REINSTANCER (DISCARD <span class="string">&#x27;OLD&#x27;</span> CLASS)</span></span><br><span class="line"><span class="function">STAGE XI: CREATE UPDATED CLASS HIERARCHY</span></span><br><span class="line"><span class="function">STAGE XII: COMPILE CLASS LAYOUT</span></span><br><span class="line"><span class="function">STAGE XIII: COMPILE CLASS FUNCTIONS</span></span><br><span class="line"><span class="function">STAGE XIV: REINSTANCE</span></span><br><span class="line"><span class="function">STAGE XV: POST CDO COMPILED </span></span><br><span class="line"><span class="function">STAGE XVI: CLEAR TEMPORARY FLAGS</span></span><br></pre></td></tr></table></figure><p>下面将从蓝图编辑器按下编译按钮时进行剖析，在每个阶段遇到新的概念时会进行讲解。</p><p>当按下蓝图的编译按钮时，将会执行到 <code>FBlueprintEditor::Compile()</code> 。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">FBlueprintEditor::Compile</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UBlueprint* BlueprintObj = <span class="built_in">GetBlueprintObj</span>();</span><br><span class="line">    FKismetEditorUtilities::<span class="built_in">CompileBlueprint</span>(BlueprintObj, CompileOptions, &amp;LogResults);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>UBlueprint</code> 就是用户正在编辑的蓝图资源。</p><p>最终会进入 <code>FBlueprintCompilationManagerImpl::FlushCompilationQueueImpl</code> 函数，此时正式进入蓝图编译的16个阶段。</p><p><img data-src="/images/UE5_blueprint_compile.png" alt="UE5_blueprint_compile"></p><h2 id="STAGE-I-GATHER"><a href="#STAGE-I-GATHER" class="headerlink" title="STAGE I: GATHER"></a>STAGE I: GATHER</h2><p>阶段1：收集所有需要重新编译的依赖蓝图。</p><p>若当前编译的蓝图是宏蓝图，则需要完全编译(生成骨架、字节码)所有依赖该宏蓝图的蓝图，因为宏的引脚类型可能发生变化。</p><p>而依赖该普通蓝图的蓝图仅需重新生成字节码，而不重新生成骨架，虽然引脚类型也可能发生改变，但此时还没有足够的信息证实是否发生了改变，先假定没有发生改变，避免不必要的开销。</p><span id="more"></span><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// STAGE I: Add any related blueprints that were not compiled, then add any children so that they will be relinked:</span></span><br><span class="line">TArray&lt;UBlueprint*&gt; BlueprintsToRecompile;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">const</span> FBPCompileRequestInternal&amp; CompileJob : QueuedRequests)</span><br><span class="line">&#123;</span><br><span class="line">    UBlueprint* BP = CompileJob.UserData.BPToCompile;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(BP-&gt;BlueprintType == BPTYPE_MacroLibrary)</span><br><span class="line">    &#123;</span><br><span class="line">        TArray&lt;UBlueprint*&gt; DependentBlueprints;</span><br><span class="line">        FBlueprintEditorUtils::<span class="built_in">GetDependentBlueprints</span>(BP, DependentBlueprints);</span><br><span class="line">        <span class="keyword">for</span>(UBlueprint* DependentBlueprint : DependentBlueprints)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="built_in">IsQueuedForCompilation</span>(DependentBlueprint))</span><br><span class="line">            &#123;</span><br><span class="line">                DependentBlueprint-&gt;bCachedDependenciesUpToDate &amp;= !bWasDependencyCacheOutOfDate;</span><br><span class="line"></span><br><span class="line">                DependentBlueprint-&gt;bQueuedForCompilation = <span class="literal">true</span>;</span><br><span class="line">                CurrentlyCompilingBPs.<span class="built_in">Emplace</span>(</span><br><span class="line">                    <span class="built_in">FCompilerData</span>(</span><br><span class="line">                        DependentBlueprint, </span><br><span class="line">                        ECompilationManagerJobType::Normal, </span><br><span class="line">                        <span class="literal">nullptr</span>, </span><br><span class="line">                        EBlueprintCompileOptions::None,</span><br><span class="line">                        <span class="literal">false</span> <span class="comment">// full compile</span></span><br><span class="line">                    )</span><br><span class="line">                );</span><br><span class="line">                BlueprintsToRecompile.<span class="built_in">Add</span>(DependentBlueprint);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">const</span> FBPCompileRequestInternal&amp; CompileJob : QueuedRequests)</span><br><span class="line">&#123;</span><br><span class="line">    TArray&lt;UBlueprint*&gt; DependentBlueprints;</span><br><span class="line">    FBlueprintEditorUtils::<span class="built_in">GetDependentBlueprints</span>(CompileJob.UserData.BPToCompile, DependentBlueprints);</span><br><span class="line">    <span class="keyword">for</span>(UBlueprint* DependentBlueprint : DependentBlueprints)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">IsQueuedForCompilation</span>(DependentBlueprint))</span><br><span class="line">        &#123;</span><br><span class="line">            DependentBlueprint-&gt;bQueuedForCompilation = <span class="literal">true</span>;</span><br><span class="line">            CurrentlyCompilingBPs.<span class="built_in">Emplace</span>(</span><br><span class="line">                <span class="built_in">FCompilerData</span>(</span><br><span class="line">                    DependentBlueprint, </span><br><span class="line">                    ECompilationManagerJobType::Normal, </span><br><span class="line">                    <span class="literal">nullptr</span>, </span><br><span class="line">                    EBlueprintCompileOptions::None,</span><br><span class="line">                    <span class="literal">true</span></span><br><span class="line">                )</span><br><span class="line">            );</span><br><span class="line">            BlueprintsToRecompile.<span class="built_in">Add</span>(DependentBlueprint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="STAGE-II-FILTER"><a href="#STAGE-II-FILTER" class="headerlink" title="STAGE II: FILTER"></a>STAGE II: FILTER</h2><p>阶段2：过滤掉不需要完整编译的蓝图，比如接口蓝图(没有逻辑)，或是纯数据蓝图，当纯数据蓝图与其父类具有相同的内存布局或父类为原生类时可以跳过编译，这两类蓝图虽然不需要完整编译，但仍需生成骨架用于编辑器展示。</p><p><code>FBlueprintEditorUtils::RemoveStaleFunctions</code> 是用来删除函数的，当当前为纯数据蓝图时，它的前身可能是从有函数的蓝图中过渡过来的，需要从 <code>UBlueprintGeneratedClass</code> 中删除它过时的函数。</p><p><code>UBlueprintGeneratedClass</code> 就是根据蓝图资源生成的类，平时加载资源时带的 <code>_C</code> 后缀就是指的是它，该类若不含字节码则为骨架，骨架只包含变量和函数声明，用于编辑器展示。含有编译后的字节码则为真正的蓝图执行类。</p><p>同时默认该骨骼的子类骨骼至少是 <code>relink</code> (猜测是因为子类蓝图未必是依赖父类的，但不清楚什么情况下才会是这样，有知道的留言一下。)</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// STAGE II: Filter out data only and interface blueprints:</span></span><br><span class="line"><span class="keyword">for</span>(int32 I = <span class="number">0</span>; I &lt; QueuedRequests.<span class="built_in">Num</span>(); ++I)</span><br><span class="line">&#123;</span><br><span class="line">    FBPCompileRequestInternal&amp; QueuedJob = QueuedRequests[I];</span><br><span class="line">    UBlueprint* QueuedBP = QueuedJob.UserData.BPToCompile;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> bDefaultComponentMustBeAdded = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">bool</span> bHasPendingUberGraphFrame = <span class="literal">false</span>;</span><br><span class="line">    UBlueprintGeneratedClass* BPGC = <span class="built_in">Cast</span>&lt;UBlueprintGeneratedClass&gt;(QueuedBP-&gt;GeneratedClass);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(BPGC)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>( BPGC-&gt;SimpleConstructionScript &amp;&amp;</span><br><span class="line">            BPGC-&gt;SimpleConstructionScript-&gt;<span class="built_in">GetSceneRootComponentTemplate</span>(<span class="literal">true</span>) == <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            bDefaultComponentMustBeAdded = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        bHasPendingUberGraphFrame = BPGC-&gt;UberGraphFramePointerProperty || BPGC-&gt;UberGraphFunction;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> bSkipCompile = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">const</span> UClass* ParentClass = QueuedBP-&gt;ParentClass;</span><br><span class="line">    <span class="type">const</span> <span class="type">bool</span> bHasClassAndMatchesParent = BPGC &amp;&amp; BPGC-&gt;<span class="built_in">GetSuperClass</span>() == ParentClass;</span><br><span class="line">    <span class="keyword">if</span>( bHasClassAndMatchesParent &amp;&amp;</span><br><span class="line">        FBlueprintEditorUtils::<span class="built_in">IsDataOnlyBlueprint</span>(QueuedBP) &amp;&amp; !QueuedBP-&gt;bHasBeenRegenerated &amp;&amp; </span><br><span class="line">        QueuedBP-&gt;<span class="built_in">GetLinker</span>() &amp;&amp; !bDefaultComponentMustBeAdded &amp;&amp; !bHasPendingUberGraphFrame )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// consider skipping the compile operation for this DOB:</span></span><br><span class="line">        <span class="keyword">if</span> (ParentClass &amp;&amp; ParentClass-&gt;<span class="built_in">HasAllClassFlags</span>(CLASS_Native))</span><br><span class="line">        &#123;</span><br><span class="line">            bSkipCompile = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">const</span> UClass* CurrentClass = QueuedBP-&gt;GeneratedClass)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(FStructUtils::<span class="built_in">TheSameLayout</span>(CurrentClass, CurrentClass-&gt;<span class="built_in">GetSuperStruct</span>()))</span><br><span class="line">            &#123;</span><br><span class="line">                bSkipCompile = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(bSkipCompile)</span><br><span class="line">    &#123;</span><br><span class="line">        CurrentlyCompilingBPs.<span class="built_in">Emplace</span>(</span><br><span class="line">            <span class="built_in">FCompilerData</span>(</span><br><span class="line">                QueuedBP, </span><br><span class="line">                ECompilationManagerJobType::SkeletonOnly, </span><br><span class="line">                QueuedJob.UserData.ClientResultsLog, </span><br><span class="line">                QueuedJob.UserData.CompileOptions,</span><br><span class="line">                <span class="literal">false</span></span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (QueuedBP-&gt;GeneratedClass != <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// set bIsRegeneratingOnLoad so that we don&#x27;t reset loaders:</span></span><br><span class="line">            QueuedBP-&gt;bIsRegeneratingOnLoad = <span class="literal">true</span>;</span><br><span class="line">            FBlueprintEditorUtils::<span class="built_in">RemoveStaleFunctions</span>(<span class="built_in">Cast</span>&lt;UBlueprintGeneratedClass&gt;(QueuedBP-&gt;GeneratedClass), QueuedBP);</span><br><span class="line">            QueuedBP-&gt;bIsRegeneratingOnLoad = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// No actual compilation work to be done, but try to conform the class and fix up anything that might need to be updated if the native base class has changed in any way</span></span><br><span class="line">        FKismetEditorUtilities::<span class="built_in">ConformBlueprintFlagsAndComponents</span>(QueuedBP);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (QueuedBP-&gt;GeneratedClass)</span><br><span class="line">        &#123;</span><br><span class="line">            FBlueprintEditorUtils::<span class="built_in">RecreateClassMetaData</span>(QueuedBP, QueuedBP-&gt;GeneratedClass, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        QueuedRequests.<span class="built_in">RemoveAtSwap</span>(I);</span><br><span class="line">        --I;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        ECompilationManagerJobType JobType = ECompilationManagerJobType::Normal;</span><br><span class="line">        <span class="keyword">if</span> ((QueuedJob.UserData.CompileOptions &amp; EBlueprintCompileOptions::RegenerateSkeletonOnly) != EBlueprintCompileOptions::None)</span><br><span class="line">        &#123;</span><br><span class="line">            JobType = ECompilationManagerJobType::SkeletonOnly;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        CurrentlyCompilingBPs.<span class="built_in">Emplace</span>(</span><br><span class="line">            <span class="built_in">FCompilerData</span>(</span><br><span class="line">                QueuedBP, </span><br><span class="line">                JobType, </span><br><span class="line">                QueuedJob.UserData.ClientResultsLog, </span><br><span class="line">                QueuedJob.UserData.CompileOptions, </span><br><span class="line">                <span class="literal">false</span></span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        BlueprintsToRecompile.<span class="built_in">Add</span>(QueuedBP);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(UBlueprint* BP : BlueprintsToRecompile)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// make sure all children are at least re-linked:</span></span><br><span class="line">    <span class="keyword">if</span>(UClass* OldSkeletonClass = BP-&gt;SkeletonGeneratedClass)</span><br><span class="line">    &#123;</span><br><span class="line">        TArray&lt;UClass*&gt; SkeletonClassesToReparentList;</span><br><span class="line">        <span class="comment">// Has to be recursive gather of children because instances of a UClass will cache information about</span></span><br><span class="line">        <span class="comment">// classes that are above their immediate parent (e.g. ClassConstructor):</span></span><br><span class="line">        <span class="built_in">GetDerivedClasses</span>(OldSkeletonClass, SkeletonClassesToReparentList);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(UClass* ChildClass : SkeletonClassesToReparentList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(UBlueprint* ChildBlueprint = UBlueprint::<span class="built_in">GetBlueprintFromClass</span>(ChildClass))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(!<span class="built_in">IsQueuedForCompilation</span>(ChildBlueprint))</span><br><span class="line">                &#123;</span><br><span class="line">                    ChildBlueprint-&gt;bQueuedForCompilation = <span class="literal">true</span>;</span><br><span class="line">                    CurrentlyCompilingBPs.<span class="built_in">Emplace</span>(</span><br><span class="line">                        <span class="built_in">FCompilerData</span>(</span><br><span class="line">                            ChildBlueprint, </span><br><span class="line">                            ECompilationManagerJobType::RelinkOnly, </span><br><span class="line">                            <span class="literal">nullptr</span>, </span><br><span class="line">                            EBlueprintCompileOptions::None,</span><br><span class="line">                            <span class="literal">false</span></span><br><span class="line">                        )</span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">CurrentlyCompilingBPs.<span class="built_in">RemoveAll</span>(</span><br><span class="line">    [](FCompilerData&amp; Data)</span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">IsValid</span>(Data.BP))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">check</span>(!Data.BP-&gt;bBeingCompiled);</span><br><span class="line">            <span class="built_in">check</span>(Data.BP-&gt;CurrentMessageLog == <span class="literal">nullptr</span>);</span><br><span class="line">            <span class="keyword">if</span>(UPackage* Package = Data.BP-&gt;<span class="built_in">GetOutermost</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                Package-&gt;<span class="built_in">SetDirtyFlag</span>(Data.bPackageWasDirty);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(Data.ResultsLog)</span><br><span class="line">            &#123;</span><br><span class="line">                Data.ResultsLog-&gt;<span class="built_in">EndEvent</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            Data.BP-&gt;bQueuedForCompilation = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">BlueprintsToRecompile.<span class="built_in">Empty</span>();</span><br><span class="line">QueuedRequests.<span class="built_in">Empty</span>();</span><br></pre></td></tr></table></figure><h2 id="STAGE-III-SORT"><a href="#STAGE-III-SORT" class="headerlink" title="STAGE III: SORT"></a>STAGE III: SORT</h2><p>阶段3：对要编译的蓝图进行排序，排序目的是保证编译先后顺序，比如接口要先编译，父类要在子类之前编译。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// STAGE III: Sort into correct compilation order. We want to compile root types before their derived (child) types:</span></span><br><span class="line"><span class="keyword">auto</span> HierarchyDepthSortFn = [](<span class="type">const</span> FCompilerData&amp; CompilerDataA, <span class="type">const</span> FCompilerData&amp; CompilerDataB)</span><br><span class="line">&#123;</span><br><span class="line">    UBlueprint&amp; A = *(CompilerDataA.BP);</span><br><span class="line">    UBlueprint&amp; B = *(CompilerDataB.BP);</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> bAIsInterface = FBlueprintEditorUtils::<span class="built_in">IsInterfaceBlueprint</span>(&amp;A);</span><br><span class="line">    <span class="type">bool</span> bBIsInterface = FBlueprintEditorUtils::<span class="built_in">IsInterfaceBlueprint</span>(&amp;B);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(bAIsInterface &amp;&amp; !bBIsInterface)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(bBIsInterface &amp;&amp; !bAIsInterface)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> FBlueprintCompileReinstancer::<span class="built_in">ReinstancerOrderingFunction</span>(A.GeneratedClass, B.GeneratedClass);</span><br><span class="line">&#125;;</span><br><span class="line">CurrentlyCompilingBPs.<span class="built_in">Sort</span>( HierarchyDepthSortFn );</span><br></pre></td></tr></table></figure><h2 id="STAGE-IV-SET-TEMPORARY-BLUEPRINT-FLAGS"><a href="#STAGE-IV-SET-TEMPORARY-BLUEPRINT-FLAGS" class="headerlink" title="STAGE IV: SET TEMPORARY BLUEPRINT FLAGS"></a>STAGE IV: SET TEMPORARY BLUEPRINT FLAGS</h2><p>阶段4：设置蓝图标记， <code>bBeingCompiled</code> 是否正在编译， <code>bIsRegeneratingOnLoad</code> 是否在加载时重新生成， <code>GetLinker</code> 找的到则说明该蓝图已经持有化了。</p><p>同时清除掉所有编译信息。</p><p><code>UEdGraph</code> 就是蓝图中的图，在编辑器里面创建节点的那个大框框就是它。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// STAGE IV: Set UBlueprint flags (bBeingCompiled, bIsRegeneratingOnLoad)</span></span><br><span class="line"><span class="keyword">for</span> (FCompilerData&amp; CompilerData : CurrentlyCompilingBPs)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!CompilerData.<span class="built_in">ShouldSetTemporaryBlueprintFlags</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UBlueprint* BP = CompilerData.BP;</span><br><span class="line">    BP-&gt;bBeingCompiled = <span class="literal">true</span>;</span><br><span class="line">    BP-&gt;CurrentMessageLog = CompilerData.ActiveResultsLog;</span><br><span class="line">    BP-&gt;bIsRegeneratingOnLoad = !BP-&gt;bHasBeenRegenerated &amp;&amp; BP-&gt;<span class="built_in">GetLinker</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(CompilerData.<span class="built_in">ShouldResetErrorState</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        TArray&lt;UEdGraph*&gt; AllGraphs;</span><br><span class="line">        BP-&gt;<span class="built_in">GetAllGraphs</span>(AllGraphs);</span><br><span class="line">        <span class="keyword">for</span> (UEdGraph* Graph : AllGraphs )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (UEdGraphNode* GraphNode : Graph-&gt;Nodes)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (GraphNode)</span><br><span class="line">                &#123;</span><br><span class="line">                    GraphNode-&gt;<span class="built_in">ClearCompilerMessage</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="STAGE-V-VALIDATE"><a href="#STAGE-V-VALIDATE" class="headerlink" title="STAGE V: VALIDATE"></a>STAGE V: VALIDATE</h2><p>阶段5：验证变量名和类属性的默认值。比如有个类属性的类型是 <code>AClass</code> 此时修改为了 <code>BClass</code> 这个时候值可能还是 <code>AClass</code> 类型，就需要抛出错误了。</p><p>第二阶段是为了进行版本兼容的，可以忽略。</p><p><code>FKismetCompilerContext</code> 是执行编译工作类，每次编译的时候都会生成一个新的 <code>Context</code> 存储正在编译的蓝图。</p><p><code>FKismetFunctionContext</code> 则是用于编译每个函数的类，到目前为止还没有见到，先提前了解一下。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// STAGE V: Validate</span></span><br><span class="line"><span class="keyword">for</span> (FCompilerData&amp; CompilerData : CurrentlyCompilingBPs)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!CompilerData.<span class="built_in">ShouldValidate</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    CompilerData.Compiler-&gt;<span class="built_in">ValidateVariableNames</span>();</span><br><span class="line">    CompilerData.Compiler-&gt;<span class="built_in">ValidateClassPropertyDefaults</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// STAGE V (phase 2): Give the blueprint the possibility for edits</span></span><br><span class="line"><span class="keyword">for</span> (FCompilerData&amp; CompilerData : CurrentlyCompilingBPs)</span><br><span class="line">&#123;</span><br><span class="line">    UBlueprint* BP = CompilerData.BP;</span><br><span class="line">    <span class="keyword">if</span> (BP-&gt;bIsRegeneratingOnLoad)</span><br><span class="line">    &#123;</span><br><span class="line">        FKismetCompilerContext&amp; CompilerContext = *(CompilerData.Compiler);</span><br><span class="line">        CompilerContext.<span class="built_in">PreCompileUpdateBlueprintOnLoad</span>(BP);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="STAGE-VI-PURGE-LOAD-ONLY"><a href="#STAGE-VI-PURGE-LOAD-ONLY" class="headerlink" title="STAGE VI: PURGE (LOAD ONLY)"></a>STAGE VI: PURGE (LOAD ONLY)</h2><p>阶段6：清除 <code>SubGraph</code> 中的空节点，阶段名字带 <code>(LOAD ONLY)</code> 的都是只在加载时执行的步骤，目的是为了版本兼容。 <code>ConformNativeComponents</code> 确保 <strong>蓝图</strong> 的 <strong>组件</strong> 与其 <strong>原生父类（Native Superclass）</strong> 的组件状态保持一致，可以忽略这一阶段。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// STAGE VI: Purge null graphs, misc. data fixup</span></span><br><span class="line"><span class="keyword">for</span> (FCompilerData&amp; CompilerData : CurrentlyCompilingBPs)</span><br><span class="line">&#123;</span><br><span class="line">    UBlueprint* BP = CompilerData.BP;</span><br><span class="line">    <span class="keyword">if</span>(BP-&gt;bIsRegeneratingOnLoad)</span><br><span class="line">    &#123;</span><br><span class="line">        FBlueprintEditorUtils::<span class="built_in">PurgeNullGraphs</span>(BP);</span><br><span class="line">        BP-&gt;<span class="built_in">ConformNativeComponents</span>();</span><br><span class="line">        <span class="keyword">if</span> (FLinkerLoad* Linker = BP-&gt;<span class="built_in">GetLinker</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (Linker-&gt;<span class="built_in">UEVer</span>() &lt; VER_UE4_EDITORONLY_BLUEPRINTS)</span><br><span class="line">            &#123;</span><br><span class="line">                BP-&gt;<span class="built_in">ChangeOwnerOfTemplates</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="STAGE-VII-DISCARD-SKELETON-CDO"><a href="#STAGE-VII-DISCARD-SKELETON-CDO" class="headerlink" title="STAGE VII: DISCARD SKELETON CDO"></a>STAGE VII: DISCARD SKELETON CDO</h2><p>阶段7：为了让骨骼的CDO能被垃圾回收，因为骨骼本身还要保留，转移走旧骨架的CDO，转移方式是构造一个拷贝骨架，在原始名字前加上 <code>REINST_</code> 前缀，将旧骨架CDO赋给它。</p><p><strong>固定父类的 CDO 版本</strong> 让蓝图在编译时不需要频繁修改父类和子类的依赖关系，避免了复杂的循环和重复计算。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// STAGE VII: safely throw away old skeleton CDOs:</span></span><br><span class="line">TMap&lt;UClass*, UClass*&gt; NewSkeletonToOldSkeleton;</span><br><span class="line"><span class="keyword">for</span> (FCompilerData&amp; CompilerData : CurrentlyCompilingBPs)</span><br><span class="line">&#123;</span><br><span class="line">    UBlueprint* BP = CompilerData.BP;</span><br><span class="line">    UClass* OldSkeletonClass = BP-&gt;SkeletonGeneratedClass;</span><br><span class="line">    <span class="keyword">if</span>(OldSkeletonClass)</span><br><span class="line">    &#123;</span><br><span class="line">        FBlueprintCompileReinstancer::<span class="built_in">MoveDependentSkelToReinst</span>(OldSkeletonClass, NewSkeletonToOldSkeleton);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="STAGE-VIII-recompile-skeleton"><a href="#STAGE-VIII-recompile-skeleton" class="headerlink" title="STAGE VIII: recompile skeleton"></a>STAGE VIII: recompile skeleton</h2><p>阶段8：重建骨架，核心函数是 <code>FastGenerateSkeletonClass</code> ，会构建 UFunction、Event 以及 Timeline，注意此时不会为其生成实际的字节码，它只是个骨架，此时骨架的CDO会重建。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// STAGE VIII: recompile skeleton</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// if any function signatures have changed in this skeleton class we will need to recompile all dependencies, but if not</span></span><br><span class="line"><span class="comment">// then we can avoid dependency recompilation:</span></span><br><span class="line"><span class="type">bool</span> bSkipUnneededDependencyCompilation = !Private::ConsoleVariables::bForceAllDependenciesToRecompile;</span><br><span class="line">TSet&lt;UObject*&gt; OldFunctionsWithSignatureChanges;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (FCompilerData&amp; CompilerData : CurrentlyCompilingBPs)</span><br><span class="line">&#123;</span><br><span class="line">    UBlueprint* BP = CompilerData.BP;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(CompilerData.<span class="built_in">ShouldRegenerateSkeleton</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(BlueprintsCompiledOrSkeletonCompiled)</span><br><span class="line">        &#123;</span><br><span class="line">            BlueprintsCompiledOrSkeletonCompiled-&gt;<span class="built_in">Add</span>(BP);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        BP-&gt;SkeletonGeneratedClass = <span class="built_in">FastGenerateSkeletonClass</span>(BP, *(CompilerData.Compiler), CompilerData.<span class="built_in">IsSkeletonOnly</span>(), CompilerData.SkeletonFixupData);</span><br><span class="line">        UBlueprintGeneratedClass* AuthoritativeClass = <span class="built_in">Cast</span>&lt;UBlueprintGeneratedClass&gt;(BP-&gt;GeneratedClass);</span><br><span class="line">        <span class="keyword">if</span>(AuthoritativeClass &amp;&amp; bSkipUnneededDependencyCompilation)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(CompilerData.InternalOptions.CompileType == EKismetCompileType::Full )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (TFieldIterator&lt;UFunction&gt; <span class="built_in">FuncIt</span>(AuthoritativeClass, EFieldIteratorFlags::ExcludeSuper); FuncIt; ++FuncIt)</span><br><span class="line">                &#123;</span><br><span class="line">                    UFunction* OldFunction = *FuncIt;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(!OldFunction-&gt;<span class="built_in">HasAnyFunctionFlags</span>(EFunctionFlags::FUNC_BlueprintCallable))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// We assume that if the func is FUNC_BlueprintCallable that it will be present in the Skeleton class.</span></span><br><span class="line">                    <span class="comment">// If it is not in the skeleton class we will always think that this blueprints public interface has </span></span><br><span class="line">                    <span class="comment">// changed. Not a huge deal, but will mean we recompile dependencies more often than necessary.</span></span><br><span class="line">                    UFunction* NewFunction = BP-&gt;SkeletonGeneratedClass-&gt;<span class="built_in">FindFunctionByName</span>((OldFunction)-&gt;<span class="built_in">GetFName</span>());</span><br><span class="line">                    <span class="keyword">if</span>(	NewFunction == <span class="literal">nullptr</span> || </span><br><span class="line">                        !NewFunction-&gt;<span class="built_in">IsSignatureCompatibleWith</span>(OldFunction) || </span><br><span class="line">                        <span class="comment">// If a function changes its net flags, callers may now need to do a full EX_FinalFunction/EX_VirtualFunction </span></span><br><span class="line">                        <span class="comment">// instead of a EX_LocalFinalFunction/EX_LocalVirtualFunction:</span></span><br><span class="line">                        NewFunction-&gt;<span class="built_in">HasAnyFunctionFlags</span>(FUNC_NetFuncFlags) != OldFunction-&gt;<span class="built_in">HasAnyFunctionFlags</span>(FUNC_NetFuncFlags))</span><br><span class="line">                    &#123;</span><br><span class="line">                        OldFunctionsWithSignatureChanges.<span class="built_in">Add</span>(OldFunction);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Just relink, note that UProperties that reference *other* types may be stale until</span></span><br><span class="line">        <span class="comment">// we fixup below:</span></span><br><span class="line">        <span class="built_in">RelinkSkeleton</span>(BP-&gt;SkeletonGeneratedClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(CompilerData.<span class="built_in">ShouldMarkUpToDateAfterSkeletonStage</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Flag data only blueprints as being up-to-date</span></span><br><span class="line">        BP-&gt;Status = BP-&gt;bHasBeenRegenerated ? CompilerData.OriginalBPStatus : BS_UpToDate;</span><br><span class="line">        BP-&gt;bHasBeenRegenerated = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (BP-&gt;GeneratedClass)</span><br><span class="line">        &#123;</span><br><span class="line">            BP-&gt;GeneratedClass-&gt;<span class="built_in">ClearFunctionMapsCaches</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修正 <code>Delegate</code> 签名。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Fix up delegate parameters on skeleton class UFunctions, as they have a direct reference to a UFunction*</span></span><br><span class="line"><span class="comment">// that may have been created as part of skeleton generation:</span></span><br><span class="line"><span class="keyword">for</span> (FCompilerData&amp; CompilerData : CurrentlyCompilingBPs)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">TRACE_CPUPROFILER_EVENT_SCOPE</span>(FixUpDelegateParameters);</span><br><span class="line"></span><br><span class="line">    UBlueprint* BP = CompilerData.BP;</span><br><span class="line">    TArray&lt;FSkeletonFixupData&gt;&amp; ParamsToFix = CompilerData.SkeletonFixupData;</span><br><span class="line">    <span class="keyword">for</span>( <span class="type">const</span> FSkeletonFixupData&amp; FixupData : ParamsToFix )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(FDelegateProperty* DelegateProperty = <span class="built_in">CastField</span>&lt;FDelegateProperty&gt;(FixupData.DelegateProperty))</span><br><span class="line">        &#123;</span><br><span class="line">            FSkeletonFixupData::<span class="built_in">FixUpDelegateProperty</span>(DelegateProperty, FixupData.MemberReference, BP-&gt;SkeletonGeneratedClass);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(FMulticastDelegateProperty* MCDelegateProperty = <span class="built_in">CastField</span>&lt;FMulticastDelegateProperty&gt;(FixupData.DelegateProperty))</span><br><span class="line">        &#123;</span><br><span class="line">            FSkeletonFixupData::<span class="built_in">FixUpDelegateProperty</span>(MCDelegateProperty, FixupData.MemberReference, BP-&gt;SkeletonGeneratedClass);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>若依赖当前蓝图的蓝图函数签名未改变则不需要重新编译，这类优化可以跳过不看，理清主流程即可。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Skip further compilation for blueprints that are being bytecode compiled as a dependency of something that has</span></span><br><span class="line"><span class="comment">// not had a change in its function parameters:</span></span><br><span class="line"><span class="keyword">if</span>(bSkipUnneededDependencyCompilation)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> HasNoReferencesToChangedFunctions = [&amp;OldFunctionsWithSignatureChanges](FCompilerData&amp; Data)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!Data.<span class="built_in">ShouldSkipIfDependenciesAreUnchanged</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Anim BPs cannot skip un-needed dependency compilation as their property access bytecode</span></span><br><span class="line">        <span class="comment">// will need refreshing due to external class layouts changing (they require at least a bytecode recompile or a relink)</span></span><br><span class="line">        <span class="type">const</span> <span class="type">bool</span> bIsAnimBlueprintClass = !!<span class="built_in">Cast</span>&lt;UAnimBlueprint&gt;(Data.BP);</span><br><span class="line">        <span class="keyword">if</span>(bIsAnimBlueprintClass)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// if our parent is still being compiled, then we still need to be compiled:</span></span><br><span class="line">        UClass* Iter = Data.BP-&gt;ParentClass;</span><br><span class="line">        <span class="keyword">while</span>(Iter)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(UBlueprint* BP = <span class="built_in">Cast</span>&lt;UBlueprint&gt;(Iter-&gt;ClassGeneratedBy))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(BP-&gt;bBeingCompiled)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Iter = Iter-&gt;<span class="built_in">GetSuperClass</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// look for references to a function with a signature change</span></span><br><span class="line">        <span class="comment">// in the old class, if it has none, we can skip bytecode recompile:</span></span><br><span class="line">        <span class="type">bool</span> bHasNoReferencesToChangedFunctions = <span class="literal">true</span>;</span><br><span class="line">        UBlueprintGeneratedClass* BPGC = <span class="built_in">Cast</span>&lt;UBlueprintGeneratedClass&gt;(Data.BP-&gt;GeneratedClass);</span><br><span class="line">        <span class="keyword">if</span>(BPGC)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(UFunction* CalledFunction : BPGC-&gt;CalledFunctions)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(OldFunctionsWithSignatureChanges.<span class="built_in">Contains</span>(CalledFunction))</span><br><span class="line">                &#123;</span><br><span class="line">                    bHasNoReferencesToChangedFunctions = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(bHasNoReferencesToChangedFunctions)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// This BP is not actually going to be compiled, clean it up:</span></span><br><span class="line">            Data.BP-&gt;bBeingCompiled = <span class="literal">false</span>;</span><br><span class="line">            Data.BP-&gt;CurrentMessageLog = <span class="literal">nullptr</span>;</span><br><span class="line">            <span class="keyword">if</span>(UPackage* Package = Data.BP-&gt;<span class="built_in">GetOutermost</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                Package-&gt;<span class="built_in">SetDirtyFlag</span>(Data.bPackageWasDirty);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(Data.ResultsLog)</span><br><span class="line">            &#123;</span><br><span class="line">                Data.ResultsLog-&gt;<span class="built_in">EndEvent</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            Data.BP-&gt;bQueuedForCompilation = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bHasNoReferencesToChangedFunctions;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Order very much matters, but we could RemoveAllSwap and re-sort:</span></span><br><span class="line">    CurrentlyCompilingBPs.<span class="built_in">RemoveAll</span>(HasNoReferencesToChangedFunctions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后是处理新变量的默认值，若当前蓝图的父类有新变量，则记录下来，确保之后能够继承和初始化这些变量。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Detect any variable-based properties that are not in the old generated class, save them for after reinstancing. This can occur </span></span><br><span class="line"><span class="comment">//    when a new variable is introduced in an ancestor class, and we&#x27;ll need to use its default as our generated class&#x27;s initial value.</span></span><br><span class="line"><span class="keyword">for</span> (FCompilerData&amp; CompilerData : CurrentlyCompilingBPs)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (CompilerData.JobType == ECompilationManagerJobType::Normal &amp;&amp;</span><br><span class="line">            CompilerData.BP-&gt;bHasBeenRegenerated &amp;&amp;		<span class="comment">// Note: This ensures that we&#x27;ll only do this after the Blueprint has been loaded/created; otherwise the class may not contain any properties to find.</span></span><br><span class="line">            CompilerData.BP-&gt;GeneratedClass &amp;&amp;</span><br><span class="line">            !CompilerData.<span class="built_in">ShouldSkipNewVariableDefaultsDetection</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> UClass* ParentClass = CompilerData.BP-&gt;ParentClass;</span><br><span class="line">        <span class="keyword">while</span> (<span class="type">const</span> UBlueprint* ParentBP = UBlueprint::<span class="built_in">GetBlueprintFromClass</span>(ParentClass))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">const</span> FBPVariableDescription&amp; ParentBPVarDesc : ParentBP-&gt;NewVariables)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (!CompilerData.BP-&gt;GeneratedClass-&gt;<span class="built_in">FindPropertyByName</span>(ParentBPVarDesc.VarName))</span><br><span class="line">                &#123;</span><br><span class="line">                    CompilerData.NewDefaultVariables.<span class="built_in">Add</span>(ParentBPVarDesc);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ParentClass = ParentBP-&gt;ParentClass;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>FastGenerateSkeletonClass</code> 逻辑很长，此处只摘取一小部分代码，用于讲解概念。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UClass* <span class="title">FBlueprintCompilationManagerImpl::FastGenerateSkeletonClass</span><span class="params">(UBlueprint* BP, FKismetCompilerContext&amp; CompilerContext, <span class="type">bool</span> bIsSkeletonOnly, TArray&lt;FSkeletonFixupData&gt;&amp; OutSkeletonFixupData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> UEdGraphSchema_K2* Schema = <span class="built_in">GetDefault</span>&lt;UEdGraphSchema_K2&gt;();</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> MakeFunction = [Ret, ParentClass, Schema, BP, &amp;MessageLog, &amp;OutSkeletonFixupData]</span><br><span class="line">        (	FName FunctionNameFName, </span><br><span class="line">            UField**&amp; InCurrentFieldStorageLocation, </span><br><span class="line">            FField**&amp; InCurrentParamStorageLocation, </span><br><span class="line">            EFunctionFlags InFunctionFlags, </span><br><span class="line">            <span class="type">const</span> TArray&lt;UK2Node_FunctionResult*&gt;&amp; ReturnNodes, </span><br><span class="line">            <span class="type">const</span> TArray&lt;UEdGraphPin*&gt;&amp; InputPins,</span><br><span class="line">            <span class="type">bool</span> bIsStaticFunction, </span><br><span class="line">            <span class="type">bool</span> bForceArrayStructRefsConst, </span><br><span class="line">            UFunction* SignatureOverride) -&gt; UFunction*</span><br><span class="line">    &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>UEdGraphSchema_K2</code> 继承自 <code>UEdGraphSchema</code> 用于描述蓝图节点之间是否可以建立连接。</p><p><code>UK2Node_FunctionResult</code> 继承 <code>UK2Node</code> 又继承自 <code>UEdGraphNode</code> 就是蓝图中的一个个节点，此处表示函数的返回值。</p><p><code>UEdGraphPin</code> 表示蓝图节点中的引脚，分为输入输出引脚。</p><h2 id="STAGE-IX-RECONSTRUCT-NODES-REPLACE-DEPRECATED-NODES-LOAD-ONLY"><a href="#STAGE-IX-RECONSTRUCT-NODES-REPLACE-DEPRECATED-NODES-LOAD-ONLY" class="headerlink" title="STAGE IX: RECONSTRUCT NODES, REPLACE DEPRECATED NODES (LOAD ONLY)"></a>STAGE IX: RECONSTRUCT NODES, REPLACE DEPRECATED NODES (LOAD ONLY)</h2><p>阶段9：重建节点，替换掉已被废弃的节点，这一步一是为了兼容旧版本，二是为了通知其他依赖该蓝图的蓝图进行重建节点，最后广播预编译出去。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// STAGE IX: Reconstruct nodes and replace deprecated nodes, then broadcast &#x27;precompile</span></span><br><span class="line"><span class="keyword">for</span> (FCompilerData&amp; CompilerData : CurrentlyCompilingBPs)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!CompilerData.<span class="built_in">ShouldReconstructNodes</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UBlueprint* BP = CompilerData.BP;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ConformToParentAndInterfaces</span>(BP);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Some nodes are set up to do things during reconstruction only when this flag is NOT set.</span></span><br><span class="line">    <span class="keyword">if</span>(BP-&gt;bIsRegeneratingOnLoad)</span><br><span class="line">    &#123;</span><br><span class="line">        FBlueprintEditorUtils::<span class="built_in">ReconstructAllNodes</span>(BP);</span><br><span class="line">        FBlueprintEditorUtils::<span class="built_in">ReplaceDeprecatedNodes</span>(BP);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// matching existing behavior, when compiling a BP not on load we refresh nodes</span></span><br><span class="line">        <span class="comment">// before compiling:</span></span><br><span class="line">        FBlueprintCompileReinstancer::<span class="built_in">OptionallyRefreshNodes</span>(BP);</span><br><span class="line">        TArray&lt;UBlueprint*&gt; DependentBlueprints;</span><br><span class="line">        FBlueprintEditorUtils::<span class="built_in">GetDependentBlueprints</span>(BP, DependentBlueprints);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (UBlueprint* CurrentBP : DependentBlueprints)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">const</span> EBlueprintStatus OriginalStatus = CurrentBP-&gt;Status;</span><br><span class="line">            UPackage* <span class="type">const</span> Package = CurrentBP-&gt;<span class="built_in">GetOutermost</span>();</span><br><span class="line">            <span class="type">const</span> <span class="type">bool</span> bStartedWithUnsavedChanges = Package != <span class="literal">nullptr</span> ? Package-&gt;<span class="built_in">IsDirty</span>() : <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            FBlueprintEditorUtils::<span class="built_in">RefreshExternalBlueprintDependencyNodes</span>(CurrentBP, BP-&gt;GeneratedClass);</span><br><span class="line"></span><br><span class="line">            CurrentBP-&gt;Status = OriginalStatus;</span><br><span class="line">            <span class="keyword">if</span>(Package != <span class="literal">nullptr</span> &amp;&amp; Package-&gt;<span class="built_in">IsDirty</span>() &amp;&amp; !bStartedWithUnsavedChanges)</span><br><span class="line">            &#123;</span><br><span class="line">                Package-&gt;<span class="built_in">SetDirtyFlag</span>(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Broadcast pre-compile</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(GEditor &amp;&amp; GIsEditor)</span><br><span class="line">        &#123;</span><br><span class="line">            GEditor-&gt;<span class="built_in">BroadcastBlueprintPreCompile</span>(BP);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (CompilerData.<span class="built_in">ShouldUpdateBlueprintSearchMetadata</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Do not want to run this code without the editor present nor when running commandlets.</span></span><br><span class="line">        <span class="keyword">if</span> (GEditor &amp;&amp; GIsEditor)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// We do not want to regenerate a search Guid during loads, nothing has changed in the Blueprint and it is cached elsewhere</span></span><br><span class="line">            <span class="keyword">if</span> (!BP-&gt;bIsRegeneratingOnLoad)</span><br><span class="line">            &#123;</span><br><span class="line">                FFindInBlueprintSearchManager::<span class="built_in">Get</span>().<span class="built_in">AddOrUpdateBlueprintSearchMetadata</span>(BP);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    BP-&gt;bHasBeenRegenerated = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="STAGE-X-CREATE-REINSTANCER-DISCARD-‘OLD’-CLASS"><a href="#STAGE-X-CREATE-REINSTANCER-DISCARD-‘OLD’-CLASS" class="headerlink" title="STAGE X: CREATE REINSTANCER (DISCARD ‘OLD’ CLASS)"></a>STAGE X: CREATE REINSTANCER (DISCARD ‘OLD’ CLASS)</h2><p>阶段10：简单来说就是如果需要重新实例化就要丢掉 CDO，这次是要丢掉 <code>GeneratedClass</code> 的 CDO，拷贝了一个新<code>GeneratedClass</code> 旧CDO移动到新的 <code>GeneratedClass</code> 使其能够正常被垃圾回收， <code>CompilerData.Compiler-&gt;OldClass</code> 指向的就是新拷贝出来的，和之前骨架的处理一个思路。</p><p>确保蓝图的变更能够正确传播到所有已存在的实例和派生类。</p><p>需要重新实例化的情况要么是完整编译要么是有父类的 <code>GeneratedClass</code> 有新版本。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// STAGE X: reinstance every blueprint that is queued, note that this means classes in the hierarchy that are *not* being </span></span><br><span class="line"><span class="comment">// compiled will be parented to REINST versions of the class, so type checks (IsA, etc) involving those types</span></span><br><span class="line"><span class="comment">// will be incoherent!</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (FCompilerData&amp; CompilerData : CurrentlyCompilingBPs)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// we including skeleton only compilation jobs for reinstancing because we need UpdateCustomPropertyListForPostConstruction</span></span><br><span class="line">        <span class="comment">// to happen (at the right time) for those generated classes as well. This means we *don&#x27;t* need to reinstance if </span></span><br><span class="line">        <span class="comment">// the parent is a native type (unless we hot reload, but that should not need to be handled here):</span></span><br><span class="line">        <span class="keyword">if</span>(CompilerData.<span class="built_in">ShouldSkipReinstancerCreation</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// no need to reinstance skeleton or relink jobs that are not in a hierarchy that has had reinstancing initiated:</span></span><br><span class="line">        <span class="type">bool</span> bRequiresReinstance = CompilerData.<span class="built_in">ShouldInitiateReinstancing</span>();</span><br><span class="line">        <span class="keyword">if</span> (!bRequiresReinstance)</span><br><span class="line">        &#123;</span><br><span class="line">            UClass* Iter = CompilerData.BP-&gt;GeneratedClass;</span><br><span class="line">            <span class="keyword">if</span> (!Iter)</span><br><span class="line">            &#123;</span><br><span class="line">                bRequiresReinstance = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (Iter)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (Iter-&gt;<span class="built_in">HasAnyClassFlags</span>(CLASS_NewerVersionExists))</span><br><span class="line">                &#123;</span><br><span class="line">                    bRequiresReinstance = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Iter = Iter-&gt;<span class="built_in">GetSuperClass</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!bRequiresReinstance)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        UBlueprint* BP = CompilerData.BP;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(BP-&gt;GeneratedClass)</span><br><span class="line">        &#123;</span><br><span class="line">            OldCDOs.<span class="built_in">Add</span>(BP, BP-&gt;GeneratedClass-&gt;ClassDefaultObject);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        EBlueprintCompileReinstancerFlags CompileReinstancerFlags =</span><br><span class="line">            EBlueprintCompileReinstancerFlags::AutoInferSaveOnCompile</span><br><span class="line">            | EBlueprintCompileReinstancerFlags::AvoidCDODuplication;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (CompilerData.<span class="built_in">UseDeltaSerializationDuringReinstancing</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            CompileReinstancerFlags |= EBlueprintCompileReinstancerFlags::UseDeltaSerialization;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        CompilerData.Reinstancer = <span class="built_in">TSharedPtr</span>&lt;FBlueprintCompileReinstancer&gt;(</span><br><span class="line">            <span class="keyword">new</span> <span class="built_in">FBlueprintCompileReinstancer</span>(</span><br><span class="line">                BP-&gt;GeneratedClass,</span><br><span class="line">                CompileReinstancerFlags</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(CompilerData.Compiler.<span class="built_in">IsValid</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            CompilerData.Compiler-&gt;OldClass = <span class="built_in">Cast</span>&lt;UBlueprintGeneratedClass&gt;(CompilerData.Reinstancer-&gt;DuplicatedClass);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(BP-&gt;GeneratedClass)</span><br><span class="line">        &#123;</span><br><span class="line">            BP-&gt;GeneratedClass-&gt;bLayoutChanging = <span class="literal">true</span>;</span><br><span class="line">            CompilerData.Reinstancer-&gt;<span class="built_in">SaveSparseClassData</span>(BP-&gt;GeneratedClass);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="STAGE-XI-CREATE-UPDATED-CLASS-HIERARCHY"><a href="#STAGE-XI-CREATE-UPDATED-CLASS-HIERARCHY" class="headerlink" title="STAGE XI: CREATE UPDATED CLASS HIERARCHY"></a>STAGE XI: CREATE UPDATED CLASS HIERARCHY</h2><p>阶段11：修复父子继承链。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// STAGE XI: Reinstancing done, lets fix up child-&gt;parent pointers and take ownership of SCD:</span></span><br><span class="line"><span class="keyword">for</span> (FCompilerData&amp; CompilerData : CurrentlyCompilingBPs)</span><br><span class="line">&#123;</span><br><span class="line">    UBlueprint* BP = CompilerData.BP;</span><br><span class="line">    <span class="keyword">if</span>(BP-&gt;GeneratedClass &amp;&amp; BP-&gt;GeneratedClass-&gt;<span class="built_in">GetSuperClass</span>()-&gt;<span class="built_in">HasAnyClassFlags</span>(CLASS_NewerVersionExists))</span><br><span class="line">    &#123;</span><br><span class="line">        BP-&gt;GeneratedClass-&gt;<span class="built_in">SetSuperStruct</span>(BP-&gt;GeneratedClass-&gt;<span class="built_in">GetSuperClass</span>()-&gt;<span class="built_in">GetAuthoritativeClass</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(BP-&gt;GeneratedClass &amp;&amp; CompilerData.Reinstancer.<span class="built_in">IsValid</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        CompilerData.Reinstancer-&gt;<span class="built_in">TakeOwnershipOfSparseClassData</span>(BP-&gt;GeneratedClass);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="STAGE-XII-COMPILE-CLASS-LAYOUT"><a href="#STAGE-XII-COMPILE-CLASS-LAYOUT" class="headerlink" title="STAGE XII: COMPILE CLASS LAYOUT"></a>STAGE XII: COMPILE CLASS LAYOUT</h2><p>阶段12：重新编译所有蓝图，核心函数 <code>CompileClassLayout</code> 。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// STAGE XII: Recompile every blueprint</span></span><br><span class="line">bGeneratedClassLayoutReady = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">for</span> (FCompilerData&amp; CompilerData : CurrentlyCompilingBPs)</span><br><span class="line">&#123;</span><br><span class="line">    UBlueprint* BP = CompilerData.BP;</span><br><span class="line">    <span class="keyword">if</span>(CompilerData.<span class="built_in">ShouldCompileClassLayout</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// default value propagation occurs in ReinstaneBatch, CDO will be created via CompileFunctions call:</span></span><br><span class="line">        <span class="keyword">if</span>(BP-&gt;ParentClass)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(BP-&gt;GeneratedClass)</span><br><span class="line">            &#123;</span><br><span class="line">                BP-&gt;GeneratedClass-&gt;ClassDefaultObject = <span class="literal">nullptr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Reset the flag, so if the user tries to use PIE it will warn them if the BP did not compile</span></span><br><span class="line">            BP-&gt;bDisplayCompilePIEWarning = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// this will create FProperties for the UClass and generate the sparse class data</span></span><br><span class="line">            <span class="comment">// if the compiler in question wants to:</span></span><br><span class="line">            FKismetCompilerContext&amp; CompilerContext = *(CompilerData.Compiler);</span><br><span class="line">            CompilerContext.<span class="built_in">CompileClassLayout</span>(EInternalCompilerFlags::PostponeLocalsGenerationUntilPhaseTwo);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We immediately relink children so that iterative compilation logic has an easier time:</span></span><br><span class="line">            TArray&lt;UClass*&gt; ClassesToRelink;</span><br><span class="line">            <span class="built_in">GetDerivedClasses</span>(BP-&gt;GeneratedClass, ClassesToRelink, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">for</span> (UClass* ChildClass : ClassesToRelink)</span><br><span class="line">            &#123;</span><br><span class="line">                ChildClass-&gt;<span class="built_in">Bind</span>();</span><br><span class="line">                ChildClass-&gt;<span class="built_in">StaticLink</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            CompilerData.ActiveResultsLog-&gt;<span class="built_in">Error</span>(*<span class="built_in">LOCTEXT</span>(<span class="string">&quot;KismetCompileError_MalformedParentClasss&quot;</span>, <span class="string">&quot;Blueprint @@ has missing or NULL parent class.&quot;</span>).<span class="built_in">ToString</span>(), BP);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(CompilerData.Compiler.<span class="built_in">IsValid</span>() &amp;&amp; BP-&gt;GeneratedClass)</span><br><span class="line">    &#123;</span><br><span class="line">        CompilerData.Compiler-&gt;<span class="built_in">SetNewClass</span>( <span class="built_in">CastChecked</span>&lt;UBlueprintGeneratedClass&gt;(BP-&gt;GeneratedClass) );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">FixupDelegateProperties</span>(CurrentlyCompilingBPs);</span><br><span class="line">bGeneratedClassLayoutReady = <span class="literal">true</span>;</span><br><span class="line"><span class="built_in">ProcessExtensions</span>(CurrentlyCompilingBPs);</span><br></pre></td></tr></table></figure><p><code>CompileClassLayout</code> 大致就是创建 <code>UFunction</code> 创建变量这些操作。 <code>PrecompileFunction</code> 执行 以下操作：</p><ul><li>计划执行并计算数据依赖性。</li><li>删除任何计划外的或不是数据依赖项的节点。</li><li>在每个剩余节点上运行节点处理器的 **RegisterNets()**。</li><li>此操作将为函数内的值创建 <strong>FKismetTerms</strong>。</li><li>创建 <strong>UFunction</strong> 和关联属性。</li></ul><p>将函数展开成线性节点，存放到 <code>LinearExecutionList</code> 中，用于下一阶段编译。</p><p><strong>CleanAndSanitizeClass()</strong> 将属性和函数从类中移到临时包中的垃圾类中， 然后清除类中的任何数据，生成骨架时也用到了该函数。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">FKismetCompilerContext::CompileClassLayout</span><span class="params">(EInternalCompilerFlags InternalFlags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">CleanAndSanitizeClass</span>(TargetClass, OldCDO);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If applicable, register any delegate proxy functions and their captured actor variables</span></span><br><span class="line">    <span class="built_in">RegisterClassDelegateProxiesFromBlueprint</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Run thru the class defined variables first, get them registered</span></span><br><span class="line">    <span class="built_in">CreateClassVariablesFromBlueprint</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add any interfaces that the blueprint implements to the class</span></span><br><span class="line">    <span class="comment">// (has to happen before we validate pin links in CreateFunctionList(), so that we can verify self/interface pins)</span></span><br><span class="line">    <span class="built_in">AddInterfacesFromBlueprint</span>(NewClass);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Construct a context for each function, doing validation and building the function interface</span></span><br><span class="line">    <span class="built_in">CreateFunctionList</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (int32 i = <span class="number">0</span>; i &lt; FunctionList.<span class="built_in">Num</span>(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(FunctionList[i].<span class="built_in">IsDelegateSignature</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">PrecompileFunction</span>(FunctionList[i], InternalFlags);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (int32 i = <span class="number">0</span>; i &lt; FunctionList.<span class="built_in">Num</span>(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!FunctionList[i].<span class="built_in">IsDelegateSignature</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">PrecompileFunction</span>(FunctionList[i], InternalFlags);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="STAGE-XIII-COMPILE-CLASS-FUNCTIONS"><a href="#STAGE-XIII-COMPILE-CLASS-FUNCTIONS" class="headerlink" title="STAGE XIII: COMPILE CLASS FUNCTIONS"></a>STAGE XIII: COMPILE CLASS FUNCTIONS</h2><p>阶段13：真正编译函数的地方。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// STAGE XIII: Compile functions</span></span><br><span class="line">UBlueprintEditorSettings* Settings = <span class="built_in">GetMutableDefault</span>&lt;UBlueprintEditorSettings&gt;();</span><br><span class="line"><span class="type">const</span> <span class="type">bool</span> bSaveBlueprintsAfterCompile = Settings-&gt;SaveOnCompile == SoC_Always;</span><br><span class="line"><span class="type">const</span> <span class="type">bool</span> bSaveBlueprintAfterCompileSucceeded = Settings-&gt;SaveOnCompile == SoC_SuccessOnly;</span><br><span class="line"><span class="keyword">for</span> (FCompilerData&amp; CompilerData : CurrentlyCompilingBPs)</span><br><span class="line">&#123;</span><br><span class="line">    UBlueprint* BP = CompilerData.BP;</span><br><span class="line">    UClass* BPGC = BP-&gt;GeneratedClass;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!CompilerData.<span class="built_in">ShouldCompileClassFunctions</span>())</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">// default value propagation occurs below:</span></span><br><span class="line">    <span class="keyword">if</span>(BPGC)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (CompilerData.Reinstancer.<span class="built_in">IsValid</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            CompilerData.Reinstancer-&gt;<span class="built_in">PropagateSparseClassDataToNewClass</span>(BPGC);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( BPGC-&gt;ClassDefaultObject &amp;&amp; </span><br><span class="line">            BPGC-&gt;ClassDefaultObject-&gt;<span class="built_in">GetClass</span>() == BPGC)</span><br><span class="line">        &#123;</span><br><span class="line">            BPGC-&gt;ClassDefaultObject-&gt;<span class="built_in">Rename</span>(</span><br><span class="line">                <span class="literal">nullptr</span>,</span><br><span class="line">                <span class="comment">// destination - this is the important part of this call. Moving the object </span></span><br><span class="line">                <span class="comment">// out of the way so we can reuse its name:</span></span><br><span class="line">                <span class="built_in">GetTransientPackage</span>(), </span><br><span class="line">                <span class="comment">// Rename options:</span></span><br><span class="line">                REN_DoNotDirty | REN_DontCreateRedirectors | REN_ForceNoResetLoaders</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        BPGC-&gt;ClassDefaultObject = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// class layout is ready, we can clear bLayoutChanging and CompileFunctions can create the CDO:</span></span><br><span class="line">        BPGC-&gt;bLayoutChanging = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        FKismetCompilerContext&amp; CompilerContext = *(CompilerData.Compiler);</span><br><span class="line">        CompilerContext.<span class="built_in">CompileFunctions</span>(</span><br><span class="line">            EInternalCompilerFlags::PostponeLocalsGenerationUntilPhaseTwo</span><br><span class="line">            |EInternalCompilerFlags::PostponeDefaultObjectAssignmentUntilReinstancing</span><br><span class="line">            |EInternalCompilerFlags::SkipRefreshExternalBlueprintDependencyNodes</span><br><span class="line">        ); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(BPGC)</span><br><span class="line">    &#123;</span><br><span class="line">        BPGC-&gt;ClassFlags &amp;= ~CLASS_ReplicationDataIsSetUp;</span><br><span class="line">        BPGC-&gt;<span class="built_in">SetUpRuntimeReplicationData</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    FKismetCompilerUtilities::<span class="built_in">UpdateDependentBlueprints</span>(BP);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>CompileFunction</code> 将线性节点展开，纯节点还会进行内联。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (FNodeHandlingFunctor* Handler = NodeHandlers.<span class="built_in">FindRef</span>(Node-&gt;<span class="built_in">GetClass</span>()))</span><br><span class="line">&#123;</span><br><span class="line">    Handler-&gt;<span class="built_in">Compile</span>(Context, Node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>CompileFunction</code>过程中为每个蓝图节点生成一系列 <code>Statement</code> 。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FBlueprintCompiledStatement&amp; Statement = Context.<span class="built_in">AppendStatementForNode</span>(Node);</span><br></pre></td></tr></table></figure><p>节选一部分 <code>Statement</code> 。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FBlueprintCompiledStatement</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">EKismetCompiledStatementType</span></span><br><span class="line">&#123;</span><br><span class="line">    KCST_Nop = <span class="number">0</span>,</span><br><span class="line">    <span class="comment">// [wiring =] TargetObject-&gt;FunctionToCall(wiring)</span></span><br><span class="line">    KCST_CallFunction = <span class="number">1</span>,</span><br><span class="line">    <span class="comment">// TargetObject-&gt;TargetProperty = [wiring]</span></span><br><span class="line">    KCST_Assignment = <span class="number">2</span>,</span><br><span class="line">    <span class="comment">// One of the other types with a compilation error during statement generation</span></span><br><span class="line">    KCST_CompileError = <span class="number">3</span>,</span><br><span class="line">    <span class="comment">// goto TargetLabel</span></span><br><span class="line">    KCST_UnconditionalGoto = <span class="number">4</span>,</span><br><span class="line">    <span class="comment">// FlowStack.Push(TargetLabel)</span></span><br><span class="line">    KCST_PushState = <span class="number">5</span>,</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>使用 <code>FKismetCompilerVMBackend</code> 将 <code>Statement</code> 翻译成字节码，同时修正跳转。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FKismetCompilerVMBackend <span class="title">Backend_VM</span><span class="params">(Blueprint, Schema, *<span class="keyword">this</span>)</span></span>;</span><br><span class="line">Backend_VM.<span class="built_in">GenerateCodeFromClass</span>(NewClass, FunctionList, bGenerateStubsOnly);</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">GenerateCodeForStatement</span><span class="params">(FKismetCompilerContext&amp; CompilerContext, FKismetFunctionContext&amp; FunctionContext, FBlueprintCompiledStatement&amp; Statement, UEdGraphNode* SourceNode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Generate bytecode for the statement</span></span><br><span class="line">    <span class="keyword">switch</span> (Statement.Type)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> KCST_Nop:</span><br><span class="line">        Writer &lt;&lt; EX_Nothing;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> KCST_CallFunction:</span><br><span class="line">        <span class="built_in">EmitFunctionCall</span>(CompilerContext, FunctionContext, Statement, SourceNode);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="STAGE-XIV-REINSTANCE"><a href="#STAGE-XIV-REINSTANCE" class="headerlink" title="STAGE XIV: REINSTANCE"></a>STAGE XIV: REINSTANCE</h2><p>阶段14：重新实例化的第一阶段，旧类转移为新类，这部分主要是记录一些信息，方便之后将旧实例替换为新实例，这部分交给 <code>FlushReinstancingQueueImpl</code> 完成，和蓝图编译关系不是很大。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// STAGE XIV: Now we can finish the first stage of the reinstancing operation, moving old classes to new classes:</span></span><br><span class="line">TArray&lt;FReinstancingJob&gt; Reinstancers;</span><br><span class="line"><span class="comment">// Set up reinstancing jobs - we need a reference to the compiler in order to honor </span></span><br><span class="line"><span class="comment">// CopyTermDefaultsToDefaultObject</span></span><br><span class="line"><span class="keyword">for</span> (FCompilerData&amp; CompilerData : CurrentlyCompilingBPs)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(CompilerData.Reinstancer.<span class="built_in">IsValid</span>() &amp;&amp; CompilerData.Reinstancer-&gt;ClassToReinstance)</span><br><span class="line">    &#123;</span><br><span class="line">        Reinstancers.<span class="built_in">Push</span>(</span><br><span class="line">            <span class="built_in">FReinstancingJob</span>( CompilerData.Reinstancer, CompilerData.Compiler )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FScopedDurationTimer <span class="title">ReinstTimer</span><span class="params">(GTimeReinstancing)</span></span>;</span><br><span class="line"><span class="built_in">ReinstanceBatch</span>(Reinstancers, <span class="built_in">MutableView</span>(ClassesToReinstance), InLoadContext, OldToNewTemplates);</span><br><span class="line"></span><br><span class="line"><span class="comment">// We purposefully do not remove the OldCDOs yet, need to keep them in memory past first GC</span></span><br><span class="line"><span class="comment">// Set default values on any newly-introduced variables (from ancestor BPs)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (FCompilerData&amp; CompilerData : CurrentlyCompilingBPs)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!CompilerData.NewDefaultVariables.<span class="built_in">Num</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> UBlueprintGeneratedClass* GenClass = <span class="built_in">Cast</span>&lt;UBlueprintGeneratedClass&gt;(CompilerData.BP-&gt;GeneratedClass);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (GenClass &amp;&amp; GenClass-&gt;ClassDefaultObject)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> FBPVariableDescription&amp; NewInheritedVar : CompilerData.NewDefaultVariables)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="type">const</span> FProperty* MatchingProperty = GenClass-&gt;<span class="built_in">FindPropertyByName</span>(NewInheritedVar.VarName))</span><br><span class="line">            &#123;</span><br><span class="line">                FBlueprintEditorUtils::<span class="built_in">PropertyValueFromString</span>(MatchingProperty, NewInheritedVar.DefaultValue, <span class="built_in">reinterpret_cast</span>&lt;uint8*&gt;(GenClass-&gt;ClassDefaultObject.<span class="built_in">Get</span>()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="STAGE-XV-POST-CDO-COMPILED"><a href="#STAGE-XV-POST-CDO-COMPILED" class="headerlink" title="STAGE XV: POST CDO COMPILED"></a>STAGE XV: POST CDO COMPILED</h2><p>阶段15：里面几乎都是空函数，啥也没做。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">for (FCompilerData&amp; CompilerData : CurrentlyCompilingBPs)</span><br><span class="line">&#123;</span><br><span class="line">    if (CompilerData.Compiler.IsValid())</span><br><span class="line">    &#123;</span><br><span class="line">        UObject::FPostCDOCompiledContext PostCDOCompiledContext;</span><br><span class="line">        PostCDOCompiledContext.bIsRegeneratingOnLoad = CompilerData.BP-&gt;bIsRegeneratingOnLoad;</span><br><span class="line">        PostCDOCompiledContext.bIsSkeletonOnly = CompilerData.IsSkeletonOnly();</span><br><span class="line"></span><br><span class="line">        CompilerData.Compiler-&gt;PostCDOCompiled(PostCDOCompiledContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="STAGE-XVI-CLEAR-TEMPORARY-FLAGS"><a href="#STAGE-XVI-CLEAR-TEMPORARY-FLAGS" class="headerlink" title="STAGE XVI: CLEAR TEMPORARY FLAGS"></a>STAGE XVI: CLEAR TEMPORARY FLAGS</h2><p>阶段16：收尾工作，清理标记，设置好蓝图状态，广播编译完成。</p><h1 id="FlushReinstancingQueueImpl"><a href="#FlushReinstancingQueueImpl" class="headerlink" title="FlushReinstancingQueueImpl"></a>FlushReinstancingQueueImpl</h1><p>最后这一部分则是替换实例了，比如场景有个 BP_Actor，这次编译了该蓝图资源，就会用新的 <code>GeneratedClass</code> 去 SpawnActor 来替换它。</p></div><footer class="post-footer"><div class="post-tags"><a href="/tags/UE5/" rel="tag"># UE5</a> <a href="/tags/%E8%93%9D%E5%9B%BE%E7%BC%96%E8%AF%91/" rel="tag"># 蓝图编译</a></div><div class="post-nav"><div class="post-nav-item"><a href="/UE5%20%E5%8F%8D%E5%B0%84%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E4%B8%8E%E6%B3%A8%E5%86%8C/" rel="prev" title="UE5 反射代码生成与注册"><i class="fa fa-angle-left"></i> UE5 反射代码生成与注册</a></div><div class="post-nav-item"><a href="/UE5%20%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%E8%AF%A6%E8%A7%A3/" rel="next" title="UE5 智能指针详解">UE5 智能指针详解 <i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Yuerer</span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><div class="reading-progress-bar"></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://unpkg.com/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://unpkg.com/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/comments.min.js"></script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/utils.min.js"></script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/motion.min.js"></script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/sidebar.min.js"></script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/next-boot.min.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://yuerer-comment-xufei-0bea01e6f05-1307930306.ap-shanghai.app.tcloudbase.com","cssUrl":"https://s4.zstatic.net/ajax/libs/waline/2.15.8/waline.css","commentCount":true,"pageview":true,"libUrl":"https://s4.zstatic.net/ajax/libs/waline/2.15.8/waline.js","locale":{"placeholder":"有何高见？"},"emoji":["https://unpkg.com/@waline/emojis@1.0.1/qq"],"meta":["nick","mail"],"requiredMeta":[["nick","mail"]],"wordLimit":0,"login":"disable","pageSize":10,"el":"#waline","comment":true,"path":"/UE5%20%E8%93%9D%E5%9B%BE%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B%E5%89%96%E6%9E%90/"}</script><link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/waline/2.15.8/waline.css"><script>document.addEventListener("page:loaded",()=>{NexT.utils.loadComments(CONFIG.waline.el).then(()=>NexT.utils.getScript(CONFIG.waline.libUrl,{condition:window.Waline})).then(()=>Waline.init(Object.assign({},CONFIG.waline,{el:document.querySelector(CONFIG.waline.el)})))})</script></body></html>