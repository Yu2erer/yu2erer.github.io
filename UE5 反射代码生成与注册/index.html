<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.jpeg"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.ico"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.ico"><link rel="mask-icon" href="/images/avatar.jpeg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous"><link rel="stylesheet" href="https://unpkg.com/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"yuerer.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"hide","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/config.min.js"></script><meta name="description" content="本文以 UE5.4 为基准，剖析反射代码的生成内容和注册流程。 简介UE5 的 C++ 需要各种宏来辅助开发，在编译时使用 UHT 工具扫描这些宏来生成 XXX.generated.h 和 XXX.gen.cpp 两个文件，接下来将分析UHT生成的文件，来学习反射具体做了什么。代码将会删减掉热更相关的内容，只关注核心逻辑。 反射代码Enum枚举的声明在C++中有三种方式，C风格、namespace"><meta property="og:type" content="article"><meta property="og:title" content="UE5 反射代码生成与注册"><meta property="og:url" content="https://yuerer.com/UE5%20%E5%8F%8D%E5%B0%84%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E4%B8%8E%E6%B3%A8%E5%86%8C/index.html"><meta property="og:site_name" content="Yuerer&#39;s Blog"><meta property="og:description" content="本文以 UE5.4 为基准，剖析反射代码的生成内容和注册流程。 简介UE5 的 C++ 需要各种宏来辅助开发，在编译时使用 UHT 工具扫描这些宏来生成 XXX.generated.h 和 XXX.gen.cpp 两个文件，接下来将分析UHT生成的文件，来学习反射具体做了什么。代码将会删减掉热更相关的内容，只关注核心逻辑。 反射代码Enum枚举的声明在C++中有三种方式，C风格、namespace"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2025-01-11T14:17:20.000Z"><meta property="article:modified_time" content="2025-10-21T13:50:52.261Z"><meta property="article:author" content="Yuerer"><meta property="article:tag" content="UE5"><meta property="article:tag" content="反射"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://yuerer.com/UE5%20%E5%8F%8D%E5%B0%84%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E4%B8%8E%E6%B3%A8%E5%86%8C/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://yuerer.com/UE5%20%E5%8F%8D%E5%B0%84%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E4%B8%8E%E6%B3%A8%E5%86%8C/","path":"UE5 反射代码生成与注册/","title":"UE5 反射代码生成与注册"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>UE5 反射代码生成与注册 | Yuerer's Blog</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-129491388-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-129491388-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/third-party/analytics/google-analytics.min.js"></script><link rel="dns-prefetch" href="https://yuerer-comment-xufei-0bea01e6f05-1307930306.ap-shanghai.app.tcloudbase.com"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Yuerer's Blog</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">钰儿的Blog</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%B0%84%E4%BB%A3%E7%A0%81"><span class="nav-text">反射代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Enum"><span class="nav-text">Enum</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Struct"><span class="nav-text">Struct</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Class"><span class="nav-text">Class</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Interface"><span class="nav-text">Interface</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%B0%84%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%86%8C"><span class="nav-text">反射代码注册</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Yuerer" src="/images/avatar.jpeg"><p class="site-author-name" itemprop="name">Yuerer</p><div class="site-description" itemprop="description">钰儿的Blog</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">65</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">90</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Yu2erer" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Yu2erer" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:yu2erer#gmail.com" title="E-Mail → mailto:yu2erer#gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://yuerer.com/UE5%20%E5%8F%8D%E5%B0%84%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E4%B8%8E%E6%B3%A8%E5%86%8C/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpeg"><meta itemprop="name" content="Yuerer"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Yuerer's Blog"><meta itemprop="description" content="钰儿的Blog"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="UE5 反射代码生成与注册 | Yuerer's Blog"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">UE5 反射代码生成与注册</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2025-01-11 22:17:20" itemprop="dateCreated datePublished" datetime="2025-01-11T22:17:20+08:00">2025-01-11</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/UE/" itemprop="url" rel="index"><span itemprop="name">UE</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Waline：</span> <a title="waline" href="/UE5%20%E5%8F%8D%E5%B0%84%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E4%B8%8E%E6%B3%A8%E5%86%8C/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/UE5%20%E5%8F%8D%E5%B0%84%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E4%B8%8E%E6%B3%A8%E5%86%8C/" itemprop="commentCount"></span> </a></span><span class="post-meta-item" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="waline-pageview-count" data-path="/UE5%20%E5%8F%8D%E5%B0%84%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E4%B8%8E%E6%B3%A8%E5%86%8C/"></span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>本文以 UE5.4 为基准，剖析反射代码的生成内容和注册流程。</p><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>UE5 的 C++ 需要各种宏来辅助开发，在编译时使用 <code>UHT</code> 工具扫描这些宏来生成 <code>XXX.generated.h</code> 和 <code>XXX.gen.cpp</code> 两个文件，接下来将分析UHT生成的文件，来学习反射具体做了什么。代码将会删减掉热更相关的内容，只关注核心逻辑。</p><h2 id="反射代码"><a href="#反射代码" class="headerlink" title="反射代码"></a>反射代码</h2><h3 id="Enum"><a href="#Enum" class="headerlink" title="Enum"></a>Enum</h3><p>枚举的声明在C++中有三种方式，C风格、namespace、enum class。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum class</span> <span class="title class_">ECppForm</span></span><br><span class="line">&#123;</span><br><span class="line">    Regular,</span><br><span class="line">    Namespaced,</span><br><span class="line">    EnumClass</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>为了减小本文篇幅，此处只看 enum class。在一个新文件中定义完该 enum class 后，进行构建。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UENUM</span>(BlueprintType)</span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">EMyEnumClass</span>:uint8</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">Enum1	<span class="title">UMETA</span><span class="params">(DisplayName = <span class="string">&quot;DisplayInBlueprint&quot;</span>)</span>,</span></span><br><span class="line"><span class="function">    Enum2,</span></span><br><span class="line"><span class="function">&#125;</span>;</span><br></pre></td></tr></table></figure><p>最终会生成 <code>generated.h</code> 和 <code>gen.cpp</code> 两个文件。</p><p><code>generated.h</code> 的内容如下，仅仅只是一些模板全特化，便于开发。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FOREACH_ENUM_EMYENUMCLASS(op) \</span></span><br><span class="line"><span class="meta">    op(EMyEnumClass::Enum1) \</span></span><br><span class="line"><span class="meta">    op(EMyEnumClass::Enum2) </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">EMyEnumClass</span> : uint8;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; <span class="keyword">struct</span> <span class="title class_">TIsUEnumClass</span>&lt;EMyEnumClass&gt; &#123; <span class="keyword">enum</span> &#123; Value = <span class="literal">true</span> &#125;; &#125;;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; REFLECTION_API UEnum* <span class="built_in">StaticEnum</span>&lt;EMyEnumClass&gt;();</span><br></pre></td></tr></table></figure><span id="more"></span><p><code>gen.cpp</code> 的内容偏多，将从上往下进行注释讲解。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一个空函数，避免被编译器误认为该文件没有需要编译的内容而跳过</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EmptyLinkFunctionForGeneratedCodeMyEnumClass</span><span class="params">()</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>前置声明，内部构建 UEnum 和 UPackage。 UPackage 是个代码包，会将同一模块内的所有反射类组织到一起 。反射的代码都是以 <code>Z_</code> 开头，因为 <code>Z</code> 是字母最后一位，避免代码提示里提示过靠前。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 看返回值就知道 是构建 UEnum 的</span></span><br><span class="line"><span class="function">REFLECTION_API UEnum* <span class="title">Z_Construct_UEnum_Reflection_EMyEnumClass</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// 构建该 UEnum 所属的 Package, 避免 Package 没构建出来</span></span><br><span class="line"><span class="function">UPackage* <span class="title">Z_Construct_UPackage__Script_Reflection</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><p>此处才是真正对外构建 UEnum 的接口，其内部最终会调用到 <code>Z_Construct_UEnum_Reflection_EMyEnumClass</code> ，但此时还没看到该函数的定义先略过。还有一点需要注意 调用 <code>GetStaticEnum</code> 时，已经显式的调用 <code>Z_Construct_UPackage__Script_Reflection()</code> 来确保 UPackage 一定存在了。</p><p>剧透一下 <code>GetStaticEnum</code> 实际上就是执行第一个参数的函数，用内部函数构建出 <code>UEnum</code> 。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> FEnumRegistrationInfo Z_Registration_Info_UEnum_EMyEnumClass;</span><br><span class="line"><span class="function"><span class="type">static</span> UEnum* <span class="title">EMyEnumClass_StaticEnum</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!Z_Registration_Info_UEnum_EMyEnumClass.OuterSingleton)</span><br><span class="line">    &#123;</span><br><span class="line">        Z_Registration_Info_UEnum_EMyEnumClass.OuterSingleton = <span class="built_in">GetStaticEnum</span>(</span><br><span class="line">            Z_Construct_UEnum_Reflection_EMyEnumClass,</span><br><span class="line">            (UObject*)<span class="built_in">Z_Construct_UPackage__Script_Reflection</span>(),</span><br><span class="line">            <span class="built_in">TEXT</span>(<span class="string">&quot;EMyEnumClass&quot;</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Z_Registration_Info_UEnum_EMyEnumClass.OuterSingleton;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; REFLECTION_API UEnum* <span class="built_in">StaticEnum</span>&lt;EMyEnumClass&gt;()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">EMyEnumClass_StaticEnum</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此处是一些元数据， <code>FEnumParams</code> 就是后面用来构建 UEnum 的参数。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Z_Construct_UEnum_Reflection_EMyEnumClass_Statics</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_METADATA</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> UECodeGen_Private::FMetaDataPairParam Enum_MetaDataParams[] = &#123;</span><br><span class="line">        &#123; <span class="string">&quot;BlueprintType&quot;</span>, <span class="string">&quot;true&quot;</span> &#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !UE_BUILD_SHIPPING</span></span><br><span class="line">        &#123; <span class="string">&quot;Comment&quot;</span>, <span class="string">&quot;/**\n * \n */&quot;</span> &#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#123; <span class="string">&quot;Enum1.Comment&quot;</span>, <span class="string">&quot;/**\n * \n */&quot;</span> &#125;,</span><br><span class="line">        &#123; <span class="string">&quot;Enum1.DisplayName&quot;</span>, <span class="string">&quot;DisplayInBlueprint&quot;</span> &#125;,</span><br><span class="line">        &#123; <span class="string">&quot;Enum1.Name&quot;</span>, <span class="string">&quot;EMyEnumClass::Enum1&quot;</span> &#125;,</span><br><span class="line">        &#123; <span class="string">&quot;Enum2.Comment&quot;</span>, <span class="string">&quot;/**\n * \n */&quot;</span> &#125;,</span><br><span class="line">        &#123; <span class="string">&quot;Enum2.Name&quot;</span>, <span class="string">&quot;EMyEnumClass::Enum2&quot;</span> &#125;,</span><br><span class="line">        &#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;Public/Enum/MyEnumClass.h&quot;</span> &#125;,</span><br><span class="line">	&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// WITH_METADATA</span></span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> UECodeGen_Private::FEnumeratorParam Enumerators[] = &#123;</span><br><span class="line">        &#123; <span class="string">&quot;EMyEnumClass::Enum1&quot;</span>, (int64)EMyEnumClass::Enum1 &#125;,</span><br><span class="line">        &#123; <span class="string">&quot;EMyEnumClass::Enum2&quot;</span>, (int64)EMyEnumClass::Enum2 &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> UECodeGen_Private::FEnumParams EnumParams;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> UECodeGen_Private::FEnumParams Z_Construct_UEnum_Reflection_EMyEnumClass_Statics::EnumParams = &#123;</span><br><span class="line">    (UObject*(*)())Z_Construct_UPackage__Script_Reflection,</span><br><span class="line">    <span class="literal">nullptr</span>,</span><br><span class="line">    <span class="string">&quot;EMyEnumClass&quot;</span>,</span><br><span class="line">    <span class="string">&quot;EMyEnumClass&quot;</span>,</span><br><span class="line">    Z_Construct_UEnum_Reflection_EMyEnumClass_Statics::Enumerators,</span><br><span class="line">    RF_Public|RF_Transient|RF_MarkAsNative, <span class="comment">// 包外可见、不需要序列化、标记为原生类</span></span><br><span class="line">    <span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UEnum_Reflection_EMyEnumClass_Statics::Enumerators),</span><br><span class="line">    EEnumFlags::None,</span><br><span class="line">    (uint8)UEnum::ECppForm::EnumClass, <span class="comment">// 之前提到过的 创建 Enum 的三种方式</span></span><br><span class="line">    <span class="built_in">METADATA_PARAMS</span>(<span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UEnum_Reflection_EMyEnumClass_Statics::Enum_MetaDataParams), Z_Construct_UEnum_Reflection_EMyEnumClass_Statics::Enum_MetaDataParams)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FEnumParams</span></span><br><span class="line">&#123;</span><br><span class="line">    UObject*                  (*OuterFunc)();</span><br><span class="line">    <span class="built_in">FText</span>                     (*DisplayNameFunc)(int32);</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>*                 NameUTF8;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>*                 CppTypeUTF8;</span><br><span class="line">    <span class="type">const</span> FEnumeratorParam*     EnumeratorParams;</span><br><span class="line">    EObjectFlags                ObjectFlags;</span><br><span class="line">    int16                       NumEnumerators;</span><br><span class="line">    EEnumFlags                  EnumFlags;</span><br><span class="line">    uint8                       CppForm; <span class="comment">// this is of type UEnum::ECppForm</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_METADATA</span></span><br><span class="line">    uint16                      NumMetaData;</span><br><span class="line">    <span class="type">const</span> FMetaDataPairParam*   MetaDataArray;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>内部真正构造 UEnum 的函数，Outer 最终就是调用该函数 完成 Inner 的构建。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UEnum* <span class="title">Z_Construct_UEnum_Reflection_EMyEnumClass</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!Z_Registration_Info_UEnum_EMyEnumClass.InnerSingleton)</span><br><span class="line">    &#123;</span><br><span class="line">        UECodeGen_Private::<span class="built_in">ConstructUEnum</span>(Z_Registration_Info_UEnum_EMyEnumClass.InnerSingleton, Z_Construct_UEnum_Reflection_EMyEnumClass_Statics::EnumParams);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Z_Registration_Info_UEnum_EMyEnumClass.InnerSingleton;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注册相关代码，可以看出它是以文件为单位，将整个文件的内容都放到一起，这个文件只有一个枚举，所以内容就比较少，如果还有 UStruct 的话 也会在此处被列出。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Z_CompiledInDeferFile_FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Enum_MyEnumClass_h_Statics</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> FEnumRegisterCompiledInInfo EnumInfo[] = &#123;</span><br><span class="line">        &#123; EMyEnumClass_StaticEnum, <span class="built_in">TEXT</span>(<span class="string">&quot;EMyEnumClass&quot;</span>), </span><br><span class="line">            &amp;Z_Registration_Info_UEnum_EMyEnumClass,</span><br><span class="line">            <span class="built_in">CONSTRUCT_RELOAD_VERSION_INFO</span>(FEnumReloadVersionInfo, <span class="number">4010083278U</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">static</span> FRegisterCompiledInInfo <span class="title">Z_CompiledInDeferFile_FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Enum_MyEnumClass_h_2660371430</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    TEXT(<span class="string">&quot;/Script/Reflection&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="literal">nullptr</span>, <span class="number">0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="literal">nullptr</span>, <span class="number">0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    Z_CompiledInDeferFile_FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Enum_MyEnumClass_h_Statics::EnumInfo, </span></span></span><br><span class="line"><span class="params"><span class="function">    UE_ARRAY_COUNT(Z_CompiledInDeferFile_FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Enum_MyEnumClass_h_Statics::EnumInfo)</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FEnumRegisterCompiledInInfo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">UEnum</span>* (*OuterRegister)();</span><br><span class="line">    <span class="type">const</span> TCHAR* Name;</span><br><span class="line">    FEnumRegistrationInfo* Info;</span><br><span class="line">    FEnumReloadVersionInfo VersionInfo;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="Struct"><a href="#Struct" class="headerlink" title="Struct"></a>Struct</h3><p>为了本文主体逻辑能够简单理解，只声明定义一个属性。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">USTRUCT</span>(BlueprintType)</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FMyStruct</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UPROPERTY</span>()</span><br><span class="line">    int32 MyInt32 = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>GENERATED_BODY</code> 本质就是将其替换为 <code>文件名_行号_GENERATED_BODY</code> 。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> BODY_MACRO_COMBINE_INNER(A,B,C,D) A##B##C##D</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BODY_MACRO_COMBINE(A,B,C,D) BODY_MACRO_COMBINE_INNER(A,B,C,D)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GENERATED_BODY(...) BODY_MACRO_COMBINE(CURRENT_FILE_ID,_,__LINE__,_GENERATED_BODY);</span></span><br></pre></td></tr></table></figure><p>最后会被替换 <code>FID_Project_Source_Reflection_Public_Struct_MyStruct_h_13_GENERATED_BODY</code></p><p>再看 <code>generated.h</code> 的内容</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FID_Project_Source_Reflection_Public_Struct_MyStruct_h_13_GENERATED_BODY \</span></span><br><span class="line"><span class="meta">    friend struct Z_Construct_UScriptStruct_FMyStruct_Statics; \</span></span><br><span class="line"><span class="meta">    REFLECTION_API static class UScriptStruct* StaticStruct();</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt; REFLECTION_API UScriptStruct* <span class="built_in">StaticStruct</span>&lt;<span class="keyword">struct</span> <span class="title class_">FMyStruct</span>&gt;();</span><br></pre></td></tr></table></figure><p>宏展开之后得到</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;&gt; REFLECTION_API UScriptStruct* <span class="built_in">StaticStruct</span>&lt;<span class="keyword">struct</span> <span class="title class_">FMyStruct</span>&gt;();</span><br><span class="line"></span><br><span class="line"><span class="built_in">USTRUCT</span>(BlueprintType)</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FMyStruct</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">struct</span> <span class="title class_">Z_Construct_UScriptStruct_FMyStruct_Statics</span>;</span><br><span class="line">    <span class="function">REFLECTION_API <span class="type">static</span> <span class="keyword">class</span> UScriptStruct* <span class="title">StaticStruct</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UPROPERTY</span>()</span><br><span class="line">    int32 MyInt32 = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>gen.cpp</code> 内容如下，但不会再次解释了，很多都在 Enum 那解释过了。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EmptyLinkFunctionForGeneratedCodeMyStruct</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="comment">// 前置声明</span></span><br><span class="line"><span class="function">REFLECTION_API UScriptStruct* <span class="title">Z_Construct_UScriptStruct_FMyStruct</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">UPackage* <span class="title">Z_Construct_UPackage__Script_Reflection</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><p>对外的构造 Struct 接口。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> FStructRegistrationInfo Z_Registration_Info_UScriptStruct_MyStruct;</span><br><span class="line"><span class="function"><span class="keyword">class</span> UScriptStruct* <span class="title">FMyStruct::StaticStruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!Z_Registration_Info_UScriptStruct_MyStruct.OuterSingleton)</span><br><span class="line">    &#123;</span><br><span class="line">        Z_Registration_Info_UScriptStruct_MyStruct.OuterSingleton = <span class="built_in">GetStaticStruct</span>(</span><br><span class="line">            Z_Construct_UScriptStruct_FMyStruct,</span><br><span class="line">            (UObject*)<span class="built_in">Z_Construct_UPackage__Script_Reflection</span>(),</span><br><span class="line">            <span class="built_in">TEXT</span>(<span class="string">&quot;MyStruct&quot;</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Z_Registration_Info_UScriptStruct_MyStruct.OuterSingleton;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; REFLECTION_API UScriptStruct* <span class="built_in">StaticStruct</span>&lt;FMyStruct&gt;()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> FMyStruct::<span class="built_in">StaticStruct</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>反射元数据，其中 <code>NewStructOps</code> 提供了结构体反射、序列化、复制比较功能。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Z_Construct_UScriptStruct_FMyStruct_Statics</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_METADATA</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> UECodeGen_Private::FMetaDataPairParam Struct_MetaDataParams[] = &#123;</span><br><span class="line">        &#123; <span class="string">&quot;BlueprintType&quot;</span>, <span class="string">&quot;true&quot;</span> &#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !UE_BUILD_SHIPPING</span></span><br><span class="line">        &#123; <span class="string">&quot;Comment&quot;</span>, <span class="string">&quot;/**\n * \n */&quot;</span> &#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;Public/Struct/MyStruct.h&quot;</span> &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> UECodeGen_Private::FMetaDataPairParam NewProp_MyInt32_MetaData[] = &#123;</span><br><span class="line">        &#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;Public/Struct/MyStruct.h&quot;</span> &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// WITH_METADATA</span></span></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> UECodeGen_Private::FIntPropertyParams NewProp_MyInt32;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> UECodeGen_Private::FPropertyParamsBase* <span class="type">const</span> PropPointers[];</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span>* <span class="title">NewStructOps</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (UScriptStruct::ICppStructOps*)<span class="keyword">new</span> UScriptStruct::<span class="built_in">TCppStructOps</span>&lt;FMyStruct&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> UECodeGen_Private::FStructParams StructParams;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>属性，我们只有一个属性，可以看到会在这记录该属性在 Struct 中的偏移量，同时 属性个数不得超过 2048个。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> UECodeGen_Private::FIntPropertyParams Z_Construct_UScriptStruct_FMyStruct_Statics::NewProp_MyInt32 = &#123;</span><br><span class="line">    <span class="string">&quot;MyInt32&quot;</span>,</span><br><span class="line">    <span class="literal">nullptr</span>,</span><br><span class="line">    (EPropertyFlags)<span class="number">0x0010000000000000</span>,</span><br><span class="line">    UECodeGen_Private::EPropertyGenFlags::Int,</span><br><span class="line">    RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">    <span class="literal">nullptr</span>,</span><br><span class="line">    <span class="literal">nullptr</span>,</span><br><span class="line">    <span class="number">1</span>,</span><br><span class="line">    <span class="built_in">STRUCT_OFFSET</span>(FMyStruct, MyInt32),</span><br><span class="line">    <span class="built_in">METADATA_PARAMS</span>(<span class="built_in">UE_ARRAY_COUNT</span>(NewProp_MyInt32_MetaData),</span><br><span class="line">    NewProp_MyInt32_MetaData)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">const</span> UECodeGen_Private::FPropertyParamsBase* <span class="type">const</span> Z_Construct_UScriptStruct_FMyStruct_Statics::PropPointers[] = &#123;</span><br><span class="line">    (<span class="type">const</span> UECodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UScriptStruct_FMyStruct_Statics::NewProp_MyInt32,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">static_assert</span>(<span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UScriptStruct_FMyStruct_Statics::PropPointers) &lt; <span class="number">2048</span>);</span><br></pre></td></tr></table></figure><p>构造 Struct 的参数。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> UECodeGen_Private::FStructParams Z_Construct_UScriptStruct_FMyStruct_Statics::StructParams = &#123;</span><br><span class="line">    (UObject* (*)())Z_Construct_UPackage__Script_Reflection,</span><br><span class="line">    <span class="literal">nullptr</span>, <span class="comment">// 父类</span></span><br><span class="line">    &amp;NewStructOps,</span><br><span class="line">    <span class="string">&quot;MyStruct&quot;</span>,</span><br><span class="line">    Z_Construct_UScriptStruct_FMyStruct_Statics::PropPointers,</span><br><span class="line">    <span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UScriptStruct_FMyStruct_Statics::PropPointers),</span><br><span class="line">    <span class="built_in">sizeof</span>(FMyStruct),</span><br><span class="line">    <span class="built_in">alignof</span>(FMyStruct),</span><br><span class="line">    RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">    <span class="built_in">EStructFlags</span>(<span class="number">0x00000001</span>), <span class="comment">// STRUCT_Native</span></span><br><span class="line">    <span class="built_in">METADATA_PARAMS</span>(<span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UScriptStruct_FMyStruct_Statics::Struct_MetaDataParams), Z_Construct_UScriptStruct_FMyStruct_Statics::Struct_MetaDataParams)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FStructParams</span></span><br><span class="line">&#123;</span><br><span class="line">    UObject*                          (*OuterFunc)();</span><br><span class="line">    UScriptStruct*                    (*SuperFunc)();</span><br><span class="line">    <span class="type">void</span>*                             (*StructOpsFunc)(); <span class="comment">// really returns UScriptStruct::ICppStructOps*</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>*                         NameUTF8;</span><br><span class="line">    <span class="type">const</span> FPropertyParamsBase* <span class="type">const</span>*   PropertyArray;</span><br><span class="line">    uint16                              NumProperties;</span><br><span class="line">    uint16                              SizeOf;</span><br><span class="line">    uint8                               AlignOf;</span><br><span class="line">    EObjectFlags                        ObjectFlags;</span><br><span class="line">    uint32                              StructFlags; <span class="comment">// EStructFlags</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_METADATA</span></span><br><span class="line">    uint16                              NumMetaData;</span><br><span class="line">    <span class="type">const</span> FMetaDataPairParam*           MetaDataArray;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>同个文件内的反射内容都会注册到这，这个文件只有 Struct。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Z_CompiledInDeferFile_FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Struct_MyStruct_h_Statics</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> FStructRegisterCompiledInInfo ScriptStructInfo[] = &#123;</span><br><span class="line">       &#123; FMyStruct::StaticStruct, Z_Construct_UScriptStruct_FMyStruct_Statics::NewStructOps,</span><br><span class="line">            <span class="built_in">TEXT</span>(<span class="string">&quot;MyStruct&quot;</span>), &amp;Z_Registration_Info_UScriptStruct_MyStruct,</span><br><span class="line">            <span class="built_in">CONSTRUCT_RELOAD_VERSION_INFO</span>(FStructReloadVersionInfo, <span class="built_in">sizeof</span>(FMyStruct), <span class="number">221546749U</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FStructRegisterCompiledInInfo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">UScriptStruct</span>* (*OuterRegister)();</span><br><span class="line">    <span class="type">void</span>* (*CreateCppStructOps)();</span><br><span class="line">    <span class="type">const</span> TCHAR* Name;</span><br><span class="line">    FStructRegistrationInfo* Info;</span><br><span class="line">    FStructReloadVersionInfo VersionInfo;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>注册参数。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> FRegisterCompiledInInfo <span class="title">Z_CompiledInDeferFile_FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Struct_MyStruct_h_1968461662</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    TEXT(<span class="string">&quot;/Script/Reflection&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="literal">nullptr</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="number">0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    Z_CompiledInDeferFile_FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Struct_MyStruct_h_Statics::ScriptStructInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    UE_ARRAY_COUNT(Z_CompiledInDeferFile_FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Struct_MyStruct_h_Statics::ScriptStructInfo),</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="literal">nullptr</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="number">0</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class</h3><p>Class 和 Struct 其实差不太多，但它支持成员方法，同时成员方法还支持给蓝图调用。下面只定义一个成员方法，但它支持参数和返回值。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">REFLECTION_API</span> UMyObject : <span class="keyword">public</span> UObject</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">UFUNCTION</span>()</span><br><span class="line">    <span class="function">int32 <span class="title">MyFunc</span><span class="params">(int32 i)</span> </span>&#123; <span class="keyword">return</span> i++; &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">UPROPERTY</span>()</span><br><span class="line">    int32 MyInt32 = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>GENERATED_BODY()</code> 生成出以下内容</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Object_MyObject_h_14_GENERATED_BODY \</span></span><br><span class="line"><span class="meta">public: \</span></span><br><span class="line"><span class="meta">    FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Object_MyObject_h_14_RPC_WRAPPERS_NO_PURE_DECLS \</span></span><br><span class="line"><span class="meta">    FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Object_MyObject_h_14_INCLASS_NO_PURE_DECLS \</span></span><br><span class="line"><span class="meta">    FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Object_MyObject_h_14_ENHANCED_CONSTRUCTORS \</span></span><br><span class="line"><span class="meta">private:</span></span><br></pre></td></tr></table></figure><p><code>RPC_WRAPPERS_NO_PURE_DECLS</code> 会生成 UFunction 方法的包装，为了让蓝图也能调用，其实就将参数和返回值改放到 <code>FFrame</code> 栈中。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DECLARE_FUNCTION(func) static void func( UObject* Context, FFrame&amp; Stack, RESULT_DECL )</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Object_MyObject_h_14_RPC_WRAPPERS_NO_PURE_DECLS \</span></span><br><span class="line"><span class="meta">    DECLARE_FUNCTION(execMyFunc);</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Object_MyObject_h_14_RPC_WRAPPERS_NO_PURE_DECLS \</span></span><br><span class="line"><span class="meta">    static void execMyFunc( UObject* Context, FFrame&amp; Stack, RESULT_DECL );</span></span><br></pre></td></tr></table></figure><p><code>INCLASS_NO_PURE_DECLS</code> 声明一些类的基础别名、序列化等。比如 <code>Super</code> 就是在这被设置为父类别名的。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Object_MyObject_h_14_INCLASS_NO_PURE_DECLS \</span></span><br><span class="line"><span class="meta">private: \</span></span><br><span class="line"><span class="meta">    static void StaticRegisterNativesUMyObject(); \</span></span><br><span class="line"><span class="meta">    friend struct Z_Construct_UClass_UMyObject_Statics; \</span></span><br><span class="line"><span class="meta">public: \</span></span><br><span class="line"><span class="meta">    DECLARE_CLASS(UMyObject, UObject, COMPILED_IN_FLAGS(0), CASTCLASS_None, TEXT(<span class="string">&quot;/Script/Reflection&quot;</span>), NO_API) \</span></span><br><span class="line"><span class="meta">    DECLARE_SERIALIZER(UMyObject)</span></span><br></pre></td></tr></table></figure><p><code>ENHANCED_CONSTRUCTORS</code> 从名字也能看出是提供多一些构造函数。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Object_MyObject_h_14_ENHANCED_CONSTRUCTORS \</span></span><br><span class="line"><span class="meta">    <span class="comment">/** Standard constructor, called after all reflected properties have been initialized */</span> \</span></span><br><span class="line"><span class="meta">    NO_API UMyObject(const FObjectInitializer&amp; ObjectInitializer = FObjectInitializer::Get()); \</span></span><br><span class="line"><span class="meta">private: \</span></span><br><span class="line"><span class="meta">    <span class="comment">/** Private move- and copy-constructors, should never be used */</span> \</span></span><br><span class="line"><span class="meta">    UMyObject(UMyObject&amp;&amp;); \</span></span><br><span class="line"><span class="meta">    UMyObject(const UMyObject&amp;); \</span></span><br><span class="line"><span class="meta">public: \</span></span><br><span class="line"><span class="meta">    DECLARE_VTABLE_PTR_HELPER_CTOR(NO_API, UMyObject); \</span></span><br><span class="line"><span class="meta">    DEFINE_VTABLE_PTR_HELPER_CTOR_CALLER(UMyObject); \</span></span><br><span class="line"><span class="meta">    DEFINE_DEFAULT_OBJECT_INITIALIZER_CONSTRUCTOR_CALL(UMyObject) \</span></span><br><span class="line"><span class="meta">    NO_API virtual ~UMyObject();</span></span><br></pre></td></tr></table></figure><p><code>GENERATED_BODY()</code> 将宏完整展开生成代码如下：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">REFLECTION_API</span> UMyObject : <span class="keyword">public</span> UObject</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">execMyFunc</span><span class="params">( UObject* Context, FFrame&amp; Stack, RESULT_DECL )</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">StaticRegisterNativesUMyObject</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">struct</span> <span class="title class_">Z_Construct_UClass_UMyObject_Statics</span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// DECLARE_CLASS(UMyObject, UObject, COMPILED_IN_FLAGS(0), CASTCLASS_None, TEXT(&quot;/Script/Reflection&quot;), NO_API)</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> EClassFlags StaticClassFlags = <span class="built_in">EClassFlags</span>((<span class="number">0</span> | CLASS_Intrinsic));</span><br><span class="line">    <span class="keyword">typedef</span> UObject Super;</span><br><span class="line">    <span class="keyword">typedef</span> UMyObject ThisClass;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">static</span> UClass* <span class="title">StaticClass</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">GetPrivateStaticClass</span>(); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">static</span> <span class="type">const</span> TCHAR* <span class="title">StaticPackage</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">L&quot;/ Script/ Reflection&quot;</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">static</span> EClassCastFlags <span class="title">StaticClassCastFlags</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> CASTCLASS_None; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="type">const</span> <span class="type">size_t</span> InSize, EInternal InInternalOnly,</span></span></span><br><span class="line"><span class="params"><span class="function">                                UObject* InOuter = (UObject*)GetTransientPackage(), FName InName = NAME_None,</span></span></span><br><span class="line"><span class="params"><span class="function">                                EObjectFlags InSetFlags = RF_NoFlags)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">StaticAllocateObject</span>(<span class="built_in">StaticClass</span>(), InOuter, InName, InSetFlags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="type">const</span> <span class="type">size_t</span> InSize, EInternal* InMem)</span> </span>&#123; <span class="keyword">return</span> (<span class="type">void</span>*)InMem; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="keyword">operator</span> <span class="title">delete</span><span class="params">(<span class="type">void</span>* InMem)</span> </span>&#123; ::<span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(InMem)</span></span>; &#125;</span><br><span class="line">    <span class="comment">// DECLARE_CLASS END</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// DECLARE_SERIALIZER(UMyObject)</span></span><br><span class="line">    <span class="keyword">friend</span> FArchive&amp; <span class="keyword">operator</span>&lt;&lt;(FArchive&amp; Ar, UMyObject*&amp; Res) &#123; <span class="keyword">return</span> Ar &lt;&lt; (UObject*&amp;)Res; &#125;</span><br><span class="line">    <span class="keyword">friend</span> <span class="type">void</span> <span class="keyword">operator</span>&lt;&lt;(FStructuredArchive::FSlot InSlot, UMyObject*&amp; Res) &#123; InSlot &lt;&lt; (UObject*&amp;)Res; &#125;</span><br><span class="line">    <span class="comment">// DECLARE_SERIALIZER END</span></span><br><span class="line"></span><br><span class="line">    <span class="function">NO_API <span class="title">UMyObject</span><span class="params">(<span class="type">const</span> FObjectInitializer&amp; ObjectInitializer = FObjectInitializer::Get())</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/** Private move- and copy-constructors, should never be used */</span></span><br><span class="line">    <span class="built_in">UMyObject</span>(UMyObject&amp;&amp;);</span><br><span class="line">    <span class="built_in">UMyObject</span>(<span class="type">const</span> UMyObject&amp;);</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 热更用的 跳过</span></span><br><span class="line">    <span class="built_in">DECLARE_VTABLE_PTR_HELPER_CTOR</span>(NO_API, UMyObject);</span><br><span class="line">    <span class="built_in">DEFINE_VTABLE_PTR_HELPER_CTOR_CALLER</span>(UMyObject);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// DEFINE_DEFAULT_OBJECT_INITIALIZER_CONSTRUCTOR_CALL(UMyObject)</span></span><br><span class="line">    <span class="type">static</span> <span class="type">void</span> __DefaultConstructor(<span class="type">const</span> FObjectInitializer&amp; X) &#123; <span class="keyword">new</span>((EInternal*)X.<span class="built_in">GetObj</span>())<span class="built_in">UMyObject</span>(X); &#125;</span><br><span class="line">    <span class="comment">// DEFINE_DEFAULT_OBJECT_INITIALIZER_CONSTRUCTOR_CALL END</span></span><br><span class="line"></span><br><span class="line">    NO_API <span class="keyword">virtual</span> ~<span class="built_in">UMyObject</span>();</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">int32 <span class="title">MyFunc</span><span class="params">(int32 i)</span> </span>&#123; <span class="keyword">return</span> i++; &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    int32 MyInt32 = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>gen.cpp</code> 前置声明。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EmptyLinkFunctionForGeneratedCodeMyObject</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">COREUOBJECT_API UClass* <span class="title">Z_Construct_UClass_UObject</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">REFLECTION_API UClass* <span class="title">Z_Construct_UClass_UMyObject</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">REFLECTION_API UClass* <span class="title">Z_Construct_UClass_UMyObject_NoRegister</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">UPackage* <span class="title">Z_Construct_UPackage__Script_Reflection</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><p>成员函数反射信息，为返回值和参数都构造属性。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Z_Construct_UFunction_UMyObject_MyFunc_Statics</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">MyObject_eventMyFunc_Parms</span></span><br><span class="line">    &#123;</span><br><span class="line">        int32 i;</span><br><span class="line">        int32 ReturnValue;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_METADATA</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> UECodeGen_Private::FMetaDataPairParam Function_MetaDataParams[] = &#123;</span><br><span class="line">        &#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;Public/Object/MyObject.h&quot;</span> &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// WITH_METADATA</span></span></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> UECodeGen_Private::FIntPropertyParams NewProp_i;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> UECodeGen_Private::FIntPropertyParams NewProp_ReturnValue;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> UECodeGen_Private::FPropertyParamsBase* <span class="type">const</span> PropPointers[];</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> UECodeGen_Private::FFunctionParams FuncParams;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">const</span> UECodeGen_Private::FIntPropertyParams Z_Construct_UFunction_UMyObject_MyFunc_Statics::NewProp_i = &#123; <span class="string">&quot;i&quot;</span>, <span class="literal">nullptr</span>, (EPropertyFlags)<span class="number">0x0010000000000080</span>, UECodeGen_Private::EPropertyGenFlags::Int, RF_Public|RF_Transient|RF_MarkAsNative, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="number">1</span>, <span class="built_in">STRUCT_OFFSET</span>(MyObject_eventMyFunc_Parms, i), <span class="built_in">METADATA_PARAMS</span>(<span class="number">0</span>, <span class="literal">nullptr</span>) &#125;;</span><br><span class="line"><span class="type">const</span> UECodeGen_Private::FIntPropertyParams Z_Construct_UFunction_UMyObject_MyFunc_Statics::NewProp_ReturnValue = &#123; <span class="string">&quot;ReturnValue&quot;</span>, <span class="literal">nullptr</span>, (EPropertyFlags)<span class="number">0x0010000000000580</span>, UECodeGen_Private::EPropertyGenFlags::Int, RF_Public|RF_Transient|RF_MarkAsNative, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="number">1</span>, <span class="built_in">STRUCT_OFFSET</span>(MyObject_eventMyFunc_Parms, ReturnValue), <span class="built_in">METADATA_PARAMS</span>(<span class="number">0</span>, <span class="literal">nullptr</span>) &#125;;</span><br><span class="line"><span class="type">const</span> UECodeGen_Private::FPropertyParamsBase* <span class="type">const</span> Z_Construct_UFunction_UMyObject_MyFunc_Statics::PropPointers[] = &#123;</span><br><span class="line">    (<span class="type">const</span> UECodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UFunction_UMyObject_MyFunc_Statics::NewProp_i,</span><br><span class="line">    (<span class="type">const</span> UECodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UFunction_UMyObject_MyFunc_Statics::NewProp_ReturnValue,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">static_assert</span>(<span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UFunction_UMyObject_MyFunc_Statics::PropPointers) &lt; <span class="number">2048</span>);</span><br><span class="line"><span class="type">const</span> UECodeGen_Private::FFunctionParams Z_Construct_UFunction_UMyObject_MyFunc_Statics::FuncParams = &#123; (UObject*(*)())Z_Construct_UClass_UMyObject, <span class="literal">nullptr</span>, <span class="string">&quot;MyFunc&quot;</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, Z_Construct_UFunction_UMyObject_MyFunc_Statics::PropPointers, <span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UFunction_UMyObject_MyFunc_Statics::PropPointers), <span class="built_in">sizeof</span>(Z_Construct_UFunction_UMyObject_MyFunc_Statics::MyObject_eventMyFunc_Parms), RF_Public|RF_Transient|RF_MarkAsNative, (EFunctionFlags)<span class="number">0x00020401</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="built_in">METADATA_PARAMS</span>(<span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UFunction_UMyObject_MyFunc_Statics::Function_MetaDataParams), Z_Construct_UFunction_UMyObject_MyFunc_Statics::Function_MetaDataParams) &#125;;</span><br><span class="line"><span class="built_in">static_assert</span>(<span class="built_in">sizeof</span>(Z_Construct_UFunction_UMyObject_MyFunc_Statics::MyObject_eventMyFunc_Parms) &lt; MAX_uint16);</span><br></pre></td></tr></table></figure><p>成员函数的构造方法</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UFunction* <span class="title">Z_Construct_UFunction_UMyObject_MyFunc</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> UFunction* ReturnFunction = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">if</span> (!ReturnFunction)</span><br><span class="line">    &#123;</span><br><span class="line">        UECodeGen_Private::<span class="built_in">ConstructUFunction</span>(&amp;ReturnFunction, Z_Construct_UFunction_UMyObject_MyFunc_Statics::FuncParams);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ReturnFunction;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>成员函数的 thunk 函数定义，里面 P 开头的是虚拟机的辅助宏。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> RESULT_PARAM Z_Param__Result</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RESULT_DECL void*const RESULT_PARAM</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMyObject::execMyFunc</span><span class="params">( UObject* Context, FFrame&amp; Stack, RESULT_DECL )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">P_GET_PROPERTY</span>(FIntProperty,Z_Param_i);</span><br><span class="line">    P_FINISH;</span><br><span class="line">    P_NATIVE_BEGIN;</span><br><span class="line">    *(int32*)Z_Param__Result=P_THIS-&gt;<span class="built_in">MyFunc</span>(Z_Param_i);</span><br><span class="line">    P_NATIVE_END;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注册成员函数和对应的 thunk 函数的绑定。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMyObject::StaticRegisterNativesUMyObject</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UClass* Class = UMyObject::<span class="built_in">StaticClass</span>();</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> FNameNativePtrPair Funcs[] = &#123;</span><br><span class="line">        &#123; <span class="string">&quot;MyFunc&quot;</span>, &amp;UMyObject::execMyFunc &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    FNativeFunctionRegistrar::<span class="built_in">RegisterFunctions</span>(Class, Funcs, <span class="built_in">UE_ARRAY_COUNT</span>(Funcs));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>GetPrivateStaticClass</code> 就是 <code>StaticClass</code> 也是 <code>InnerRegister</code> 。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IMPLEMENT_CLASS_NO_AUTO_REGISTRATION(UMyObject);</span></span><br><span class="line"><span class="function">UClass* <span class="title">UMyObject::GetPrivateStaticClass</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">if</span> (!Z_Registration_Info_UClass_UMyObject.InnerSingleton) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="comment">/* this could be handled with templates, but we want it external to avoid code bloat */</span> </span><br><span class="line">        <span class="built_in">GetPrivateStaticClassBody</span>( </span><br><span class="line">        <span class="built_in">StaticPackage</span>(), </span><br><span class="line">        (TCHAR*)<span class="built_in">TEXT</span>(<span class="string">&quot;UMyObject&quot;</span>) + <span class="number">1</span> + ((StaticClassFlags &amp; CLASS_Deprecated) ? <span class="number">11</span> : <span class="number">0</span>), </span><br><span class="line">        Z_Registration_Info_UClass_UMyObject.InnerSingleton, </span><br><span class="line">        StaticRegisterNativesUMyObject,</span><br><span class="line">        <span class="built_in">sizeof</span>(UMyObject), </span><br><span class="line">        <span class="built_in">alignof</span>(UMyObject), </span><br><span class="line">        UMyObject::StaticClassFlags, </span><br><span class="line">        UMyObject::<span class="built_in">StaticClassCastFlags</span>(), </span><br><span class="line">        UMyObject::<span class="built_in">StaticConfigName</span>(), </span><br><span class="line">        (UClass::ClassConstructorType)InternalConstructor&lt;UMyObject&gt;, </span><br><span class="line">        (UClass::ClassVTableHelperCtorCallerType)InternalVTableHelperCtorCaller&lt;UMyObject&gt;, </span><br><span class="line">        <span class="built_in">UOBJECT_CPPCLASS_STATICFUNCTIONS_FORCLASS</span>(UMyObject), </span><br><span class="line">        &amp;UMyObject::Super::StaticClass, </span><br><span class="line">        &amp;UMyObject::WithinClass::StaticClass </span><br><span class="line">        ); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> Z_Registration_Info_UClass_UMyObject.InnerSingleton; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UClass* <span class="title">Z_Construct_UClass_UMyObject_NoRegister</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> UMyObject::<span class="built_in">StaticClass</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>类的反射信息，包含成员变量和成员方法。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Z_Construct_UClass_UMyObject_Statics</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_METADATA</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> UECodeGen_Private::FMetaDataPairParam Class_MetaDataParams[] = &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !UE_BUILD_SHIPPING</span></span><br><span class="line">        &#123; <span class="string">&quot;Comment&quot;</span>, <span class="string">&quot;/**\n * \n */&quot;</span> &#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#123; <span class="string">&quot;IncludePath&quot;</span>, <span class="string">&quot;Object/MyObject.h&quot;</span> &#125;,</span><br><span class="line">        &#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;Public/Object/MyObject.h&quot;</span> &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> UECodeGen_Private::FMetaDataPairParam NewProp_MyInt32_MetaData[] = &#123;</span><br><span class="line">        &#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;Public/Object/MyObject.h&quot;</span> &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// WITH_METADATA</span></span></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> UECodeGen_Private::FIntPropertyParams NewProp_MyInt32;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> UECodeGen_Private::FPropertyParamsBase* <span class="type">const</span> PropPointers[];</span><br><span class="line">    <span class="type">static</span> UObject* (*<span class="type">const</span> DependentSingletons[])();</span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> FClassFunctionLinkInfo FuncInfo[] = &#123;</span><br><span class="line">        &#123; &amp;Z_Construct_UFunction_UMyObject_MyFunc, <span class="string">&quot;MyFunc&quot;</span> &#125;, <span class="comment">// 1049028917</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">static_assert</span>(<span class="built_in">UE_ARRAY_COUNT</span>(FuncInfo) &lt; <span class="number">2048</span>);</span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> FCppClassTypeInfoStatic StaticCppClassTypeInfo = &#123;</span><br><span class="line">        TCppClassTypeTraits&lt;UMyObject&gt;::IsAbstract,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> UECodeGen_Private::FClassParams ClassParams;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>成员变量反射信息</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> UECodeGen_Private::FIntPropertyParams Z_Construct_UClass_UMyObject_Statics::NewProp_MyInt32 = &#123; <span class="string">&quot;MyInt32&quot;</span>, <span class="literal">nullptr</span>, (EPropertyFlags)<span class="number">0x0040000000000000</span>, UECodeGen_Private::EPropertyGenFlags::Int, RF_Public|RF_Transient|RF_MarkAsNative, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="number">1</span>, <span class="built_in">STRUCT_OFFSET</span>(UMyObject, MyInt32), <span class="built_in">METADATA_PARAMS</span>(<span class="built_in">UE_ARRAY_COUNT</span>(NewProp_MyInt32_MetaData), NewProp_MyInt32_MetaData) &#125;;</span><br><span class="line"><span class="type">const</span> UECodeGen_Private::FPropertyParamsBase* <span class="type">const</span> Z_Construct_UClass_UMyObject_Statics::PropPointers[] = &#123;</span><br><span class="line">    (<span class="type">const</span> UECodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UClass_UMyObject_Statics::NewProp_MyInt32,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">static_assert</span>(<span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UClass_UMyObject_Statics::PropPointers) &lt; <span class="number">2048</span>);</span><br></pre></td></tr></table></figure><p>构造该 Class 的依赖项，至少要构造 UObject 因为是它子类，其次是 UPackage。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">UObject* (*<span class="type">const</span> Z_Construct_UClass_UMyObject_Statics::DependentSingletons[])() = &#123;</span><br><span class="line">    (UObject* (*)())Z_Construct_UClass_UObject,</span><br><span class="line">    (UObject* (*)())Z_Construct_UPackage__Script_Reflection,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">static_assert</span>(<span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UClass_UMyObject_Statics::DependentSingletons) &lt; <span class="number">16</span>);</span><br></pre></td></tr></table></figure><p>类的构造参数。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> UECodeGen_Private::FClassParams Z_Construct_UClass_UMyObject_Statics::ClassParams = &#123;</span><br><span class="line">    &amp;UMyObject::StaticClass,</span><br><span class="line">    <span class="literal">nullptr</span>, <span class="comment">// 配置类的文件名</span></span><br><span class="line">    &amp;StaticCppClassTypeInfo, <span class="comment">// 是抽象类吗</span></span><br><span class="line">    DependentSingletons, <span class="comment">// 依赖项</span></span><br><span class="line">    FuncInfo, <span class="comment">// 成员函数信息</span></span><br><span class="line">    Z_Construct_UClass_UMyObject_Statics::PropPointers, <span class="comment">// 成员变量</span></span><br><span class="line">    <span class="literal">nullptr</span>, <span class="comment">// 接口信息</span></span><br><span class="line">    <span class="built_in">UE_ARRAY_COUNT</span>(DependentSingletons),</span><br><span class="line">    <span class="built_in">UE_ARRAY_COUNT</span>(FuncInfo),</span><br><span class="line">    <span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UClass_UMyObject_Statics::PropPointers),</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="number">0x001000A0u</span>, <span class="comment">// CLASS_RequiredAPI | CLASS_Native | CLASS_MatchedSerializers</span></span><br><span class="line">    <span class="built_in">METADATA_PARAMS</span>(<span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UClass_UMyObject_Statics::Class_MetaDataParams), Z_Construct_UClass_UMyObject_Statics::Class_MetaDataParams)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FClassParams</span></span><br><span class="line">&#123;</span><br><span class="line">    UClass*                                   (*ClassNoRegisterFunc)();</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>*                                 ClassConfigNameUTF8;</span><br><span class="line">    <span class="type">const</span> FCppClassTypeInfoStatic*              CppClassInfo;</span><br><span class="line">    UObject*                           (*<span class="type">const</span> *DependencySingletonFuncArray)();</span><br><span class="line">    <span class="type">const</span> FClassFunctionLinkInfo*               FunctionLinkArray;</span><br><span class="line">    <span class="type">const</span> FPropertyParamsBase* <span class="type">const</span>*           PropertyArray;</span><br><span class="line">    <span class="type">const</span> FImplementedInterfaceParams*          ImplementedInterfaceArray;</span><br><span class="line">    uint32                                      NumDependencySingletons : <span class="number">4</span>;</span><br><span class="line">    uint32                                      NumFunctions : <span class="number">11</span>;</span><br><span class="line">    uint32                                      NumProperties : <span class="number">11</span>;</span><br><span class="line">    uint32                                      NumImplementedInterfaces : <span class="number">6</span>;</span><br><span class="line">    uint32                                      ClassFlags; <span class="comment">// EClassFlags</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_METADATA</span></span><br><span class="line">    uint16                                      NumMetaData;</span><br><span class="line">    <span class="type">const</span> FMetaDataPairParam*                   MetaDataArray;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>构造函数定义。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UMyObject::<span class="built_in">UMyObject</span>(<span class="type">const</span> FObjectInitializer&amp; ObjectInitializer) : <span class="built_in">Super</span>(ObjectInitializer) &#123;&#125;</span><br><span class="line"><span class="built_in">DEFINE_VTABLE_PTR_HELPER_CTOR</span>(UMyObject);</span><br><span class="line">UMyObject::~<span class="built_in">UMyObject</span>() &#123;&#125;</span><br></pre></td></tr></table></figure><p>真正构造该 Class 的地方。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UClass* <span class="title">Z_Construct_UClass_UMyObject</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!Z_Registration_Info_UClass_UMyObject.OuterSingleton)</span><br><span class="line">    &#123;</span><br><span class="line">        UECodeGen_Private::<span class="built_in">ConstructUClass</span>(Z_Registration_Info_UClass_UMyObject.OuterSingleton, Z_Construct_UClass_UMyObject_Statics::ClassParams);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Z_Registration_Info_UClass_UMyObject.OuterSingleton;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; REFLECTION_API UClass* <span class="built_in">StaticClass</span>&lt;UMyObject&gt;()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> UMyObject::<span class="built_in">StaticClass</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一样的，同一个文件的所有反射都会记录在这，这个文件只有一个类。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Z_CompiledInDeferFile_FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Object_MyObject_h_Statics</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> FClassRegisterCompiledInInfo ClassInfo[] = &#123;</span><br><span class="line">        &#123; Z_Construct_UClass_UMyObject,</span><br><span class="line">        UMyObject::StaticClass,</span><br><span class="line">        <span class="built_in">TEXT</span>(<span class="string">&quot;UMyObject&quot;</span>),</span><br><span class="line">        &amp;Z_Registration_Info_UClass_UMyObject,</span><br><span class="line">        <span class="built_in">CONSTRUCT_RELOAD_VERSION_INFO</span>(FClassReloadVersionInfo, <span class="built_in">sizeof</span>(UMyObject), <span class="number">1556497845U</span>)&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FClassRegisterCompiledInInfo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">UClass</span>* (*OuterRegister)();</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">UClass</span>* (*InnerRegister)();</span><br><span class="line">    <span class="type">const</span> TCHAR* Name;</span><br><span class="line">    FClassRegistrationInfo* Info;</span><br><span class="line">    FClassReloadVersionInfo VersionInfo;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>最终注册。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> FRegisterCompiledInInfo <span class="title">Z_CompiledInDeferFile_FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Object_MyObject_h_1505249514</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    TEXT(<span class="string">&quot;/Script/Reflection&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">    Z_CompiledInDeferFile_FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Object_MyObject_h_Statics::ClassInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    UE_ARRAY_COUNT(Z_CompiledInDeferFile_FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Object_MyObject_h_Statics::ClassInfo),</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="literal">nullptr</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="number">0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="literal">nullptr</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="number">0</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="Interface"><a href="#Interface" class="headerlink" title="Interface"></a>Interface</h3><p>先创建一个 Interface，并声明两个成员方法，两个方法皆能被蓝图和C++所调用，但其中一个只能被蓝图实现。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This class does not need to be modified.</span></span><br><span class="line"><span class="built_in">UINTERFACE</span>(MinimalAPI)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UMyInterface</span> : <span class="keyword">public</span> UInterface</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">GENERATED_BODY</span>()</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">REFLECTION_API</span> IMyInterface</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 仅能在蓝图实现</span></span><br><span class="line">    <span class="built_in">UFUNCTION</span>(BlueprintCallable, BlueprintImplementableEvent )</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">IBlueprintImplementableEvent</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 可在C++或蓝图实现</span></span><br><span class="line">    <span class="built_in">UFUNCTION</span>(BlueprintCallable, BlueprintNativeEvent)</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">IBlueprintNativeEvent</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>随后创建一个 Class 实现 该 Interface。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">REFLECTION_API</span> UMyInterfaceObj : <span class="keyword">public</span> UObject, <span class="keyword">public</span> IMyInterface</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">IBlueprintNativeEvent_Implementation</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>UMyInterface</code> 这个 UE 自动帮我们生成的 Class 可以跳过，因为和上面讲过得 Class 一样的逻辑。</p><p>而 <code>IMyInterface</code> 的 <code>GENERATED_BODY()</code> 最终会生成如下代码。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Interface_MyInterface_h_13_RPC_WRAPPERS_NO_PURE_DECLS \</span></span><br><span class="line"><span class="meta">    virtual void IBlueprintNativeEvent_Implementation() &#123;&#125;; \</span></span><br><span class="line"><span class="meta">    DECLARE_FUNCTION(execIBlueprintNativeEvent);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Interface_MyInterface_h_13_CALLBACK_WRAPPERS</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Interface_MyInterface_h_13_INCLASS_IINTERFACE_NO_PURE_DECLS \</span></span><br><span class="line"><span class="meta">protected: \</span></span><br><span class="line"><span class="meta">    virtual ~IMyInterface() &#123;&#125; \</span></span><br><span class="line"><span class="meta">public: \</span></span><br><span class="line"><span class="meta">    typedef UMyInterface UClassType; \</span></span><br><span class="line"><span class="meta">    typedef IMyInterface ThisClass; \</span></span><br><span class="line"><span class="meta">    static void Execute_IBlueprintImplementableEvent(UObject* O); \</span></span><br><span class="line"><span class="meta">    static void Execute_IBlueprintNativeEvent(UObject* O); \</span></span><br><span class="line"><span class="meta">    virtual UObject* _getUObject() const &#123; return nullptr; &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Interface_MyInterface_h_10_PROLOG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Interface_MyInterface_h_21_GENERATED_BODY \</span></span><br><span class="line"><span class="meta">public: \</span></span><br><span class="line"><span class="meta">    FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Interface_MyInterface_h_13_RPC_WRAPPERS_NO_PURE_DECLS \</span></span><br><span class="line"><span class="meta">    FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Interface_MyInterface_h_13_CALLBACK_WRAPPERS \</span></span><br><span class="line"><span class="meta">    FID_Users_yuerer_Desktop_reflection_Source_Reflection_Public_Interface_MyInterface_h_13_INCLASS_IINTERFACE_NO_PURE_DECLS \</span></span><br><span class="line"><span class="meta">private:</span></span><br></pre></td></tr></table></figure><p>将其展开后得到：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">REFLECTION_API</span> IMyInterface</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 供 C++ 实现该接口</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">IBlueprintNativeEvent_Implementation</span><span class="params">()</span> </span>&#123;&#125;;</span><br><span class="line">    <span class="comment">// 供蓝图 调用 C++ 接口, 因为 BlueprintNativeEvent 可以在 C++ 中实现</span></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">execIBlueprintNativeEvent</span><span class="params">( UObject* Context, FFrame&amp; Stack, RESULT_DECL )</span></span>;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">IMyInterface</span>() &#123;&#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">typedef</span> UMyInterface UClassType;</span><br><span class="line">    <span class="keyword">typedef</span> IMyInterface ThisClass;</span><br><span class="line">    <span class="comment">// 供 C++ 调用 蓝图接口, 这里的 UObject 就是 UMyInterface</span></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Execute_IBlueprintImplementableEvent</span><span class="params">(UObject* O)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Execute_IBlueprintNativeEvent</span><span class="params">(UObject* O)</span></span>;</span><br><span class="line">    <span class="keyword">virtual</span> UObject* _getUObject() <span class="type">const</span> &#123; <span class="keyword">return</span> <span class="literal">nullptr</span>; &#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">IBlueprintImplementableEvent</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">IBlueprintNativeEvent</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>gen.cpp</code> 中的内容如下：</p><p>先是 <code>IBlueprintImplementableEvent</code> 相关的反射内容。</p><p><code>BlueprintImplement</code> 的接口 默认生成一个检测函数，避免C++直接调用原来的函数，因为无论是C++还是蓝图调用的接口都是被改名过的 thunk 函数。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">IMyInterface::IBlueprintImplementableEvent</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">check</span>(<span class="number">0</span> &amp;&amp; <span class="string">&quot;Do not directly call Event functions in Interfaces. Call Execute_IBlueprintImplementableEvent instead.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但需要让C++能够调用到蓝图实现的接口。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> FName NAME_UMyInterface_IBlueprintImplementableEvent = <span class="built_in">FName</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;IBlueprintImplementableEvent&quot;</span>));</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IMyInterface::Execute_IBlueprintImplementableEvent</span><span class="params">(UObject* O)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">check</span>(O != <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">check</span>(O-&gt;<span class="built_in">GetClass</span>()-&gt;<span class="built_in">ImplementsInterface</span>(UMyInterface::<span class="built_in">StaticClass</span>()));</span><br><span class="line">    UFunction* <span class="type">const</span> Func = O-&gt;<span class="built_in">FindFunction</span>(NAME_UMyInterface_IBlueprintImplementableEvent);</span><br><span class="line">    <span class="keyword">if</span> (Func)</span><br><span class="line">    &#123;</span><br><span class="line">        O-&gt;<span class="built_in">ProcessEvent</span>(Func, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构造 <code>IBlueprintImplementableEvent</code> 这个 UFunction 。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> UECodeGen_Private::FFunctionParams Z_Construct_UFunction_UMyInterface_IBlueprintImplementableEvent_Statics::FuncParams = &#123; (UObject*(*)())Z_Construct_UClass_UMyInterface, <span class="literal">nullptr</span>, <span class="string">&quot;IBlueprintImplementableEvent&quot;</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="number">0</span>, <span class="number">0</span>, RF_Public|RF_Transient|RF_MarkAsNative, (EFunctionFlags)<span class="number">0x0C020800</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="built_in">METADATA_PARAMS</span>(<span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UFunction_UMyInterface_IBlueprintImplementableEvent_Statics::Function_MetaDataParams), Z_Construct_UFunction_UMyInterface_IBlueprintImplementableEvent_Statics::Function_MetaDataParams) &#125;;</span><br><span class="line"><span class="function">UFunction* <span class="title">Z_Construct_UFunction_UMyInterface_IBlueprintImplementableEvent</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> UFunction* ReturnFunction = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">if</span> (!ReturnFunction)</span><br><span class="line">    &#123;</span><br><span class="line">        UECodeGen_Private::<span class="built_in">ConstructUFunction</span>(&amp;ReturnFunction, Z_Construct_UFunction_UMyInterface_IBlueprintImplementableEvent_Statics::FuncParams);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ReturnFunction;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>另一个接口 <code>IBlueprintNativeEvent</code> ，同样需要避免被直接调用。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">IMyInterface::IBlueprintNativeEvent</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">check</span>(<span class="number">0</span> &amp;&amp; <span class="string">&quot;Do not directly call Event functions in Interfaces. Call Execute_IBlueprintNativeEvent instead.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>既可以被蓝图实现，也能被C++实现，所以都要判断一下，不过可以看出如果蓝图有实现，优先用蓝图的实现。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> FName NAME_UMyInterface_IBlueprintNativeEvent = <span class="built_in">FName</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;IBlueprintNativeEvent&quot;</span>));</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IMyInterface::Execute_IBlueprintNativeEvent</span><span class="params">(UObject* O)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">check</span>(O != <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">check</span>(O-&gt;<span class="built_in">GetClass</span>()-&gt;<span class="built_in">ImplementsInterface</span>(UMyInterface::<span class="built_in">StaticClass</span>()));</span><br><span class="line">    UFunction* <span class="type">const</span> Func = O-&gt;<span class="built_in">FindFunction</span>(NAME_UMyInterface_IBlueprintNativeEvent);</span><br><span class="line">    <span class="keyword">if</span> (Func)</span><br><span class="line">    &#123;</span><br><span class="line">        O-&gt;<span class="built_in">ProcessEvent</span>(Func, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">auto</span> I = (IMyInterface*)(O-&gt;<span class="built_in">GetNativeInterfaceAddress</span>(UMyInterface::<span class="built_in">StaticClass</span>())))</span><br><span class="line">    &#123;</span><br><span class="line">        I-&gt;<span class="built_in">IBlueprintNativeEvent_Implementation</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构造该 UFunction 的辅助函数。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UFunction* <span class="title">Z_Construct_UFunction_UMyInterface_IBlueprintNativeEvent</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> UFunction* ReturnFunction = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">if</span> (!ReturnFunction)</span><br><span class="line">    &#123;</span><br><span class="line">        UECodeGen_Private::<span class="built_in">ConstructUFunction</span>(&amp;ReturnFunction, Z_Construct_UFunction_UMyInterface_IBlueprintNativeEvent_Statics::FuncParams);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ReturnFunction;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后由于这个接口可以被蓝图调用，需要提供一个蓝图调用接口。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">IMyInterface::execInterfaceBlueprintNativeEvent</span><span class="params">( UObject* Context, FFrame&amp; Stack, RESULT_DECL )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    P_FINISH;</span><br><span class="line">    P_NATIVE_BEGIN;</span><br><span class="line">    P_THIS-&gt;<span class="built_in">IBlueprintNativeEvent_Implementation</span>();</span><br><span class="line">    P_NATIVE_END;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后则是将C++可实现的接口注册到 <code>UMyInterface</code> 这个UE自动帮我们生成的 Object 中，这也就解释了为什么 Interface 需要生成一个 Object。</p><h2 id="反射代码注册"><a href="#反射代码注册" class="headerlink" title="反射代码注册"></a>反射代码注册</h2><p>在每个 <code>gen.cpp</code> 文件下都使用了一个 <code>FRegisterCompiledInInfo</code> struct，反射代码的注册都是通过这个结构体的构造函数进行。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">FRegisterCompiledInInfo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> ... Args&gt;</span><br><span class="line">    <span class="built_in">FRegisterCompiledInInfo</span>(Args&amp;&amp; ... args)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">RegisterCompiledInInfo</span>(std::forward&lt;Args&gt;(args)...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>每个文件最终都会进入这一统一的注册入口，然后将文件中的 <code>Class</code> <code>Stuct</code> <code>Enum</code> 分别注册进去。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">RegisterCompiledInInfo</span><span class="params">(<span class="type">const</span> TCHAR* PackageName, <span class="type">const</span> FClassRegisterCompiledInInfo* ClassInfo, <span class="type">size_t</span> NumClassInfo, <span class="type">const</span> FStructRegisterCompiledInInfo* StructInfo, <span class="type">size_t</span> NumStructInfo, <span class="type">const</span> FEnumRegisterCompiledInInfo* EnumInfo, <span class="type">size_t</span> NumEnumInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> Index = <span class="number">0</span>; Index &lt; NumClassInfo; ++Index)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> FClassRegisterCompiledInInfo&amp; Info = ClassInfo[Index];</span><br><span class="line">        <span class="built_in">RegisterCompiledInInfo</span>(Info.OuterRegister, Info.InnerRegister, PackageName, Info.Name, *Info.Info, Info.VersionInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> Index = <span class="number">0</span>; Index &lt; NumStructInfo; ++Index)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> FStructRegisterCompiledInInfo&amp; Info = StructInfo[Index];</span><br><span class="line">        <span class="built_in">RegisterCompiledInInfo</span>(Info.OuterRegister, PackageName, Info.Name, *Info.Info, Info.VersionInfo);</span><br><span class="line">        <span class="keyword">if</span> (Info.CreateCppStructOps != <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            UScriptStruct::<span class="built_in">DeferCppStructOps</span>(<span class="built_in">FTopLevelAssetPath</span>(<span class="built_in">FName</span>(PackageName), <span class="built_in">FName</span>(Info.Name)), (UScriptStruct::ICppStructOps*)Info.<span class="built_in">CreateCppStructOps</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> Index = <span class="number">0</span>; Index &lt; NumEnumInfo; ++Index)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> FEnumRegisterCompiledInInfo&amp; Info = EnumInfo[Index];</span><br><span class="line">        <span class="built_in">RegisterCompiledInInfo</span>(Info.OuterRegister, PackageName, Info.Name, *Info.Info, Info.VersionInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Class</code> 版本的 RegisterCompiledInInfo：</p><p>大致就是将其加入到 <code>FClassDeferredRegistry</code> 列表中，同时发起一个事件记录这个 Class 和 这个Class 的 CDO 已添加，后续用来检查有哪些数据是未完成注册用的，后面不再强调了。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">RegisterCompiledInInfo</span><span class="params">(<span class="keyword">class</span> UClass* (*InOuterRegister)(), <span class="keyword">class</span> UClass* (*InInnerRegister)(), <span class="type">const</span> TCHAR* InPackageName, <span class="type">const</span> TCHAR* InName, FClassRegistrationInfo&amp; InInfo, <span class="type">const</span> FClassReloadVersionInfo&amp; InVersionInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FClassDeferredRegistry::AddResult result = FClassDeferredRegistry::<span class="built_in">Get</span>().<span class="built_in">AddRegistration</span>(InOuterRegister, InInnerRegister, InPackageName, InName, InInfo, InVersionInfo);</span><br><span class="line"></span><br><span class="line">    <span class="function">FString <span class="title">NoPrefix</span><span class="params">(UObjectBase::RemoveClassPrefix(InName))</span></span>;</span><br><span class="line">    <span class="built_in">NotifyRegistrationEvent</span>(InPackageName, *NoPrefix, ENotifyRegistrationType::NRT_Class, ENotifyRegistrationPhase::NRP_Added, (UObject * (*)())(InOuterRegister), <span class="literal">false</span>);</span><br><span class="line">    <span class="built_in">NotifyRegistrationEvent</span>(InPackageName, *(<span class="built_in">FString</span>(DEFAULT_OBJECT_PREFIX) + NoPrefix), ENotifyRegistrationType::NRT_ClassCDO, ENotifyRegistrationPhase::NRP_Added, (UObject * (*)())(InOuterRegister), <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Struct</code> 版本同理，记录到 <code>FStructDeferredRegistry</code> 中。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">RegisterCompiledInInfo</span><span class="params">(<span class="keyword">class</span> UScriptStruct* (*InOuterRegister)(), <span class="type">const</span> TCHAR* InPackageName, <span class="type">const</span> TCHAR* InName, FStructRegistrationInfo&amp; InInfo, <span class="type">const</span> FStructReloadVersionInfo&amp; InVersionInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FStructDeferredRegistry::<span class="built_in">Get</span>().<span class="built_in">AddRegistration</span>(InOuterRegister, <span class="literal">nullptr</span>, InPackageName, InName, InInfo, InVersionInfo);</span><br><span class="line">    <span class="built_in">NotifyRegistrationEvent</span>(InPackageName, InName, ENotifyRegistrationType::NRT_Struct, ENotifyRegistrationPhase::NRP_Added, (UObject * (*)())(InOuterRegister), <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Enum</code> 同理。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">RegisterCompiledInInfo</span><span class="params">(<span class="keyword">class</span> UEnum* (*InOuterRegister)(), <span class="type">const</span> TCHAR* InPackageName, <span class="type">const</span> TCHAR* InName, FEnumRegistrationInfo&amp; InInfo, <span class="type">const</span> FEnumReloadVersionInfo&amp; InVersionInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FEnumDeferredRegistry::<span class="built_in">Get</span>().<span class="built_in">AddRegistration</span>(InOuterRegister, <span class="literal">nullptr</span>, InPackageName, InName, InInfo, InVersionInfo);</span><br><span class="line">    <span class="built_in">NotifyRegistrationEvent</span>(InPackageName, InName, ENotifyRegistrationType::NRT_Enum, ENotifyRegistrationPhase::NRP_Added, (UObject * (*)())(InOuterRegister), <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这些反射数据采集完成后，会在引擎初始化时，调用 <code>ProcessNewlyLoadedUObjects</code> 方法。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ProcessNewlyLoadedUObjects</span><span class="params">(FName Package, <span class="type">bool</span> bCanProcessNewlyLoadedObjects)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FPackageDeferredRegistry&amp; PackageRegistry = FPackageDeferredRegistry::<span class="built_in">Get</span>();</span><br><span class="line">    FClassDeferredRegistry&amp; ClassRegistry = FClassDeferredRegistry::<span class="built_in">Get</span>();</span><br><span class="line">    FStructDeferredRegistry&amp; StructRegistry = FStructDeferredRegistry::<span class="built_in">Get</span>();</span><br><span class="line">    FEnumDeferredRegistry&amp; EnumRegistry = FEnumDeferredRegistry::<span class="built_in">Get</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UClassRegisterAllCompiledInClasses</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将所有的 Class 都进行注册，此处使用的 <code>InnerRegister</code> 。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UClassRegisterAllCompiledInClasses</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FClassDeferredRegistry&amp; Registry = FClassDeferredRegistry::<span class="built_in">Get</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> FClassDeferredRegistry::FRegistrant&amp; Registrant : Registry.<span class="built_in">GetRegistrations</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        UClass* RegisteredClass = FClassDeferredRegistry::<span class="built_in">InnerRegister</span>(Registrant);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> FClassRegisterCompiledInInfo ClassInfo[] = &#123;</span><br><span class="line">    &#123; Z_Construct_UClass_UMyObject, <span class="comment">// Outer</span></span><br><span class="line">    UMyObject::StaticClass, <span class="comment">// Inner</span></span><br><span class="line">    <span class="built_in">TEXT</span>(<span class="string">&quot;UMyObject&quot;</span>),</span><br><span class="line">    &amp;Z_Registration_Info_UClass_UMyObject,</span><br><span class="line">    <span class="built_in">CONSTRUCT_RELOAD_VERSION_INFO</span>(FClassReloadVersionInfo, <span class="built_in">sizeof</span>(UMyObject), <span class="number">1556497845U</span>)&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>此时调用 <code>InnerRegister</code> 本质就是调用 <code>UMyObject::StaticClass</code> ，最终调用的<code>GetPrivateStaticClass</code> 。</p><p>使用 <code>GUObjectAllocator</code> 分配内存，并使用 placement new 构造出该 Class，并设置属性。</p><p><code>InitializePrivateStaticClass</code> 会调用 <code>Register</code> 将 Class 注册到 <code>GFirstPendingRegistrant</code> 链表中，这主要是为了之后能够保证每个 <code>Object</code> 都能被加入到一张全局的 Globals Table，最后注册 thunk 函数。这就把 Class Object 给构造出来了。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">GetPrivateStaticClassBody</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="type">const</span> TCHAR* PackageName,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="type">const</span> TCHAR* Name,</span></span></span><br><span class="line"><span class="params"><span class="function">	UClass*&amp; ReturnClass,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="type">void</span>(*RegisterNativeFunc)(),</span></span></span><br><span class="line"><span class="params"><span class="function">	uint32 InSize,</span></span></span><br><span class="line"><span class="params"><span class="function">	uint32 InAlignment,</span></span></span><br><span class="line"><span class="params"><span class="function">	EClassFlags InClassFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">	EClassCastFlags InClassCastFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="type">const</span> TCHAR* InConfigName,</span></span></span><br><span class="line"><span class="params"><span class="function">	UClass::ClassConstructorType InClassConstructor,</span></span></span><br><span class="line"><span class="params"><span class="function">	UClass::ClassVTableHelperCtorCallerType InClassVTableHelperCtorCaller,</span></span></span><br><span class="line"><span class="params"><span class="function">	FUObjectCppClassStaticFunctions&amp;&amp; InCppClassStaticFunctions,</span></span></span><br><span class="line"><span class="params"><span class="function">	UClass::StaticClassFunctionType InSuperClassFn,</span></span></span><br><span class="line"><span class="params"><span class="function">	UClass::StaticClassFunctionType InWithinClassFn</span></span></span><br><span class="line"><span class="params"><span class="function">	)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ReturnClass = (UClass*)GUObjectAllocator.<span class="built_in">AllocateUObject</span>(<span class="built_in">sizeof</span>(UClass), <span class="built_in">alignof</span>(UClass), <span class="literal">true</span>);</span><br><span class="line">    ReturnClass = ::<span class="built_in">new</span> (ReturnClass)</span><br><span class="line">        <span class="built_in">UClass</span></span><br><span class="line">        (</span><br><span class="line">        EC_StaticConstructor,</span><br><span class="line">        Name,</span><br><span class="line">        InSize,</span><br><span class="line">        InAlignment,</span><br><span class="line">        InClassFlags,</span><br><span class="line">        InClassCastFlags,</span><br><span class="line">        InConfigName,</span><br><span class="line">        <span class="built_in">EObjectFlags</span>(RF_Public | RF_Standalone | RF_Transient | RF_MarkAsNative | RF_MarkAsRootSet),</span><br><span class="line">        InClassConstructor,</span><br><span class="line">        InClassVTableHelperCtorCaller,</span><br><span class="line">        <span class="built_in">MoveTemp</span>(InCppClassStaticFunctions)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">InitializePrivateStaticClass</span>(</span><br><span class="line">        <span class="built_in">InSuperClassFn</span>(),</span><br><span class="line">        ReturnClass,</span><br><span class="line">        <span class="built_in">InWithinClassFn</span>(),</span><br><span class="line">        PackageName,</span><br><span class="line">        Name</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register the class&#x27;s native functions.</span></span><br><span class="line">    <span class="built_in">RegisterNativeFunc</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在本文中注册的是 <code>MyFunc</code> ，因为它需要被蓝图调用。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMyObject::StaticRegisterNativesUMyObject</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UClass* Class = UMyObject::<span class="built_in">StaticClass</span>();</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> FNameNativePtrPair Funcs[] = &#123;</span><br><span class="line">        &#123; <span class="string">&quot;MyFunc&quot;</span>, &amp;UMyObject::execMyFunc &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    FNativeFunctionRegistrar::<span class="built_in">RegisterFunctions</span>(Class, Funcs, <span class="built_in">UE_ARRAY_COUNT</span>(Funcs));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>回到 <code>ProcessNewlyLoadedUObjects</code> 中， <code>UObjectProcessRegistrants</code> 就是将之前放入链表的 <code>Object</code> 取出来并放入一张全局的 Objects Table，同时还会将该 <code>Class</code> 所属的 <code>Package</code> 提前创建好，但不初始化，这点尤为重要。这段逻辑在 <code>UObjectBase::DeferredRegister</code> 。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ProcessNewlyLoadedUObjects</span><span class="params">(FName Package, <span class="type">bool</span> bCanProcessNewlyLoadedObjects)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="built_in">UClassRegisterAllCompiledInClasses</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> bNewUObjects = <span class="literal">false</span>;</span><br><span class="line">    TArray&lt;UClass*&gt; AllNewClasses;</span><br><span class="line">    <span class="keyword">while</span> (GFirstPendingRegistrant ||</span><br><span class="line">        ClassRegistry.<span class="built_in">HasPendingRegistrations</span>() ||</span><br><span class="line">        StructRegistry.<span class="built_in">HasPendingRegistrations</span>() ||</span><br><span class="line">        EnumRegistry.<span class="built_in">HasPendingRegistrations</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        bNewUObjects = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">UObjectProcessRegistrants</span>();</span><br><span class="line">        <span class="built_in">UObjectLoadAllCompiledInStructs</span>();</span><br><span class="line"></span><br><span class="line">        FCoreUObjectDelegates::CompiledInUObjectsRegisteredDelegate.<span class="built_in">Broadcast</span>(Package);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">UObjectLoadAllCompiledInDefaultProperties</span>(AllNewClasses);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>DoPendingPackageRegistrations</code> 其实就会提前创建好 Package，和 Class 一样，提前创建好，但不初始化。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">UObjectLoadAllCompiledInStructs</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FEnumDeferredRegistry&amp; EnumRegistry = FEnumDeferredRegistry::<span class="built_in">Get</span>();</span><br><span class="line">    FStructDeferredRegistry&amp; StructRegistry = FStructDeferredRegistry::<span class="built_in">Get</span>();</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;UObjectLoadAllCompiledInStructs -  CreatePackages (could be optimized!)&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建 Package</span></span><br><span class="line">        EnumRegistry.<span class="built_in">DoPendingPackageRegistrations</span>();</span><br><span class="line">        StructRegistry.<span class="built_in">DoPendingPackageRegistrations</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Load Structs</span></span><br><span class="line">    EnumRegistry.<span class="built_in">DoPendingOuterRegistrations</span>(<span class="literal">true</span>);</span><br><span class="line">    StructRegistry.<span class="built_in">DoPendingOuterRegistrations</span>(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后调用 <code>Enum</code> 和 <code>Struct</code> 的 OuterRegister。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">DoPendingOuterRegistrations</span><span class="params">(<span class="type">bool</span> UpdateCounter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    int32 Num = Registrations.<span class="built_in">Num</span>();</span><br><span class="line">    <span class="keyword">for</span> (int32 Index = ProcessedRegistrations; Index &lt; Num; ++Index)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">OuterRegister</span>(Registrations[Index]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (UpdateCounter)</span><br><span class="line">    &#123;</span><br><span class="line">        ProcessedRegistrations = Num;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这把 OuterRegister 取出来，方便阅读，无论是调用 <code>GetStaticEnum</code> 还是 <code>GetStaticStruct</code> 最后都是调用 <code>InnerRegister</code> ，但此处需要注意在这我们将 <code>UPackage</code> 给初始化了， <code>UPackage</code> 一定是先创建好 但不初始化，等到此处才初始化 <code>UPackage</code> 然后调用内部的 <code>InnerRegister</code> 将其构造出来。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> UEnum* <span class="title">EMyEnumClass_StaticEnum</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!Z_Registration_Info_UEnum_EMyEnumClass.OuterSingleton)</span><br><span class="line">    &#123;</span><br><span class="line">        Z_Registration_Info_UEnum_EMyEnumClass.OuterSingleton = <span class="built_in">GetStaticEnum</span>(</span><br><span class="line">            Z_Construct_UEnum_Reflection_EMyEnumClass,</span><br><span class="line">            (UObject*)<span class="built_in">Z_Construct_UPackage__Script_Reflection</span>(),</span><br><span class="line">            <span class="built_in">TEXT</span>(<span class="string">&quot;EMyEnumClass&quot;</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Z_Registration_Info_UEnum_EMyEnumClass.OuterSingleton;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">class</span> UScriptStruct* <span class="title">FMyStruct::StaticStruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!Z_Registration_Info_UScriptStruct_MyStruct.OuterSingleton)</span><br><span class="line">    &#123;</span><br><span class="line">        Z_Registration_Info_UScriptStruct_MyStruct.OuterSingleton = <span class="built_in">GetStaticStruct</span>(</span><br><span class="line">            Z_Construct_UScriptStruct_FMyStruct,</span><br><span class="line">            (UObject*)<span class="built_in">Z_Construct_UPackage__Script_Reflection</span>(),</span><br><span class="line">            <span class="built_in">TEXT</span>(<span class="string">&quot;MyStruct&quot;</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Z_Registration_Info_UScriptStruct_MyStruct.OuterSingleton;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构造 <code>UEnum</code> ，调用 <code>SetEnums</code> 时会默认帮你加一个 <code>_MAX</code> 枚举项，同时将枚举注册到对应 <code>PackageName</code> 的 map 中。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ConstructUEnum</span><span class="params">(UEnum*&amp; OutEnum, <span class="type">const</span> FEnumParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UObject* (*OuterFunc)() = Params.OuterFunc;</span><br><span class="line"></span><br><span class="line">    UObject* Outer = OuterFunc ? <span class="built_in">OuterFunc</span>() : <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (OutEnum)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UEnum* NewEnum = <span class="built_in">new</span> (EC_InternalUseOnlyConstructor, Outer, <span class="built_in">UTF8_TO_TCHAR</span>(Params.NameUTF8), Params.ObjectFlags) <span class="built_in">UEnum</span>(<span class="built_in">FObjectInitializer</span>());</span><br><span class="line">    OutEnum = NewEnum;</span><br><span class="line"></span><br><span class="line">    TArray&lt;TPair&lt;FName, int64&gt;&gt; EnumNames;</span><br><span class="line">    EnumNames.<span class="built_in">Reserve</span>(Params.NumEnumerators);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> FEnumeratorParam* Enumerator = Params.EnumeratorParams, *EnumeratorEnd = Enumerator + Params.NumEnumerators; Enumerator != EnumeratorEnd; ++Enumerator)</span><br><span class="line">    &#123;</span><br><span class="line">        EnumNames.<span class="built_in">Emplace</span>(<span class="built_in">UTF8_TO_TCHAR</span>(Enumerator-&gt;NameUTF8), Enumerator-&gt;Value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">bool</span> bAddMaxKeyIfMissing = <span class="literal">true</span>;</span><br><span class="line">    NewEnum-&gt;<span class="built_in">SetEnums</span>(EnumNames, (UEnum::ECppForm)Params.CppForm, Params.EnumFlags, bAddMaxKeyIfMissing);</span><br><span class="line">    NewEnum-&gt;CppType = <span class="built_in">UTF8_TO_TCHAR</span>(Params.CppTypeUTF8);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Params.DisplayNameFunc)</span><br><span class="line">    &#123;</span><br><span class="line">        NewEnum-&gt;<span class="built_in">SetEnumDisplayNameFn</span>(Params.DisplayNameFunc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构造 <code>Struct</code> ， <code>ConstructFProperties</code> 构造里面的属性，属性没有数据，只有函数，属性的数据最终还是存放到 <code>Struct</code> 或者 <code>Class</code> 中，属性里面会记录数据存放的偏移值，计算偏移值的操作在 <code>StaticLink</code> 中实现，同时还会将 Property分类放到不同链表中，比如需要析构的 Property，需要构造后做一些事情的 Property(Config) 。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ConstructUScriptStruct</span><span class="params">(UScriptStruct*&amp; OutStruct, <span class="type">const</span> FStructParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UObject*                      (*OuterFunc)()     = Params.OuterFunc;</span><br><span class="line">    UScriptStruct*                (*SuperFunc)()     = Params.SuperFunc;</span><br><span class="line">    UScriptStruct::ICppStructOps* (*StructOpsFunc)() = (UScriptStruct::ICppStructOps* (*)())Params.StructOpsFunc;</span><br><span class="line"></span><br><span class="line">    UObject*                      Outer     = OuterFunc     ? <span class="built_in">OuterFunc</span>() : <span class="literal">nullptr</span>;</span><br><span class="line">    UScriptStruct*                Super     = SuperFunc     ? <span class="built_in">SuperFunc</span>() : <span class="literal">nullptr</span>;</span><br><span class="line">    UScriptStruct::ICppStructOps* StructOps = StructOpsFunc ? <span class="built_in">StructOpsFunc</span>() : <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (OutStruct)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UScriptStruct* NewStruct = <span class="built_in">new</span>(EC_InternalUseOnlyConstructor, Outer, <span class="built_in">UTF8_TO_TCHAR</span>(Params.NameUTF8), Params.ObjectFlags) <span class="built_in">UScriptStruct</span>(<span class="built_in">FObjectInitializer</span>(), Super, StructOps, (EStructFlags)Params.StructFlags, Params.SizeOf, Params.AlignOf);</span><br><span class="line">    OutStruct = NewStruct;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ConstructFProperties</span>(NewStruct, Params.PropertyArray, Params.NumProperties);</span><br><span class="line"></span><br><span class="line">    NewStruct-&gt;<span class="built_in">StaticLink</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>回到 <code>ProcessNewlyLoadedUObjects</code> 函数中，<code>UObjectLoadAllCompiledInDefaultProperties</code> 是最后一个重点函数，它执行了所有 Class 的 OuterRegister，同时通知该 Class 注册完成。</p><p><code>DoPendingOuterRegistrations</code> 就是执行了 OuterRegister。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">UObjectLoadAllCompiledInDefaultProperties</span><span class="params">(TArray&lt;UClass*&gt;&amp; OutAllNewClasses)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function"><span class="type">static</span> FName <span class="title">LongEnginePackageName</span><span class="params">(TEXT(<span class="string">&quot;/Script/Engine&quot;</span>))</span></span>;</span><br><span class="line"></span><br><span class="line">    FClassDeferredRegistry&amp; ClassRegistry = FClassDeferredRegistry::<span class="built_in">Get</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ClassRegistry.<span class="built_in">HasPendingRegistrations</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;UObjectLoadAllCompiledInDefaultProperties&quot;</span>);</span><br><span class="line">        TArray&lt;UClass*&gt; NewClasses;</span><br><span class="line">        TArray&lt;UClass*&gt; NewClassesInCoreUObject;</span><br><span class="line">        TArray&lt;UClass*&gt; NewClassesInEngine;</span><br><span class="line">        ClassRegistry.<span class="built_in">DoPendingOuterRegistrations</span>(<span class="literal">true</span>, [&amp;OutAllNewClasses, &amp;NewClasses, &amp;NewClassesInCoreUObject, &amp;NewClassesInEngine](<span class="type">const</span> TCHAR* PackageName, UClass&amp; Class) -&gt; <span class="type">void</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">UE_LOG</span>(LogUObjectBootstrap, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;UObjectLoadAllCompiledInDefaultProperties After Registrant %s %s&quot;</span>), PackageName, *Class.<span class="built_in">GetName</span>());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (Class.<span class="built_in">GetOutermost</span>()-&gt;<span class="built_in">GetFName</span>() == GLongCoreUObjectPackageName)</span><br><span class="line">                &#123;</span><br><span class="line">                    NewClassesInCoreUObject.<span class="built_in">Add</span>(&amp;Class);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (Class.<span class="built_in">GetOutermost</span>()-&gt;<span class="built_in">GetFName</span>() == LongEnginePackageName)</span><br><span class="line">                &#123;</span><br><span class="line">                    NewClassesInEngine.<span class="built_in">Add</span>(&amp;Class);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    NewClasses.<span class="built_in">Add</span>(&amp;Class);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                OutAllNewClasses.<span class="built_in">Add</span>(&amp;Class);</span><br><span class="line">            &#125;); </span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> NotifyClassFinishedRegistrationEvents = [](TArray&lt;UClass*&gt;&amp; Classes)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (UClass* Class : Classes)</span><br><span class="line">            &#123;</span><br><span class="line">                TCHAR PackageName[FName::StringBufferSize];</span><br><span class="line">                TCHAR ClassName[FName::StringBufferSize];</span><br><span class="line">                Class-&gt;<span class="built_in">GetOutermost</span>()-&gt;<span class="built_in">GetFName</span>().<span class="built_in">ToString</span>(PackageName);</span><br><span class="line">                Class-&gt;<span class="built_in">GetFName</span>().<span class="built_in">ToString</span>(ClassName);</span><br><span class="line">                <span class="built_in">NotifyRegistrationEvent</span>(PackageName, ClassName, ENotifyRegistrationType::NRT_Class, ENotifyRegistrationPhase::NRP_Finished, <span class="literal">nullptr</span>, <span class="literal">false</span>, Class);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// notify async loader of all new classes before creating the class default objects</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;NotifyClassFinishedRegistrationEvents&quot;</span>);</span><br><span class="line">            <span class="built_in">NotifyClassFinishedRegistrationEvents</span>(NewClassesInCoreUObject);</span><br><span class="line">            <span class="built_in">NotifyClassFinishedRegistrationEvents</span>(NewClassesInEngine);</span><br><span class="line">            <span class="built_in">NotifyClassFinishedRegistrationEvents</span>(NewClasses);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;CoreUObject Classes&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (UClass* Class : NewClassesInCoreUObject) <span class="comment">// we do these first because we assume these never trigger loads</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">UE_LOG</span>(LogUObjectBootstrap, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;GetDefaultObject Begin %s %s&quot;</span>), *Class-&gt;<span class="built_in">GetOutermost</span>()-&gt;<span class="built_in">GetName</span>(), *Class-&gt;<span class="built_in">GetName</span>());</span><br><span class="line">                Class-&gt;<span class="built_in">GetDefaultObject</span>();</span><br><span class="line">                <span class="built_in">UE_LOG</span>(LogUObjectBootstrap, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;GetDefaultObject End %s %s&quot;</span>), *Class-&gt;<span class="built_in">GetOutermost</span>()-&gt;<span class="built_in">GetName</span>(), *Class-&gt;<span class="built_in">GetName</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;Engine Classes&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (UClass* Class : NewClassesInEngine) <span class="comment">// we do these second because we want to bring the engine up before the game</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">UE_LOG</span>(LogUObjectBootstrap, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;GetDefaultObject Begin %s %s&quot;</span>), *Class-&gt;<span class="built_in">GetOutermost</span>()-&gt;<span class="built_in">GetName</span>(), *Class-&gt;<span class="built_in">GetName</span>());</span><br><span class="line">                Class-&gt;<span class="built_in">GetDefaultObject</span>();</span><br><span class="line">                <span class="built_in">UE_LOG</span>(LogUObjectBootstrap, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;GetDefaultObject End %s %s&quot;</span>), *Class-&gt;<span class="built_in">GetOutermost</span>()-&gt;<span class="built_in">GetName</span>(), *Class-&gt;<span class="built_in">GetName</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;Other Classes&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (UClass* Class : NewClasses)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">UE_LOG</span>(LogUObjectBootstrap, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;GetDefaultObject Begin %s %s&quot;</span>), *Class-&gt;<span class="built_in">GetOutermost</span>()-&gt;<span class="built_in">GetName</span>(), *Class-&gt;<span class="built_in">GetName</span>());</span><br><span class="line">                Class-&gt;<span class="built_in">GetDefaultObject</span>();</span><br><span class="line">                <span class="built_in">UE_LOG</span>(LogUObjectBootstrap, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;GetDefaultObject End %s %s&quot;</span>), *Class-&gt;<span class="built_in">GetOutermost</span>()-&gt;<span class="built_in">GetName</span>(), *Class-&gt;<span class="built_in">GetName</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Class 的 OuterRegister 如下：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UClass* <span class="title">Z_Construct_UClass_UMyObject</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!Z_Registration_Info_UClass_UMyObject.OuterSingleton)</span><br><span class="line">    &#123;</span><br><span class="line">        UECodeGen_Private::<span class="built_in">ConstructUClass</span>(Z_Registration_Info_UClass_UMyObject.OuterSingleton, Z_Construct_UClass_UMyObject_Statics::ClassParams);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Z_Registration_Info_UClass_UMyObject.OuterSingleton;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其实就是执行依赖项，然后通过 InnerRegister 创建一个新类， <code>UObjectForceRegistration</code> 注册到全局 Objects Table 中。 <code>CreateLinkAndAddChildFunctionsToMap</code> 其实就是执行 <code>ConstructUFunction</code> 来创建一个个成员函数，并将其加入到 <code>FuncMap</code> ，随后构建属性，并 Link，这部分逻辑和 <code>Struct</code> 一致。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ConstructUClass</span><span class="params">(UClass*&amp; OutClass, <span class="type">const</span> FClassParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (OutClass &amp;&amp; (OutClass-&gt;ClassFlags &amp; CLASS_Constructed))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (UObject* (*<span class="type">const</span> *SingletonFunc)() = Params.DependencySingletonFuncArray, *(*<span class="type">const</span> *SingletonFuncEnd)() = SingletonFunc + Params.NumDependencySingletons; SingletonFunc != SingletonFuncEnd; ++SingletonFunc)</span><br><span class="line">    &#123;</span><br><span class="line">        (*SingletonFunc)();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UClass* NewClass = Params.<span class="built_in">ClassNoRegisterFunc</span>();</span><br><span class="line">    OutClass = NewClass;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (NewClass-&gt;ClassFlags &amp; CLASS_Constructed)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UObjectForceRegistration</span>(NewClass);</span><br><span class="line"></span><br><span class="line">    UClass* SuperClass = NewClass-&gt;<span class="built_in">GetSuperClass</span>();</span><br><span class="line">    <span class="keyword">if</span> (SuperClass)</span><br><span class="line">    &#123;</span><br><span class="line">        NewClass-&gt;ClassFlags |= (SuperClass-&gt;ClassFlags &amp; CLASS_Inherit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    NewClass-&gt;ClassFlags |= (EClassFlags)(Params.ClassFlags | CLASS_Constructed);</span><br><span class="line">    <span class="comment">// Make sure the reference token stream is empty since it will be reconstructed later on</span></span><br><span class="line">    <span class="comment">// This should not apply to intrinsic classes since they emit native references before AssembleReferenceTokenStream is called.</span></span><br><span class="line">    <span class="keyword">if</span> ((NewClass-&gt;ClassFlags &amp; CLASS_Intrinsic) != CLASS_Intrinsic)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">check</span>((NewClass-&gt;ClassFlags &amp; CLASS_TokenStreamAssembled) != CLASS_TokenStreamAssembled);</span><br><span class="line">        NewClass-&gt;ReferenceSchema.<span class="built_in">Reset</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    NewClass-&gt;<span class="built_in">CreateLinkAndAddChildFunctionsToMap</span>(Params.FunctionLinkArray, Params.NumFunctions);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ConstructFProperties</span>(NewClass, Params.PropertyArray, Params.NumProperties);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Params.ClassConfigNameUTF8)</span><br><span class="line">    &#123;</span><br><span class="line">        NewClass-&gt;ClassConfigName = <span class="built_in">FName</span>(<span class="built_in">UTF8_TO_TCHAR</span>(Params.ClassConfigNameUTF8));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    NewClass-&gt;<span class="built_in">SetCppTypeInfoStatic</span>(Params.CppClassInfo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (int32 NumImplementedInterfaces = Params.NumImplementedInterfaces)</span><br><span class="line">    &#123;</span><br><span class="line">        NewClass-&gt;Interfaces.<span class="built_in">Reserve</span>(NumImplementedInterfaces);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> FImplementedInterfaceParams* ImplementedInterface = Params.ImplementedInterfaceArray, *ImplementedInterfaceEnd = ImplementedInterface + NumImplementedInterfaces; ImplementedInterface != ImplementedInterfaceEnd; ++ImplementedInterface)</span><br><span class="line">        &#123;</span><br><span class="line">            UClass* (*ClassFunc)() = ImplementedInterface-&gt;ClassFunc;</span><br><span class="line">            UClass* InterfaceClass = ClassFunc ? <span class="built_in">ClassFunc</span>() : <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">            NewClass-&gt;Interfaces.<span class="built_in">Emplace</span>(InterfaceClass, ImplementedInterface-&gt;Offset, ImplementedInterface-&gt;bImplementedByK2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    NewClass-&gt;<span class="built_in">StaticLink</span>();</span><br><span class="line"></span><br><span class="line">    NewClass-&gt;<span class="built_in">SetSparseClassDataStruct</span>(NewClass-&gt;<span class="built_in">GetSparseClassDataArchetypeStruct</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UFunction* <span class="title">Z_Construct_UFunction_UMyObject_MyFunc</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> UFunction* ReturnFunction = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">if</span> (!ReturnFunction)</span><br><span class="line">    &#123;</span><br><span class="line">        UECodeGen_Private::<span class="built_in">ConstructUFunction</span>(&amp;ReturnFunction, Z_Construct_UFunction_UMyObject_MyFunc_Statics::FuncParams);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ReturnFunction;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构造 <code>UFunction</code> 的内容就不细说了，Function 的 RPCId 就是在这里设置的，因为 Function 也是有参数的，所以也需要 <code>StaticLink</code>。最后将 Function Bind 到 Outer 身上，也就是 Class 身上。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FORCEINLINE <span class="type">void</span> <span class="title">ConstructUFunctionInternal</span><span class="params">(UFunction*&amp; OutFunction, <span class="type">const</span> FFunctionParams&amp; Params, UFunction** SingletonPtr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UObject*   (*OuterFunc)() = Params.OuterFunc;</span><br><span class="line">    UFunction* (*SuperFunc)() = Params.SuperFunc;</span><br><span class="line"></span><br><span class="line">    UObject*   Outer = OuterFunc ? <span class="built_in">OuterFunc</span>() : <span class="literal">nullptr</span>;</span><br><span class="line">    UFunction* Super = SuperFunc ? <span class="built_in">SuperFunc</span>() : <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (OutFunction)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">FName <span class="title">FuncName</span><span class="params">(UTF8_TO_TCHAR(Params.NameUTF8))</span></span>;</span><br><span class="line"></span><br><span class="line">    UFunction* NewFunction;</span><br><span class="line">    <span class="keyword">if</span> (Params.FunctionFlags &amp; FUNC_Delegate)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Params.OwningClassName == <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            NewFunction = <span class="built_in">new</span> (EC_InternalUseOnlyConstructor, Outer, FuncName, Params.ObjectFlags) <span class="built_in">UDelegateFunction</span>(</span><br><span class="line">                <span class="built_in">FObjectInitializer</span>(),</span><br><span class="line">                Super,</span><br><span class="line">                Params.FunctionFlags,</span><br><span class="line">                Params.StructureSize</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            USparseDelegateFunction* NewSparseFunction = <span class="built_in">new</span> (EC_InternalUseOnlyConstructor, Outer, FuncName, Params.ObjectFlags) <span class="built_in">USparseDelegateFunction</span>(</span><br><span class="line">                <span class="built_in">FObjectInitializer</span>(),</span><br><span class="line">                Super,</span><br><span class="line">                Params.FunctionFlags,</span><br><span class="line">                Params.StructureSize</span><br><span class="line">            );</span><br><span class="line">            NewSparseFunction-&gt;OwningClassName = <span class="built_in">FName</span>(Params.OwningClassName);</span><br><span class="line">            NewSparseFunction-&gt;DelegateName = <span class="built_in">FName</span>(Params.DelegateName);</span><br><span class="line">            NewFunction = NewSparseFunction;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        NewFunction = <span class="built_in">new</span> (EC_InternalUseOnlyConstructor, Outer, FuncName, Params.ObjectFlags) <span class="built_in">UFunction</span>(</span><br><span class="line">            <span class="built_in">FObjectInitializer</span>(),</span><br><span class="line">            Super,</span><br><span class="line">            Params.FunctionFlags,</span><br><span class="line">            Params.StructureSize</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    OutFunction = NewFunction;</span><br><span class="line"></span><br><span class="line">    NewFunction-&gt;RPCId = Params.RPCId;</span><br><span class="line">    NewFunction-&gt;RPCResponseId = Params.RPCResponseId;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ConstructFProperties</span>(NewFunction, Params.PropertyArray, Params.NumProperties);</span><br><span class="line"></span><br><span class="line">    NewFunction-&gt;<span class="built_in">Bind</span>();</span><br><span class="line">    NewFunction-&gt;<span class="built_in">StaticLink</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后是 <code>UPackage</code> 的注册。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> FPackageRegistrationInfo Z_Registration_Info_UPackage__Script_Reflection;</span><br><span class="line"><span class="function">FORCENOINLINE UPackage* <span class="title">Z_Construct_UPackage__Script_Reflection</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!Z_Registration_Info_UPackage__Script_Reflection.OuterSingleton)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">static</span> <span class="type">const</span> UECodeGen_Private::FPackageParams PackageParams = &#123;</span><br><span class="line">            <span class="string">&quot;/Script/Reflection&quot;</span>,</span><br><span class="line">            <span class="literal">nullptr</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            PKG_CompiledIn | <span class="number">0x00000000</span>,</span><br><span class="line">            <span class="number">0xC0294C5F</span>,</span><br><span class="line">            <span class="number">0x8700445F</span>,</span><br><span class="line">            <span class="built_in">METADATA_PARAMS</span>(<span class="number">0</span>, <span class="literal">nullptr</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        UECodeGen_Private::<span class="built_in">ConstructUPackage</span>(Z_Registration_Info_UPackage__Script_Reflection.OuterSingleton, PackageParams);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Z_Registration_Info_UPackage__Script_Reflection.OuterSingleton;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FPackageParams</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>*                        NameUTF8;</span><br><span class="line">    UObject*                  (*<span class="type">const</span> *SingletonFuncArray)();</span><br><span class="line">    int32                              NumSingletons;</span><br><span class="line">    uint32                             PackageFlags; <span class="comment">// EPackageFlags</span></span><br><span class="line">    uint32                             BodyCRC;</span><br><span class="line">    uint32                             DeclarationsCRC;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_METADATA</span></span><br><span class="line">    uint16                             NumMetaData;</span><br><span class="line">    <span class="type">const</span> FMetaDataPairParam*          MetaDataArray;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> FRegisterCompiledInInfo <span class="title">Z_CompiledInDeferPackage_UPackage__Script_Reflection</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Z_Construct_UPackage__Script_Reflection,</span></span></span><br><span class="line"><span class="params"><span class="function">    TEXT(<span class="string">&quot;/Script/Reflection&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">    Z_Registration_Info_UPackage__Script_Reflection,</span></span></span><br><span class="line"><span class="params"><span class="function">    CONSTRUCT_RELOAD_VERSION_INFO(FPackageReloadVersionInfo, <span class="number">0xC0294C5F</span>, <span class="number">0x8700445F</span></span></span></span><br><span class="line"><span class="params"><span class="function">);</span></span></span><br></pre></td></tr></table></figure><p><code>Package</code> 不是这个时候创建出来的，而是创建 <code>Enum</code> 等其他类型时，就提前创建好了，所以此处只是找出来。此处的 <code>SingletonFuncArray</code> 就是 <code>Delegate</code> 同一个代码包里的所有 <code>Delegate</code> 最终都会归集到这，可以看出它也是 <code>Object</code> 。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ConstructUPackage</span><span class="params">(UPackage*&amp; OutPackage, <span class="type">const</span> FPackageParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (OutPackage)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UObject* FoundPackage = <span class="built_in">StaticFindObjectFast</span>(UPackage::<span class="built_in">StaticClass</span>(), <span class="literal">nullptr</span>, <span class="built_in">FName</span>(<span class="built_in">UTF8_TO_TCHAR</span>(Params.NameUTF8)), <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">checkf</span>(FoundPackage, <span class="built_in">TEXT</span>(<span class="string">&quot;Code not found for generated code (package %s).&quot;</span>), <span class="built_in">UTF8_TO_TCHAR</span>(Params.NameUTF8));</span><br><span class="line"></span><br><span class="line">    UPackage* NewPackage = <span class="built_in">CastChecked</span>&lt;UPackage&gt;(FoundPackage);</span><br><span class="line">    OutPackage = NewPackage;</span><br><span class="line"></span><br><span class="line">    NewPackage-&gt;<span class="built_in">SetPackageFlags</span>(Params.PackageFlags);</span><br><span class="line"></span><br><span class="line">    TCHAR PackageName[FName::StringBufferSize];</span><br><span class="line">    NewPackage-&gt;<span class="built_in">GetFName</span>().<span class="built_in">ToString</span>(PackageName);</span><br><span class="line">    <span class="keyword">for</span> (UObject* (*<span class="type">const</span> *SingletonFunc)() = Params.SingletonFuncArray, *(*<span class="type">const</span> *SingletonFuncEnd)() = SingletonFunc + Params.NumSingletons; SingletonFunc != SingletonFuncEnd; ++SingletonFunc)</span><br><span class="line">    &#123;</span><br><span class="line">        UObject* Object = (*SingletonFunc)();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Object-&gt;<span class="built_in">GetOuter</span>() == NewPackage)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Notify loader of new top level noexport objects like UScriptStruct, UDelegateFunction and USparseDelegateFunction</span></span><br><span class="line">            TCHAR ObjectName[FName::StringBufferSize];</span><br><span class="line">            Object-&gt;<span class="built_in">GetFName</span>().<span class="built_in">ToString</span>(ObjectName);</span><br><span class="line">            <span class="built_in">NotifyRegistrationEvent</span>(PackageName, ObjectName, ENotifyRegistrationType::NRT_NoExportObject, ENotifyRegistrationPhase::NRP_Finished, <span class="literal">nullptr</span>, <span class="literal">false</span>, Object);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>C++ 代码会被 UHT 工具扫描，并将相应的宏替换为辅助代码，同时去掉空宏，最终每个文件都会有一个 <code>FRegisterCompiledInfo</code> 的 static struct，执行该构造函数后，将反射信息全都注册到 <code>TDeferredRegistry</code> 中。</p><p>注册完成之后，引擎启动时，会调用到 <code>ProcessNewlyLoadedUObject</code> 。</p><ol><li>构建 Class 的 Inner，并创建对应的 Package。</li><li>构建 Enum 和 Struct 的 Outer，Outer 会立刻构建 Inner。</li><li>构建 Class 的 Outer，构建里面的属性和成员函数。</li><li>通知构建完成，在 <code>NotifyRegistrationComplete</code> 检查是否都完成创建。</li></ol></div><footer class="post-footer"><div class="post-tags"><a href="/tags/UE5/" rel="tag"># UE5</a> <a href="/tags/%E5%8F%8D%E5%B0%84/" rel="tag"># 反射</a></div><div class="post-nav"><div class="post-nav-item"><a href="/UE5%20%E7%BD%91%E7%BB%9C%E5%89%96%E6%9E%90(%E5%9B%9B)%20%E5%B1%9E%E6%80%A7%E5%90%8C%E6%AD%A5%E4%B8%8ERPC/" rel="prev" title="UE5 网络剖析(四) 属性同步与RPC"><i class="fa fa-angle-left"></i> UE5 网络剖析(四) 属性同步与RPC</a></div><div class="post-nav-item"><a href="/UE5%20%E8%93%9D%E5%9B%BE%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B%E5%89%96%E6%9E%90/" rel="next" title="UE5 蓝图编译流程剖析">UE5 蓝图编译流程剖析 <i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Yuerer</span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><div class="reading-progress-bar"></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://unpkg.com/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://unpkg.com/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/comments.min.js"></script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/utils.min.js"></script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/motion.min.js"></script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/sidebar.min.js"></script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/next-boot.min.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://yuerer-comment-xufei-0bea01e6f05-1307930306.ap-shanghai.app.tcloudbase.com","cssUrl":"https://s4.zstatic.net/ajax/libs/waline/2.15.8/waline.css","commentCount":true,"pageview":true,"libUrl":"https://s4.zstatic.net/ajax/libs/waline/2.15.8/waline.js","locale":{"placeholder":"有何高见？"},"emoji":["https://unpkg.com/@waline/emojis@1.0.1/qq"],"meta":["nick","mail"],"requiredMeta":[["nick","mail"]],"wordLimit":0,"login":"disable","pageSize":10,"el":"#waline","comment":true,"path":"/UE5%20%E5%8F%8D%E5%B0%84%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E4%B8%8E%E6%B3%A8%E5%86%8C/"}</script><link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/waline/2.15.8/waline.css"><script>document.addEventListener("page:loaded",()=>{NexT.utils.loadComments(CONFIG.waline.el).then(()=>NexT.utils.getScript(CONFIG.waline.libUrl,{condition:window.Waline})).then(()=>Waline.init(Object.assign({},CONFIG.waline,{el:document.querySelector(CONFIG.waline.el)})))})</script></body></html>