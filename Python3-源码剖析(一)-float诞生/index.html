<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.jpeg"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.ico"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.ico"><link rel="mask-icon" href="/images/avatar.jpeg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous"><link rel="stylesheet" href="https://unpkg.com/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"yuerer.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"hide","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/config.min.js"></script><meta name="description" content="去年 2021 年的时候，我的工作主要集中在改进 Lua虚拟机 ，后来由于工作变动，现在主要的工作语言已经切换为了 Python ，因此打算阅读下 Python 3.10 的源码，学习一下它的设计，对比 Lua 的优势。 希望在接下来的阅读过程中，能够体会到一种 回家 的畅快感。 本篇将以 float 作为起点，了解如何创建出一个浮点对象，深入剖析 float 其内部实现。 一切皆对象一切皆对象"><meta property="og:type" content="article"><meta property="og:title" content="Python3 源码剖析(一)-float诞生"><meta property="og:url" content="https://yuerer.com/Python3-%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90(%E4%B8%80)-float%E8%AF%9E%E7%94%9F/index.html"><meta property="og:site_name" content="Yuerer&#39;s Blog"><meta property="og:description" content="去年 2021 年的时候，我的工作主要集中在改进 Lua虚拟机 ，后来由于工作变动，现在主要的工作语言已经切换为了 Python ，因此打算阅读下 Python 3.10 的源码，学习一下它的设计，对比 Lua 的优势。 希望在接下来的阅读过程中，能够体会到一种 回家 的畅快感。 本篇将以 float 作为起点，了解如何创建出一个浮点对象，深入剖析 float 其内部实现。 一切皆对象一切皆对象"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://yuerer.com/images/python3-float-atan2.jpg"><meta property="article:published_time" content="2022-04-05T02:30:54.000Z"><meta property="article:modified_time" content="2025-10-21T13:50:52.259Z"><meta property="article:author" content="Yuerer"><meta property="article:tag" content="Python"><meta property="article:tag" content="CPython"><meta property="article:tag" content="Python虚拟机"><meta property="article:tag" content="float"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://yuerer.com/images/python3-float-atan2.jpg"><link rel="canonical" href="https://yuerer.com/Python3-%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90(%E4%B8%80)-float%E8%AF%9E%E7%94%9F/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://yuerer.com/Python3-%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90(%E4%B8%80)-float%E8%AF%9E%E7%94%9F/","path":"Python3-源码剖析(一)-float诞生/","title":"Python3 源码剖析(一)-float诞生"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Python3 源码剖析(一)-float诞生 | Yuerer's Blog</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-129491388-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-129491388-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/third-party/analytics/google-analytics.min.js"></script><link rel="dns-prefetch" href="https://yuerer-comment-xufei-0bea01e6f05-1307930306.ap-shanghai.app.tcloudbase.com"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Yuerer's Blog</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">钰儿的Blog</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E5%88%87%E7%9A%86%E5%AF%B9%E8%B1%A1"><span class="nav-text">一切皆对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PyObject"><span class="nav-text">PyObject</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PyTypeObject"><span class="nav-text">PyTypeObject</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PyBaseObject"><span class="nav-text">PyBaseObject</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PyFloatObject"><span class="nav-text">PyFloatObject</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%AE%E7%82%B9%E6%95%B0%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">浮点数初始化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%AE%E7%82%B9%E6%95%B0%E7%9A%84%E5%88%9B%E5%BB%BA%E4%B8%8E%E9%94%80%E6%AF%81"><span class="nav-text">浮点数的创建与销毁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%AE%E7%82%B9%E6%95%B0%E5%88%9B%E5%BB%BA"><span class="nav-text">浮点数创建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#float-vectorcall"><span class="nav-text">float_vectorcall</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%AE%E7%82%B9%E6%95%B0%E9%94%80%E6%AF%81"><span class="nav-text">浮点数销毁</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%AE%E7%82%B9%E6%95%B0%E6%93%8D%E4%BD%9C"><span class="nav-text">浮点数操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%AE%E7%82%B9%E6%95%B0%E6%AF%94%E8%BE%83"><span class="nav-text">浮点数比较</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#copysign"><span class="nav-text">copysign</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Yuerer" src="/images/avatar.jpeg"><p class="site-author-name" itemprop="name">Yuerer</p><div class="site-description" itemprop="description">钰儿的Blog</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">65</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">90</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Yu2erer" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Yu2erer" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:yu2erer#gmail.com" title="E-Mail → mailto:yu2erer#gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://yuerer.com/Python3-%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90(%E4%B8%80)-float%E8%AF%9E%E7%94%9F/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpeg"><meta itemprop="name" content="Yuerer"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Yuerer's Blog"><meta itemprop="description" content="钰儿的Blog"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Python3 源码剖析(一)-float诞生 | Yuerer's Blog"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Python3 源码剖析(一)-float诞生</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-04-05 10:30:54" itemprop="dateCreated datePublished" datetime="2022-04-05T10:30:54+08:00">2022-04-05</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Python3/" itemprop="url" rel="index"><span itemprop="name">Python3</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Waline：</span> <a title="waline" href="/Python3-%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90(%E4%B8%80)-float%E8%AF%9E%E7%94%9F/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/Python3-%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90(%E4%B8%80)-float%E8%AF%9E%E7%94%9F/" itemprop="commentCount"></span> </a></span><span class="post-meta-item" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="waline-pageview-count" data-path="/Python3-%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90(%E4%B8%80)-float%E8%AF%9E%E7%94%9F/"></span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>去年 <code>2021</code> 年的时候，我的工作主要集中在改进 <code>Lua虚拟机</code> ，后来由于工作变动，现在主要的工作语言已经切换为了 <code>Python</code> ，因此打算阅读下 <code>Python 3.10</code> 的源码，学习一下它的设计，对比 <code>Lua</code> 的优势。</p><p>希望在接下来的阅读过程中，能够体会到一种 <code>回家</code> 的畅快感。</p><p>本篇将以 <code>float</code> 作为起点，了解如何创建出一个浮点对象，深入剖析 <code>float</code> 其内部实现。</p><h2 id="一切皆对象"><a href="#一切皆对象" class="headerlink" title="一切皆对象"></a>一切皆对象</h2><p>一切皆对象 这句话都要被讲烂了，但是还要讲多一次。</p><p><code>Python</code> 是一门面向对象的强类型动态语言，里面的任何东西都是对象，以浮点数为例。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># a 是一个浮点实例对象，类型是 float</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = <span class="number">3.14159</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(a)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;float&#x27;</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># float 也是个对象，但它是 类型对象</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">float</span></span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;float&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">float</span>()</span><br><span class="line"><span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># float这个类型对象的类型是 type</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(<span class="built_in">float</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;type&#x27;</span>&gt;</span><br></pre></td></tr></table></figure><p>以上我们可以确定，<code>Python</code> 中类型也是对象。</p><p>此外所有对象的类型都是 <code>type</code> ，可以称其为元类。而所有对象都继承自 <code>object</code> 。</p><span id="more"></span><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(<span class="built_in">int</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;type&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(<span class="built_in">dict</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;type&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(<span class="built_in">list</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;type&#x27;</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">float</span>.__base__</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">dict</span>.__base__</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;</span><br></pre></td></tr></table></figure><p>而 <code>object</code> 的类型也是 <code>type</code> ，<code>type</code> 的类型也为 <code>type</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(<span class="built_in">object</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;type&#x27;</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(<span class="built_in">type</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;type&#x27;</span>&gt;</span><br></pre></td></tr></table></figure><p>至此我们可以得出以下几个结论，方便后续继续阅读 float 的实现。</p><ol><li>一切皆对象，包括类型也是对象</li><li>所有类都继承自 <code>object</code></li><li>所有类的类型都是 <code>type</code></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>.__base__</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">object</span>.__class__</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;type&#x27;</span>&gt;</span><br></pre></td></tr></table></figure><ol><li><code>type</code> 的父类也是 <code>object</code></li><li><code>type</code> 的类型也是 <code>type</code></li><li><code>object</code> 的类型也是 <code>type</code></li><li><code>object</code> 的父类为 <code>None</code></li></ol><p>两者互为表里，相辅相成。</p><h2 id="PyObject"><a href="#PyObject" class="headerlink" title="PyObject"></a>PyObject</h2><p>理解了以上的内容，就能开始正式阅读源码了。<code>CPython</code> 为了表示一种继承的关系，但苦于 <code>C语言</code> 没有这种机制，不得不手动模拟，抽出 <code>PyObject</code> 作为父类。</p><p><code>PyObject</code> 的结构相当简单，和 <code>Lua</code> 一样，需要自动垃圾回收，给每个对象头部都加了 <code>double-link</code> ，当创建对象的时候就将所有对象串起来，主要用于扫描与分代垃圾回收。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _PyObject_HEAD_EXTRA            \</span></span><br><span class="line"><span class="meta">    struct _object *_ob_next;           \</span></span><br><span class="line"><span class="meta">    struct _object *_ob_prev;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">object</span> &#123;</span></span><br><span class="line">    _PyObject_HEAD_EXTRA</span><br><span class="line">    Py_ssize_t ob_refcnt;</span><br><span class="line">    PyTypeObject *ob_type;</span><br><span class="line">&#125; PyObject;</span><br></pre></td></tr></table></figure><p><code>PyObject</code> 是所有对象的起点，后续任何一个对象都继承自它。它包含双向链表和引用计数(ob_refcnt)，通过这两个结构运用了多种垃圾回收机制。</p><p><code>ob_type</code> 则是类型指针，指向该对象真正的类型，表示该对象的一些行为，用于实现多态。</p><p><code>PyVarObject</code> 则是 <code>PyObject</code> 的增强版，用于支持 <strong>变长对象</strong>。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    PyObject ob_base;</span><br><span class="line">    Py_ssize_t ob_size;</span><br><span class="line">&#125; PyVarObject;</span><br></pre></td></tr></table></figure><p>之所以需要 <strong>变长对象</strong> 是因为有的类型是一个容器，需要存储动态变更大小，例如 <code>List</code> 。既然 <code>PyVarObject</code> 是变长对象，那么 <code>PyObject</code> 就可以看作是定长对象。</p><h2 id="PyTypeObject"><a href="#PyTypeObject" class="headerlink" title="PyTypeObject"></a>PyTypeObject</h2><p>前面我们知道，在 <code>Python</code> 的世界中，类型也是对象，实例是由类型对象生成出来的。 <code>PyTypeObject</code> 就是所谓的类型实例对象， <code>PyType_Type</code> 则是类型的类型对象，它用于表示该类型的一些行为，生成出来的实例也会遵循它的规则进行，一定要先搞清楚这两者的关系，才好去理解 <code>Python</code>。</p><p>具体的 <code>PyTypeObject</code> 结构在此处先不展开，留到后续阅读各个内建对象时，再解释说明。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PyObject_VAR_HEAD      PyVarObject ob_base;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">typeobject</span> <span class="title">PyTypeObject</span>;</span> <span class="comment">// type 的实例对象</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">typeobject</span> &#123;</span></span><br><span class="line">    PyObject_VAR_HEAD</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *tp_name; <span class="comment">/* For printing, in format &quot;&lt;module&gt;.&lt;name&gt;&quot; */</span></span><br><span class="line">    Py_ssize_t tp_basicsize, tp_itemsize; <span class="comment">/* For allocation */</span></span><br><span class="line">	...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>在 <code>Python</code> 虚拟机启动后，内建类型对象就可以拿来实例化对象了，这说明内建类型对象是在启动时就准备好了。</p><p>而 <code>PyType_Type</code> 就是提前准备好的类型对象。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 垃圾回收链表, 之所以都为空, 是因为这些提前准备好的对象不是动态生成的, 不需要垃圾回收</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _PyObject_EXTRA_INIT 0, 0,</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置对象类型, 可以看出type的type还是type</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PyObject_HEAD_INIT(type)        \</span></span><br><span class="line"><span class="meta">    &#123; _PyObject_EXTRA_INIT              \</span></span><br><span class="line"><span class="meta">    1, type &#125;,</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PyVarObject_HEAD_INIT(type, size)       \</span></span><br><span class="line"><span class="meta">    &#123; PyObject_HEAD_INIT(type) size &#125;,</span></span><br><span class="line"></span><br><span class="line">PyDoc_STRVAR(type_doc,</span><br><span class="line"><span class="string">&quot;type(object) -&gt; the object&#x27;s type\n&quot;</span></span><br><span class="line"><span class="string">&quot;type(name, bases, dict, **kwds) -&gt; a new type&quot;</span>);</span><br><span class="line"></span><br><span class="line">PyTypeObject PyType_Type = &#123; <span class="comment">// 类型对象</span></span><br><span class="line">    PyVarObject_HEAD_INIT(&amp;PyType_Type, <span class="number">0</span>)</span><br><span class="line">    <span class="string">&quot;type&quot;</span>,                                     <span class="comment">/* tp_name 命名 */</span></span><br><span class="line">    <span class="keyword">sizeof</span>(PyHeapTypeObject),                   <span class="comment">/* tp_basicsize 基础大小 */</span></span><br><span class="line">    <span class="keyword">sizeof</span>(PyMemberDef),                        <span class="comment">/* tp_itemsize 元素大小 */</span></span><br><span class="line">    (destructor)type_dealloc,                   <span class="comment">/* tp_dealloc 析构函数 */</span></span><br><span class="line">    offsetof(PyTypeObject, tp_vectorcall),      <span class="comment">/* tp_vectorcall_offset */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_getattr */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_setattr */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_as_async */</span></span><br><span class="line">    (reprfunc)type_repr,                        <span class="comment">/* tp_repr 对象调试信息 */</span></span><br><span class="line">    &amp;type_as_number,                            <span class="comment">/* tp_as_number 作为数字时的操作函数 */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_as_sequence */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_as_mapping */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_hash */</span></span><br><span class="line">    (ternaryfunc)type_call,                     <span class="comment">/* tp_call 类型对象可调用 */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_str */</span></span><br><span class="line">    (getattrofunc)type_getattro,                <span class="comment">/* tp_getattro 获取元素 */</span></span><br><span class="line">    (setattrofunc)type_setattro,                <span class="comment">/* tp_setattro 设置元素 */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_as_buffer */</span></span><br><span class="line">    Py_TPFLAGS_DEFAULT | Py_TPFLAGS_HAVE_GC |</span><br><span class="line">    Py_TPFLAGS_BASETYPE | Py_TPFLAGS_TYPE_SUBCLASS |</span><br><span class="line">    Py_TPFLAGS_HAVE_VECTORCALL,                 <span class="comment">/* tp_flags */</span></span><br><span class="line">    type_doc,                                   <span class="comment">/* tp_doc */</span></span><br><span class="line">    (traverseproc)type_traverse,                <span class="comment">/* tp_traverse */</span></span><br><span class="line">    (inquiry)type_clear,                        <span class="comment">/* tp_clear */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_richcompare */</span></span><br><span class="line">    offsetof(PyTypeObject, tp_weaklist),        <span class="comment">/* tp_weaklistoffset */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_iter */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_iternext */</span></span><br><span class="line">    type_methods,                               <span class="comment">/* tp_methods */</span></span><br><span class="line">    type_members,                               <span class="comment">/* tp_members */</span></span><br><span class="line">    type_getsets,                               <span class="comment">/* tp_getset */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_base */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_dict */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_descr_get */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_descr_set */</span></span><br><span class="line">    offsetof(PyTypeObject, tp_dict),            <span class="comment">/* tp_dictoffset */</span></span><br><span class="line">    type_init,                                  <span class="comment">/* tp_init */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_alloc */</span></span><br><span class="line">    type_new,                                   <span class="comment">/* tp_new */</span></span><br><span class="line">    PyObject_GC_Del,                            <span class="comment">/* tp_free */</span></span><br><span class="line">    (inquiry)type_is_gc,                        <span class="comment">/* tp_is_gc */</span></span><br><span class="line">    .tp_vectorcall = type_vectorcall,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>我们可以看出，<code>type</code> 的类型还是 <code>type</code>。其次有好多地方都是空的，这是因为有的参数是等到用到的时候再添加，由 <code>PyType_Ready</code> 函数完成，内置对象都会在 <code>_PyTypes_Init</code> 时就已经初始化好。</p><p>现在，我们已经知道 所有的对象都是先由 <code>type</code> 这一元类生成，那么对象是怎么被生成的？</p><p>对象生成主要有两种方式，一种是调用类型对象，也就是使用类型对象的 <code>__call__</code> ，另一种则是在语法分析时，就可确定该对象的类型，直接调用内部的CAPI(对应指令为 <code>LOAD_CONST</code>)。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">float</span>(<span class="number">1.5</span>)</span><br><span class="line"><span class="number">1.5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>f = <span class="number">1.5</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>f</span><br><span class="line"><span class="number">1.5</span></span><br></pre></td></tr></table></figure><p>这两种的区别主要在于性能上，在语法分析阶段直接能确定类型的，会比调用类型对象生成的要快的多。</p><p><code>float(1.5)</code> ⇒ <code>float.__class__.__call__(float, 1.5)</code> ⇒ <code>type.__call__(float, 1.5)</code> ⇒ <code>type_call(float, 1.5)</code> 而在 <code>type_call</code> 中还会去检查是否可以转换为 <code>float</code> 对象，自然就慢了。</p><p><code>f = 1.5</code> ⇒ <code>PyFloat_FromDouble(1.5)</code> 一步到位，没有更多的类型判断。</p><p>怎么证明以上的结论呢？有个很简单的方法。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(<span class="built_in">float</span>.__call__)</span><br><span class="line">&lt;method-wrapper <span class="string">&#x27;__call__&#x27;</span> of <span class="built_in">type</span> <span class="built_in">object</span> at <span class="number">0x103f65d70</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(<span class="built_in">int</span>.__call__)</span><br><span class="line">&lt;method-wrapper <span class="string">&#x27;__call__&#x27;</span> of <span class="built_in">type</span> <span class="built_in">object</span> at <span class="number">0x103f67f90</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(<span class="built_in">type</span>.__call__)</span><br><span class="line">&lt;slot wrapper <span class="string">&#x27;__call__&#x27;</span> of <span class="string">&#x27;type&#x27;</span> objects&gt;</span><br></pre></td></tr></table></figure><p>可以看出 类型对象的 <code>__call__</code> 实际上就是 <code>type</code> 的 <code>__call__</code> 。同时我们还可以知道，结构体中的 slot 的函数指针，在 Python 的世界中也是对象！ <code>PyWrapperDescrObject</code> 对函数指针进行包装还加了一些描述。</p><p>有了以上的前置知识，接下来就是要关注一个对象的创建流程了，从 <code>type_call</code> 函数开始阅读，因为 <code>type</code> 的 <code>__call__</code> 调用的是 <code>type_call</code> 。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> PyObject *</span><br><span class="line"><span class="title function_">type_call</span><span class="params">(PyTypeObject *type, PyObject *args, PyObject *kwds)</span></span><br><span class="line">&#123;</span><br><span class="line">    PyObject *obj;</span><br><span class="line">    PyThreadState *tstate = _PyThreadState_GET();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 支持 type(x) 语法 返回对应的类型对象</span></span><br><span class="line">    <span class="keyword">if</span> (type == &amp;PyType_Type) &#123;</span><br><span class="line">        Py_ssize_t nargs = PyTuple_GET_SIZE(args);</span><br><span class="line">        <span class="keyword">if</span> (nargs == <span class="number">1</span> &amp;&amp; (kwds == <span class="literal">NULL</span> || !PyDict_GET_SIZE(kwds))) &#123;</span><br><span class="line">            obj = (PyObject *) Py_TYPE(PyTuple_GET_ITEM(args, <span class="number">0</span>));</span><br><span class="line">            Py_INCREF(obj);</span><br><span class="line">            <span class="keyword">return</span> obj;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (nargs != <span class="number">3</span>) &#123;</span><br><span class="line">            PyErr_SetString(PyExc_TypeError,</span><br><span class="line">                            <span class="string">&quot;type() takes 1 or 3 arguments&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 1. 先调用 __new__ 函数</span></span><br><span class="line">    <span class="keyword">if</span> (type-&gt;tp_new == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        _PyErr_Format(tstate, PyExc_TypeError,</span><br><span class="line">                      <span class="string">&quot;cannot create &#x27;%s&#x27; instances&quot;</span>, type-&gt;tp_name);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    obj = type-&gt;tp_new(type, args, kwds);</span><br><span class="line">    obj = _Py_CheckFunctionResult(tstate, (PyObject*)type, obj, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 检查 __new__ 返回的对象类型是不是和传进来的类型一致</span></span><br><span class="line">    <span class="keyword">if</span> (!PyType_IsSubtype(Py_TYPE(obj), type))</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 一致才调用 __init__ 函数</span></span><br><span class="line">    type = Py_TYPE(obj);</span><br><span class="line">    <span class="keyword">if</span> (type-&gt;tp_init != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="type">int</span> res = type-&gt;tp_init(obj, args, kwds);</span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            Py_DECREF(obj);</span><br><span class="line">            obj = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这么看就简单多了，通过调用类型对象进行实例化，会先执行 <code>__new__</code> ，若返回的类型正确则继续调用 <code>__init__</code>。</p><h2 id="PyBaseObject"><a href="#PyBaseObject" class="headerlink" title="PyBaseObject"></a>PyBaseObject</h2><p>如果说 <code>PyTypeObject</code> 是万物的元类，那么 <code>PyBaseObject</code> 就是万物的父类。而父也是由造物主 <code>type</code> 创造出来的，它们两是一体，不可分割（因为 object 的类型 也是 type）。</p><p>整体上看非常普通，没什么特别的，主要是定义了一些最基础的方法，给子类用，比如比较之类的。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">PyDoc_STRVAR(object_doc,</span><br><span class="line"><span class="string">&quot;object()\n--\n\n&quot;</span></span><br><span class="line"><span class="string">&quot;The base class of the class hierarchy.\n\n&quot;</span></span><br><span class="line"><span class="string">&quot;When called, it accepts no arguments and returns a new featureless\n&quot;</span></span><br><span class="line"><span class="string">&quot;instance that has no instance attributes and cannot be given any.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">PyTypeObject PyBaseObject_Type = &#123;</span><br><span class="line">    PyVarObject_HEAD_INIT(&amp;PyType_Type, <span class="number">0</span>)</span><br><span class="line">    <span class="string">&quot;object&quot;</span>,                                   <span class="comment">/* tp_name */</span></span><br><span class="line">    <span class="keyword">sizeof</span>(PyObject),                           <span class="comment">/* tp_basicsize */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_itemsize */</span></span><br><span class="line">    object_dealloc,                             <span class="comment">/* tp_dealloc */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_vectorcall_offset */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_getattr */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_setattr */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_as_async */</span></span><br><span class="line">    object_repr,                                <span class="comment">/* tp_repr */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_as_number */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_as_sequence */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_as_mapping */</span></span><br><span class="line">    (hashfunc)_Py_HashPointer,                  <span class="comment">/* tp_hash */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_call */</span></span><br><span class="line">    object_str,                                 <span class="comment">/* tp_str */</span></span><br><span class="line">    PyObject_GenericGetAttr,                    <span class="comment">/* tp_getattro */</span></span><br><span class="line">    PyObject_GenericSetAttr,                    <span class="comment">/* tp_setattro */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_as_buffer */</span></span><br><span class="line">    Py_TPFLAGS_DEFAULT | Py_TPFLAGS_BASETYPE,   <span class="comment">/* tp_flags */</span></span><br><span class="line">    object_doc,                                 <span class="comment">/* tp_doc */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_traverse */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_clear */</span></span><br><span class="line">    object_richcompare,                         <span class="comment">/* tp_richcompare */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_weaklistoffset */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_iter */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_iternext */</span></span><br><span class="line">    object_methods,                             <span class="comment">/* tp_methods */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_members */</span></span><br><span class="line">    object_getsets,                             <span class="comment">/* tp_getset */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_base */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_dict */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_descr_get */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_descr_set */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_dictoffset */</span></span><br><span class="line">    object_init,                                <span class="comment">/* tp_init */</span></span><br><span class="line">    PyType_GenericAlloc,                        <span class="comment">/* tp_alloc */</span></span><br><span class="line">    object_new,                                 <span class="comment">/* tp_new */</span></span><br><span class="line">    PyObject_Del,                               <span class="comment">/* tp_free */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>现在不去关注这里面的内容，等到对其他的对象足够了解后，再回到 <code>type</code> 和 <code>object</code> 中剖析。这样做的好处是，自上而下阅读，不容易产生疑惑。</p><h2 id="PyFloatObject"><a href="#PyFloatObject" class="headerlink" title="PyFloatObject"></a>PyFloatObject</h2><p>终于到了本文的重点，<code>PyFloatObject</code> 是一个浮点数实例对象，我们就以它为起点，去窥探其中的设计。之所以选择它，是因为它是所有对象里面最简单的了。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可以看出是个定长对象，里面就只有一个 double</span></span><br><span class="line"><span class="comment">// (那铁定是定长啊，一个浮点变个啥啊</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    PyObject_HEAD</span><br><span class="line">    <span class="type">double</span> ob_fval;</span><br><span class="line">&#125; PyFloatObject;</span><br></pre></td></tr></table></figure><p><code>PyFloat_Type</code> 看命名就知道是浮点数的类型对象了。</p><p>里面的行为都比较简单，要注意的是没有 <code>__init__</code> ，因为浮点对象比较简单，可以在 <code>__new__</code> 的时候就填充好。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">PyTypeObject PyFloat_Type = &#123;</span><br><span class="line">    <span class="comment">// 设置类型为 type, 垃圾回收链表为空 因为是非动态生成的</span></span><br><span class="line">    PyVarObject_HEAD_INIT(&amp;PyType_Type, <span class="number">0</span>)</span><br><span class="line">    <span class="comment">// 该浮点类型对象的名称</span></span><br><span class="line">    <span class="string">&quot;float&quot;</span>,</span><br><span class="line">    <span class="comment">// 该类型对象的大小</span></span><br><span class="line">    <span class="keyword">sizeof</span>(PyFloatObject),</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="comment">// 可以理解为析构函数, 用于缓存浮点数</span></span><br><span class="line">    (destructor)float_dealloc,                  <span class="comment">/* tp_dealloc */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_vectorcall_offset */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_getattr */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_setattr */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_as_async */</span></span><br><span class="line">    <span class="comment">// 描述信息 机器看的 __repr__</span></span><br><span class="line">    (reprfunc)float_repr,                       <span class="comment">/* tp_repr */</span></span><br><span class="line">    <span class="comment">// 浮点数作为数字的一些操作</span></span><br><span class="line">    &amp;float_as_number,                           <span class="comment">/* tp_as_number */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_as_sequence */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_as_mapping */</span></span><br><span class="line">    <span class="comment">// 浮点哈希操作</span></span><br><span class="line">    (hashfunc)float_hash,                       <span class="comment">/* tp_hash */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_call */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_str */</span></span><br><span class="line">    <span class="comment">// 标准获取属性方法, 例如: float.__doc__</span></span><br><span class="line">    PyObject_GenericGetAttr,                    <span class="comment">/* tp_getattro */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_setattro */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_as_buffer */</span></span><br><span class="line">    <span class="comment">// 默认对象, 允许继承, </span></span><br><span class="line">    Py_TPFLAGS_DEFAULT | Py_TPFLAGS_BASETYPE |</span><br><span class="line">        _Py_TPFLAGS_MATCH_SELF,                 <span class="comment">/* tp_flags */</span></span><br><span class="line">    <span class="comment">// 文档</span></span><br><span class="line">    float_new__doc__,                           <span class="comment">/* tp_doc */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_traverse */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_clear */</span></span><br><span class="line">    <span class="comment">// 浮点数比较, 后面细说 是个地狱</span></span><br><span class="line">    float_richcompare,                          <span class="comment">/* tp_rixchcompare */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_weaklistoffset */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_iter */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_iternext */</span></span><br><span class="line">    <span class="comment">// 浮点数的方法</span></span><br><span class="line">    float_methods,                              <span class="comment">/* tp_methods */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_members */</span></span><br><span class="line">    float_getset,                               <span class="comment">/* tp_getset */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_base */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_dict */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_descr_get */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_descr_set */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_dictoffset */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_init */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_alloc */</span></span><br><span class="line">    <span class="comment">// 可以理解为构造函数</span></span><br><span class="line">    float_new,                                  <span class="comment">/* tp_new */</span></span><br><span class="line">    <span class="comment">// 可以理解为快速版构造函数 Python3.9后推出的</span></span><br><span class="line">    .tp_vectorcall = (vectorcallfunc)float_vectorcall,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>为了接下来阅读方便，我将 <code>floatobject.h</code> 的一部分宏作了注释贴上来。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 浮点数缓存池大小</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PyFloat_MAXFREELIST</span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> PyFloat_MAXFREELIST   100</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 浮点数类型判定, 包含浮点及其子类</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PyFloat_Check(op) PyObject_TypeCheck(op, &amp;PyFloat_Type)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 浮点数精确判定类型, 不包含子类</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PyFloat_CheckExact(op) Py_IS_TYPE(op, &amp;PyFloat_Type)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 不是一个数字</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> Py_NAN</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Py_RETURN_NAN return PyFloat_FromDouble(Py_NAN)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回无穷大or无穷小</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Py_RETURN_INF(sign) do                     \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (copysign(1., sign) == 1.) &#123;                \</span></span><br><span class="line"><span class="meta">        return PyFloat_FromDouble(Py_HUGE_VAL);    \</span></span><br><span class="line"><span class="meta">    &#125; <span class="keyword">else</span> &#123;                        \</span></span><br><span class="line"><span class="meta">        return PyFloat_FromDouble(-Py_HUGE_VAL);   \</span></span><br><span class="line"><span class="meta">    &#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将PyObject 转换为 C的浮点数, 宏以不检查类型, 提高效率</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> Py_LIMITED_API</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PyFloat_AS_DOUBLE(op) (((PyFloatObject *)(op))-&gt;ob_fval)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><h3 id="浮点数初始化"><a href="#浮点数初始化" class="headerlink" title="浮点数初始化"></a>浮点数初始化</h3><p>虚拟机在启动后，会进行浮点数的一些初始化，主要包含以下两个操作</p><ol><li>判断当前机器为 <code>ieee-754</code> 的大端还是小端编码。</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_PyFloat_Init(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// https://tooltt.com/ieee/</span></span><br><span class="line"><span class="comment">// 01000011 43</span></span><br><span class="line"><span class="comment">// 00111111 3f</span></span><br><span class="line"><span class="comment">// 11111111 ff</span></span><br><span class="line"><span class="comment">// 00000001 1</span></span><br><span class="line"><span class="comment">// 00000010 2</span></span><br><span class="line"><span class="comment">// 00000011 3</span></span><br><span class="line"><span class="comment">// 00000100 4</span></span><br><span class="line"><span class="comment">// 00000101 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SIZEOF_DOUBLE == 8</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 01000011 00111111 11111111 00000001 00000010 00000011 00000100 00000101</span></span><br><span class="line">        <span class="type">double</span> x = <span class="number">9006104071832581.0</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">memcmp</span>(&amp;x, <span class="string">&quot;\x43\x3f\xff\x01\x02\x03\x04\x05&quot;</span>, <span class="number">8</span>) == <span class="number">0</span>)</span><br><span class="line">            detected_double_format = ieee_big_endian_format;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">memcmp</span>(&amp;x, <span class="string">&quot;\x05\x04\x03\x02\x01\xff\x3f\x43&quot;</span>, <span class="number">8</span>) == <span class="number">0</span>)</span><br><span class="line">            detected_double_format = ieee_little_endian_format;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            detected_double_format = unknown_format;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    detected_double_format = unknown_format;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    ...</span><br><span class="line">    double_format = detected_double_format;</span><br><span class="line">    float_format = detected_float_format;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>填充 <code>float info</code> 数据。</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// floatinfo 浮点数一些信息</span></span><br><span class="line">PyDoc_STRVAR(floatinfo__doc__,</span><br><span class="line"><span class="string">&quot;sys.float_info\n\</span></span><br><span class="line"><span class="string">\n\</span></span><br><span class="line"><span class="string">A named tuple holding information about the float type. It contains low level\n\</span></span><br><span class="line"><span class="string">information about the precision and internal representation. Please study\n\</span></span><br><span class="line"><span class="string">your system&#x27;s :file:`float.h` for more information.&quot;</span>);</span><br><span class="line"><span class="type">static</span> PyStructSequence_Field floatinfo_fields[] = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;max&quot;</span>,             <span class="string">&quot;DBL_MAX -- maximum representable finite float&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;max_exp&quot;</span>,         <span class="string">&quot;DBL_MAX_EXP -- maximum int e such that radix**(e-1) &quot;</span></span><br><span class="line">                    <span class="string">&quot;is representable&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;max_10_exp&quot;</span>,      <span class="string">&quot;DBL_MAX_10_EXP -- maximum int e such that 10**e &quot;</span></span><br><span class="line">                    <span class="string">&quot;is representable&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;min&quot;</span>,             <span class="string">&quot;DBL_MIN -- Minimum positive normalized float&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;min_exp&quot;</span>,         <span class="string">&quot;DBL_MIN_EXP -- minimum int e such that radix**(e-1) &quot;</span></span><br><span class="line">                    <span class="string">&quot;is a normalized float&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;min_10_exp&quot;</span>,      <span class="string">&quot;DBL_MIN_10_EXP -- minimum int e such that 10**e is &quot;</span></span><br><span class="line">                    <span class="string">&quot;a normalized&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;dig&quot;</span>,             <span class="string">&quot;DBL_DIG -- maximum number of decimal digits that &quot;</span></span><br><span class="line">                    <span class="string">&quot;can be faithfully represented in a float&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;mant_dig&quot;</span>,        <span class="string">&quot;DBL_MANT_DIG -- mantissa digits&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;epsilon&quot;</span>,         <span class="string">&quot;DBL_EPSILON -- Difference between 1 and the next &quot;</span></span><br><span class="line">                    <span class="string">&quot;representable float&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;radix&quot;</span>,           <span class="string">&quot;FLT_RADIX -- radix of exponent&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;rounds&quot;</span>,          <span class="string">&quot;FLT_ROUNDS -- rounding mode used for arithmetic &quot;</span></span><br><span class="line">                    <span class="string">&quot;operations&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="number">0</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> PyStructSequence_Desc floatinfo_desc = &#123;</span><br><span class="line">    <span class="string">&quot;sys.float_info&quot;</span>,           <span class="comment">/* name */</span></span><br><span class="line">    floatinfo__doc__,           <span class="comment">/* doc */</span></span><br><span class="line">    floatinfo_fields,           <span class="comment">/* fields */</span></span><br><span class="line">    <span class="number">11</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line">_PyFloat_InitTypes(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Init float info */</span></span><br><span class="line">    <span class="comment">// 此处的 StructSequence 本质上是 tuple的包装</span></span><br><span class="line">    <span class="keyword">if</span> (FloatInfoType.tp_name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (PyStructSequence_InitType2(&amp;FloatInfoType, &amp;floatinfo_desc) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样就可以通过 <code>sys.float_info</code> 来查看当前环境的浮点数参数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.float_info</span><br><span class="line">sys.float_info(<span class="built_in">max</span>=<span class="number">1.7976931348623157e+308</span>, max_exp=<span class="number">1024</span>, max_10_exp=<span class="number">308</span>, <span class="built_in">min</span>=<span class="number">2.2250738585072014e-308</span>, min_exp=-<span class="number">1021</span>, min_10_exp=-<span class="number">307</span>, dig=<span class="number">15</span>, mant_dig=<span class="number">53</span>, epsilon=<span class="number">2.220446049250313e-16</span>, radix=<span class="number">2</span>, rounds=<span class="number">1</span>)</span><br></pre></td></tr></table></figure><h2 id="浮点数的创建与销毁"><a href="#浮点数的创建与销毁" class="headerlink" title="浮点数的创建与销毁"></a>浮点数的创建与销毁</h2><h3 id="浮点数创建"><a href="#浮点数创建" class="headerlink" title="浮点数创建"></a>浮点数创建</h3><p>浮点数创建主要在 <code>float_new_impl</code> 中。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> PyObject *</span><br><span class="line"><span class="title function_">float_new</span><span class="params">(PyTypeObject *type, PyObject *args, PyObject *kwargs)</span></span><br><span class="line">&#123;</span><br><span class="line">    PyObject *return_value = <span class="literal">NULL</span>;</span><br><span class="line">    PyObject *x = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((type == &amp;PyFloat_Type) &amp;&amp;</span><br><span class="line">        !_PyArg_NoKeywords(<span class="string">&quot;float&quot;</span>, kwargs)) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!_PyArg_CheckPositional(<span class="string">&quot;float&quot;</span>, PyTuple_GET_SIZE(args), <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (PyTuple_GET_SIZE(args) &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> skip_optional;</span><br><span class="line">    &#125;</span><br><span class="line">    x = PyTuple_GET_ITEM(args, <span class="number">0</span>);</span><br><span class="line">skip_optional:</span><br><span class="line">    return_value = float_new_impl(type, x);</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span>:</span><br><span class="line">    <span class="keyword">return</span> return_value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>判断类型是否为 <code>float_type</code>，不是则看看是否为 <code>float</code> 的子类，否则就尝试将字符串转为浮点数。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> PyObject *</span><br><span class="line"><span class="title function_">float_new_impl</span><span class="params">(PyTypeObject *type, PyObject *x)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (type != &amp;PyFloat_Type) &#123;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            x = _PyLong_GetZero();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> float_subtype_new(type, x); <span class="comment">/* Wimp out */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (x == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> PyFloat_FromDouble(<span class="number">0.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* If it&#x27;s a string, but not a string subclass, use</span></span><br><span class="line"><span class="comment">       PyFloat_FromString. */</span></span><br><span class="line">    <span class="keyword">if</span> (PyUnicode_CheckExact(x))</span><br><span class="line">        <span class="keyword">return</span> PyFloat_FromString(x);</span><br><span class="line">    <span class="keyword">return</span> PyNumber_Float(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重点关注 <code>PyFloat_FromDouble</code> ，可以看出，float 有个对象缓存链表，各个对象采用 <code>ob_type</code> 进行串联。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过C浮点数获取python 浮点对象, 注意虚拟机中有浮点缓存器。</span></span><br><span class="line">PyObject *</span><br><span class="line"><span class="title function_">PyFloat_FromDouble</span><span class="params">(<span class="type">double</span> fval)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 获取浮点缓存</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">Py_float_state</span> *<span class="title">state</span> =</span> get_float_state();</span><br><span class="line">    PyFloatObject *op = state-&gt;free_list;</span><br><span class="line">    <span class="keyword">if</span> (op != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 通过ob_type作为链表串联起缓存池中的浮点对象</span></span><br><span class="line">        state-&gt;free_list = (PyFloatObject *) Py_TYPE(op);</span><br><span class="line">        state-&gt;numfree--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        op = PyObject_Malloc(<span class="keyword">sizeof</span>(PyFloatObject));</span><br><span class="line">        <span class="keyword">if</span> (!op) &#123;</span><br><span class="line">            <span class="keyword">return</span> PyErr_NoMemory();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    _PyObject_Init((PyObject*)op, &amp;PyFloat_Type);</span><br><span class="line">    op-&gt;ob_fval = fval;</span><br><span class="line">    <span class="keyword">return</span> (PyObject *) op;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="float-vectorcall"><a href="#float-vectorcall" class="headerlink" title="float_vectorcall"></a>float_vectorcall</h4><p>除了 <code>float_new</code> 还有一个创建 浮点数的新方法 <code>float_vectorcall</code> ，内部也是调用的 <code>float_new_impl</code> ，用于提高性能，但是浮点数里面没有启用！因为它的 flag 没有 <code>Py_TPFLAGS_HAVE_VECTORCALL</code> ，可能只是暂时预留一个位置，还没有开发到，所以就先跳过吧</p><h3 id="浮点数销毁"><a href="#浮点数销毁" class="headerlink" title="浮点数销毁"></a>浮点数销毁</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 析构 确保一定是 PyFloat_Type 类型</span></span><br><span class="line"><span class="comment">// 链表长度100个</span></span><br><span class="line"><span class="comment">// 用 ob_type 做链表, 反正已知这条链上的对象都是PyFloat_Type</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">float_dealloc</span><span class="params">(PyFloatObject *op)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (PyFloat_CheckExact(op)) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">Py_float_state</span> *<span class="title">state</span> =</span> get_float_state();</span><br><span class="line">        <span class="keyword">if</span> (state-&gt;numfree &gt;= PyFloat_MAXFREELIST)  &#123;</span><br><span class="line">            PyObject_Free(op);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        state-&gt;numfree++;</span><br><span class="line">        Py_SET_TYPE(op, (PyTypeObject *)state-&gt;free_list);</span><br><span class="line">        state-&gt;free_list = op;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        Py_TYPE(op)-&gt;tp_free((PyObject *)op);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如何验证浮点数是不是真的用到了缓存池？有个很简单的方法验证。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = <span class="number">1.3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">id</span>(a)</span><br><span class="line"><span class="number">4500913328</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> a</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = <span class="number">1.3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">id</span>(b)</span><br><span class="line"><span class="number">4500913328</span></span><br></pre></td></tr></table></figure><p>a 与 b 的 id 一致 说明复用了浮点数对象。</p><h2 id="浮点数操作"><a href="#浮点数操作" class="headerlink" title="浮点数操作"></a>浮点数操作</h2><p>浮点数的大部分操作都比较简单，唯独比较操作是一个非常麻烦的操作。</p><h3 id="浮点数比较"><a href="#浮点数比较" class="headerlink" title="浮点数比较"></a>浮点数比较</h3><p>作者也曾提到，浮点数比较是一个噩梦，之所以这么麻烦，主要是当浮点数和整数比较时，将浮点数转换为整数去比较会丢失精度，用整数转换为浮点数也不可行，因为一个整数的有效位高达63位，而双精度浮点数的有效位为53位，无法直接进行比较。</p><p>大致步骤如下：</p><ol><li>如果 j 为浮点数 且 无穷，则可直接判定。</li><li>如果 j 为整数 则检查符号，符号不同也可直接判定。</li><li>j 为整数且符号相同，判定是否可以转换为浮点数(通过计算 整数的比特位，只要不超过48位，就可直接转换为浮点数)，后直接判定。</li><li>若j为负数，转换为整数，计算 i 的指数，指数小于 j 的位数，则可直接判定(因为指数也可以看作是位数)。</li><li>j为整数，分离 i 这个浮点数的小数与整数部分，如果小数部分存在，则将 i 左移后异或上 1，保留精度后与j左移一位进行判定即可。</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> PyObject*</span><br><span class="line"><span class="title function_">float_richcompare</span><span class="params">(PyObject *v, PyObject *w, <span class="type">int</span> op)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">double</span> i, j;</span><br><span class="line">    <span class="type">int</span> r = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    assert(PyFloat_Check(v));</span><br><span class="line">    i = PyFloat_AS_DOUBLE(v);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (PyFloat_Check(w))</span><br><span class="line">        j = PyFloat_AS_DOUBLE(w);</span><br><span class="line">    <span class="comment">// 不是有限代表 i是无穷 所以 j无论是个啥都行...</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!Py_IS_FINITE(i)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (PyLong_Check(w))</span><br><span class="line">            j = <span class="number">0.0</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">goto</span> Unimplemented;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// j是个整数 很麻烦</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (PyLong_Check(w)) &#123;</span><br><span class="line">        <span class="comment">// 检查符号</span></span><br><span class="line">        <span class="type">int</span> vsign = i == <span class="number">0.0</span> ? <span class="number">0</span> : i &lt; <span class="number">0.0</span> ? <span class="number">-1</span> : <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> wsign = _PyLong_Sign(w);</span><br><span class="line">        <span class="type">size_t</span> nbits;</span><br><span class="line">        <span class="type">int</span> exponent;</span><br><span class="line">        <span class="comment">// 符号不等可以简单判断, 因为大小无关紧要了</span></span><br><span class="line">        <span class="keyword">if</span> (vsign != wsign) &#123;</span><br><span class="line">            i = (<span class="type">double</span>)vsign;</span><br><span class="line">            j = (<span class="type">double</span>)wsign;</span><br><span class="line">            <span class="keyword">goto</span> Compare;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果符号相同 尝试将j转换为浮点数，特别是0最为合适</span></span><br><span class="line">        <span class="comment">// 那么什么时候才是合适的呢？ 那就是这个整数w的比特位合适。。</span></span><br><span class="line">        nbits = _PyLong_NumBits(w);</span><br><span class="line">        <span class="keyword">if</span> (nbits == (<span class="type">size_t</span>)<span class="number">-1</span> &amp;&amp; PyErr_Occurred()) &#123;</span><br><span class="line">            PyErr_Clear();</span><br><span class="line">            i = (<span class="type">double</span>)vsign;</span><br><span class="line">            assert(wsign != <span class="number">0</span>);</span><br><span class="line">            j = wsign * <span class="number">2.0</span>;</span><br><span class="line">            <span class="keyword">goto</span> Compare;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 指数符加尾数占48位，指数符加指数占16位 所以48位铁定不会出问题</span></span><br><span class="line">        <span class="keyword">if</span> (nbits &lt;= <span class="number">48</span>) &#123;</span><br><span class="line">            j = PyLong_AsDouble(w);</span><br><span class="line"></span><br><span class="line">            assert(j != <span class="number">-1.0</span> || ! PyErr_Occurred());</span><br><span class="line">            <span class="keyword">goto</span> Compare;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (vsign &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            i = -i;</span><br><span class="line">            op = _Py_SwappedOp[op];</span><br><span class="line">        &#125;</span><br><span class="line">        assert(i &gt; <span class="number">0.0</span>);</span><br><span class="line">        (<span class="type">void</span>) <span class="built_in">frexp</span>(i, &amp;exponent); <span class="comment">// i=returnvalue * 2^exponent</span></span><br><span class="line">        <span class="comment">// 通过指数来比较大小很骚</span></span><br><span class="line">        <span class="keyword">if</span> (exponent &lt; <span class="number">0</span> || (<span class="type">size_t</span>)exponent &lt; nbits) &#123;</span><br><span class="line">            i = <span class="number">1.0</span>;</span><br><span class="line">            j = <span class="number">2.0</span>;</span><br><span class="line">            <span class="keyword">goto</span> Compare;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="type">size_t</span>)exponent &gt; nbits) &#123;</span><br><span class="line">            i = <span class="number">2.0</span>;</span><br><span class="line">            j = <span class="number">1.0</span>;</span><br><span class="line">            <span class="keyword">goto</span> Compare;</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">double</span> fracpart;</span><br><span class="line">            <span class="type">double</span> intpart;</span><br><span class="line">            PyObject *result = <span class="literal">NULL</span>;</span><br><span class="line">            PyObject *vv = <span class="literal">NULL</span>;</span><br><span class="line">            PyObject *ww = w;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (wsign &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                ww = PyNumber_Negative(w);</span><br><span class="line">                <span class="keyword">if</span> (ww == <span class="literal">NULL</span>)</span><br><span class="line">                    <span class="keyword">goto</span> Error;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                Py_INCREF(ww);</span><br><span class="line"></span><br><span class="line">            fracpart = <span class="built_in">modf</span>(i, &amp;intpart);</span><br><span class="line">            vv = PyLong_FromDouble(intpart);</span><br><span class="line">            <span class="keyword">if</span> (vv == <span class="literal">NULL</span>)</span><br><span class="line">                <span class="keyword">goto</span> Error;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fracpart != <span class="number">0.0</span>) &#123;</span><br><span class="line">                PyObject *temp;</span><br><span class="line"></span><br><span class="line">                temp = _PyLong_Lshift(ww, <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (temp == <span class="literal">NULL</span>)</span><br><span class="line">                    <span class="keyword">goto</span> Error;</span><br><span class="line">                Py_DECREF(ww);</span><br><span class="line">                ww = temp;</span><br><span class="line"></span><br><span class="line">                temp = _PyLong_Lshift(vv, <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (temp == <span class="literal">NULL</span>)</span><br><span class="line">                    <span class="keyword">goto</span> Error;</span><br><span class="line">                Py_DECREF(vv);</span><br><span class="line">                vv = temp;</span><br><span class="line"></span><br><span class="line">                temp = PyNumber_Or(vv, _PyLong_GetOne());</span><br><span class="line">                <span class="keyword">if</span> (temp == <span class="literal">NULL</span>)</span><br><span class="line">                    <span class="keyword">goto</span> Error;</span><br><span class="line">                Py_DECREF(vv);</span><br><span class="line">                vv = temp;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            r = PyObject_RichCompareBool(vv, ww, op);</span><br><span class="line">            <span class="keyword">if</span> (r &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> Error;</span><br><span class="line">            result = PyBool_FromLong(r);</span><br><span class="line">         Error:</span><br><span class="line">            Py_XDECREF(vv);</span><br><span class="line">            Py_XDECREF(ww);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="comment">/* else if (PyLong_Check(w)) */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>        <span class="comment">/* w isn&#x27;t float or int */</span></span><br><span class="line">        <span class="keyword">goto</span> Unimplemented;</span><br><span class="line"></span><br><span class="line"> Compare:</span><br><span class="line">    <span class="keyword">switch</span> (op) &#123;</span><br><span class="line">    <span class="keyword">case</span> Py_EQ:</span><br><span class="line">        r = i == j;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Py_NE:</span><br><span class="line">        r = i != j;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Py_LE:</span><br><span class="line">        r = i &lt;= j;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Py_GE:</span><br><span class="line">        r = i &gt;= j;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Py_LT:</span><br><span class="line">        r = i &lt; j;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Py_GT:</span><br><span class="line">        r = i &gt; j;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> PyBool_FromLong(r);</span><br><span class="line"></span><br><span class="line"> Unimplemented:</span><br><span class="line">    Py_RETURN_NOTIMPLEMENTED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看完这一段我就有疑惑了，我记得 <code>Lua</code> 实现浮点数比较非常简单啊。翻阅 <code>Lua 5.3.6</code> 源码进行查阅得知，<code>Lua</code> 直接将两个浮点数转换为整数进行比较，这样会有精度丢失的问题(将浮点直接向下取整取到整数)。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">luaV_equalobj</span> <span class="params">(lua_State *L, <span class="type">const</span> TValue *t1, <span class="type">const</span> TValue *t2)</span> &#123;</span><br><span class="line">  <span class="type">const</span> TValue *tm;</span><br><span class="line">  <span class="keyword">if</span> (ttype(t1) != ttype(t2)) &#123;  <span class="comment">/* not the same variant? */</span></span><br><span class="line">    <span class="keyword">if</span> (ttnov(t1) != ttnov(t2) || ttnov(t1) != LUA_TNUMBER)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">/* only numbers can be equal with different variants */</span></span><br><span class="line">    <span class="keyword">else</span> &#123;  <span class="comment">/* two numbers with different variants */</span></span><br><span class="line">      lua_Integer i1, i2;  <span class="comment">/* compare them as integers */</span></span><br><span class="line">      <span class="keyword">return</span> (tointeger(t1, &amp;i1) &amp;&amp; tointeger(t2, &amp;i2) &amp;&amp; i1 == i2);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="copysign"><a href="#copysign" class="headerlink" title="copysign"></a>copysign</h3><p>copysign 是 <code>ieee-754</code> 中关于浮点数定义的一个辅助函数，用于确定一个浮点数的符号，在 <code>Python</code> 中为了支持符号0，实现了这个方法。</p><p>这个函数使用方法是 将 y 的符号赋给 x 并返回。<br>实现方式也挺巧妙的，利用 <code>atan2(0, -1.)</code> 会得到一个 -PI 的结果，如果机器支持-0，则为-PI，若不支持则为 +PI，以此来确定机器是否支持符号0。</p><p><img data-src="/images/python3-float-atan2.jpg" alt="python3-float-atan2"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">double</span></span><br><span class="line"><span class="title function_">copysign</span><span class="params">(<span class="type">double</span> x, <span class="type">double</span> y)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* use atan2 to distinguish -0. from 0. */</span></span><br><span class="line">    <span class="keyword">if</span> (y &gt; <span class="number">0.</span> || (y == <span class="number">0.</span> &amp;&amp; <span class="built_in">atan2</span>(y, <span class="number">-1.</span>) &gt; <span class="number">0.</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">fabs</span>(x);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="built_in">fabs</span>(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本篇剖析了 <code>Python3.10</code> 的 <code>float</code> 对象的内部结构与实现，对比 <code>Lua</code> 可知其优势。</p><ol><li>拥有浮点数缓存池。</li><li>比较函数实现更为靠谱。</li><li>考虑到机器是否支持符号0，通过 <code>copysign</code> 实现。</li></ol></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Python/" rel="tag"># Python</a> <a href="/tags/CPython/" rel="tag"># CPython</a> <a href="/tags/Python%E8%99%9A%E6%8B%9F%E6%9C%BA/" rel="tag"># Python虚拟机</a> <a href="/tags/float/" rel="tag"># float</a></div><div class="post-nav"><div class="post-nav-item"><a href="/LuaJIT-5.3.6/" rel="prev" title="LuaJIT 5.3.6 方案"><i class="fa fa-angle-left"></i> LuaJIT 5.3.6 方案</a></div><div class="post-nav-item"><a href="/Python3-%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90(%E4%BA%8C)-%E6%8C%87%E4%BB%A4%E7%89%B9%E5%8C%96/" rel="next" title="Python3-源码剖析(二)-指令特化">Python3-源码剖析(二)-指令特化 <i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Yuerer</span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><div class="reading-progress-bar"></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://unpkg.com/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://unpkg.com/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/comments.min.js"></script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/utils.min.js"></script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/motion.min.js"></script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/sidebar.min.js"></script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.21.1/next-boot.min.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://yuerer-comment-xufei-0bea01e6f05-1307930306.ap-shanghai.app.tcloudbase.com","cssUrl":"https://s4.zstatic.net/ajax/libs/waline/2.15.8/waline.css","commentCount":true,"pageview":true,"libUrl":"https://s4.zstatic.net/ajax/libs/waline/2.15.8/waline.js","locale":{"placeholder":"有何高见？"},"emoji":["https://unpkg.com/@waline/emojis@1.0.1/qq"],"meta":["nick","mail"],"requiredMeta":[["nick","mail"]],"wordLimit":0,"login":"disable","pageSize":10,"el":"#waline","comment":true,"path":"/Python3-%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90(%E4%B8%80)-float%E8%AF%9E%E7%94%9F/"}</script><link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/waline/2.15.8/waline.css"><script>document.addEventListener("page:loaded",()=>{NexT.utils.loadComments(CONFIG.waline.el).then(()=>NexT.utils.getScript(CONFIG.waline.libUrl,{condition:window.Waline})).then(()=>Waline.init(Object.assign({},CONFIG.waline,{el:document.querySelector(CONFIG.waline.el)})))})</script></body></html>